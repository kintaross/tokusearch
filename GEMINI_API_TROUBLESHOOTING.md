# Gemini API クォータ超過エラー - 解決ガイド

**エラーメッセージ**: "The service is receiving too many requests from you"

---

## 🔍 エラーの原因

### 原因1: 実験版モデルの制限
`gemini-2.0-flash-exp` は実験版で、無料枠の制限が厳しい可能性があります。

### 原因2: 無料枠の超過
1日の無料枠（25リクエスト）を超えている可能性があります。

### 原因3: APIキーの設定問題
APIキーが正しく設定されていない、または有効化されていない可能性があります。

---

## ✅ 解決策

### 解決策1: 安定版モデルに変更（最も推奨）

**n8nワークフローで変更**:

1. **「Gemini記事生成」ノードを開く**

2. **Model IDを変更**:
   ```
   変更前: models/gemini-2.0-flash-exp
   変更後: models/gemini-1.5-flash
   ```

3. **推奨モデル**:
   - ✅ `gemini-1.5-flash` - 高速、安定、無料枠対応
   - ✅ `gemini-1.5-pro` - 高品質、無料枠対応
   - ⚠️ `gemini-2.0-flash-exp` - 実験版、制限あり

4. **保存して再実行**

---

### 解決策2: APIキーの確認・再生成

#### ステップ1: Google AI Studioで確認

1. **Google AI Studioにアクセス**:
   - https://aistudio.google.com/app/apikey

2. **APIキーの状態を確認**:
   - ✅ 有効化されているか
   - ✅ クォータが残っているか
   - ✅ 正しいプロジェクトに紐付いているか

3. **必要に応じて新しいAPIキーを作成**:
   ```
   Create API Key → プロジェクトを選択 → コピー
   ```

#### ステップ2: n8nで認証情報を更新

1. **n8nで「Credentials」を開く**

2. **「Google Gemini(PaLM) Api account」を編集**

3. **新しいAPIキーを貼り付け**

4. **保存**

---

### 解決策3: レート制限の対応

#### オプション1: 実行頻度を下げる

**スケジュールトリガーを変更**:

```javascript
// 変更前: 毎日9時
Cron: 0 9 * * *

// 変更後: 週3回（月・水・金の9時）
Cron: 0 9 * * 1,3,5
```

**設定方法**:
1. 「毎日9時トリガー」ノードを開く
2. Cron Expressionを変更
3. 保存

#### オプション2: Wait/Delayノードを追加

複数のノードで連続してAPIを呼び出す場合、間隔を空けます:

1. **Waitノードを追加** (オプション):
   - 「Gemini記事生成」と「Gemini画像生成」の間に配置
   - Wait Time: 5秒

---

### 解決策4: 無料枠の使用状況を確認

#### Google Cloud Consoleで確認

1. **Google Cloud Consoleにアクセス**:
   - https://console.cloud.google.com/

2. **「APIs & Services」→「Dashboard」**

3. **「Generative Language API」を選択**

4. **「Quotas」タブで使用状況を確認**:
   ```
   日次クォータ: 25リクエスト/日
   分次クォータ: 2リクエスト/分
   ```

5. **使用量が上限に達している場合**:
   - 翌日まで待つ
   - または、有料プランにアップグレード

---

### 解決策5: 代替APIの使用（緊急時）

#### Gemini画像生成を一時的にスキップ

画像生成でエラーが発生する場合、デフォルト画像を使用します。

**「画像生成プロンプト作成」ノードの後にIFノードを追加**:

```javascript
// IF条件分岐ノード
条件: {{$json.error}} が存在する

// Trueブランチ（エラー時）:
デフォルト画像URLを設定:
{
  thumbnailUrl: 'https://tokusearch.vercel.app/default-column-thumbnail.png'
}

// Falseブランチ（正常時）:
Gemini画像生成ノードへ
```

---

## 🎯 推奨設定（安定運用）

### 最適な設定

```
1. モデル: gemini-1.5-flash（安定版）
2. 実行頻度: 1日1回（午前9時）
3. 記事数: 1記事/日
4. レート制限: Wait 5秒（オプション）
```

### 無料枠内での運用

```
無料枠: 25リクエスト/日
使用量: 
  - 記事生成: 1リクエスト/日
  - 画像生成: 1リクエスト/日（別API）
  
合計: 2リクエスト/日 → 月60リクエスト

余裕: 23リクエスト/日（緊急時やテスト用）
```

---

## 📊 モデル比較

| モデル | 速度 | 品質 | 無料枠 | 推奨度 |
|--------|------|------|--------|--------|
| gemini-1.5-flash | ⚡⚡⚡ | ⭐⭐⭐ | ✅ 25/日 | ⭐⭐⭐⭐⭐ |
| gemini-1.5-pro | ⚡⚡ | ⭐⭐⭐⭐⭐ | ✅ 2/日 | ⭐⭐⭐⭐ |
| gemini-2.0-flash-exp | ⚡⚡⚡ | ⭐⭐⭐⭐ | ⚠️ 制限あり | ⭐⭐ |

**結論**: `gemini-1.5-flash` が最もバランスが良く、推奨です。

---

## 🔄 ワークフロー修正手順（完全版）

### ステップ1: モデルを変更

1. **n8nでワークフローを開く**

2. **「Gemini記事生成」ノードをクリック**

3. **Model IDを選択**:
   - ドロップダウンから `models/gemini-1.5-flash` を選択

4. **保存**

### ステップ2: APIキーを確認

1. **Google AI Studioでクォータを確認**:
   - https://aistudio.google.com/app/apikey

2. **必要に応じてAPIキーを再生成**

3. **n8nの認証情報を更新**

### ステップ3: テスト実行

1. **「毎日9時トリガー」ノードを右クリック**

2. **「Execute Node」をクリック**

3. **エラーがないことを確認**

4. **成功したらスケジュールを有効化**

---

## 🆘 それでも解決しない場合

### チェックリスト

- [ ] モデルを `gemini-1.5-flash` に変更した
- [ ] APIキーが有効である
- [ ] Google Cloud Consoleで「Generative Language API」が有効化されている
- [ ] 無料枠が残っている（25リクエスト/日）
- [ ] 認証情報がn8nで正しく設定されている
- [ ] 24時間以内に25回以上実行していない

### デバッグ方法

#### 1. Gemini APIを直接テスト

Google AI Studioで直接テスト:
- https://aistudio.google.com/

プロンプトを入力して、APIが動作するか確認してください。

#### 2. n8nのログを確認

```
ワークフロー → Executions タブ → 失敗した実行を選択
→ 各ノードのエラーメッセージを確認
```

#### 3. APIキーの権限を確認

Google Cloud Console:
```
IAM & Admin → Service Accounts
→ 該当するサービスアカウントの権限を確認
```

---

## 💰 有料プランへのアップグレード（オプション）

無料枠では不足する場合、有料プランを検討してください。

### Gemini API価格（2024年11月時点）

| モデル | 入力 | 出力 |
|--------|------|------|
| gemini-1.5-flash | $0.075/100万トークン | $0.30/100万トークン |
| gemini-1.5-pro | $1.25/100万トークン | $5.00/100万トークン |

**月間コスト見積もり**（1日1記事）:
```
記事生成: 
  - 入力: 500トークン × 30日 = 15,000トークン
  - 出力: 3000トークン × 30日 = 90,000トークン
  - コスト: 約$0.03/月

合計: 約$0.05/月（ほぼ無料）
```

---

## 📝 まとめ

### 即座に試すべきこと

1. ✅ **モデルを `gemini-1.5-flash` に変更**
2. ✅ **APIキーを確認・再生成**
3. ✅ **24時間待ってから再実行**

### 長期的な対策

1. ✅ **実行頻度を調整**（1日1回）
2. ✅ **エラーハンドリングを追加**（IF分岐）
3. ✅ **モニタリングを設定**（Slack通知）

---

**作成者**: TokuSearch開発チーム  
**最終更新**: 2025-11-27



