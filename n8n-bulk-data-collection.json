{
  "name": "ã€ä¸€æ™‚ã€‘TokuSearchå¤§é‡ãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆç›´è¿‘1ãƒ¶æœˆï¼‰",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ç›´è¿‘1ãƒ¶æœˆã®æ—¥ä»˜ç¯„å›²ã‚’ç”Ÿæˆ\nconst now = new Date();\nconst oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\nconst formatDate = (date) => date.toISOString().slice(0, 10);\nconst startDate = formatDate(oneMonthAgo);\nconst endDate = formatDate(now);\n\nconsole.log(`ğŸ“… åé›†æœŸé–“: ${startDate} ã€œ ${endDate}`);\n\n// ãƒ‡ãƒ¼ã‚¿åé›†ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ”¹å–„ç‰ˆï¼‰\nconst prompt = `\n${startDate}ã€œ${endDate} ã®æœŸé–“ã«X(Twitter)ã§æŠ•ç¨¿ã•ã‚ŒãŸã€ŒãŠå¾—æƒ…å ±ã€ã‚’åé›†ã—ã€ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚\n\n**é‡è¦**: å‡ºåŠ›ã¯ç´”ç²‹ãªJSONã®ã¿ã€‚ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹(\\`\\`\\`)ã‚„èª¬æ˜æ–‡ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚\n\n[\n{\n\"date\": \"YYYY-MM-DD\",\n\"tweet_created_at\": \"YYYY-MM-DDTHH:mm:ss.sssZ\",\n\"title\": \"ãŠå¾—æƒ…å ±ã®è¦‹å‡ºã—\",\n\"summary\": \"çŸ­ã„è¦ç´„ï¼ˆæœ¬æ–‡ã‚’å‡ç¸®ï¼‰\",\n\"detail\": \"å‰²å¼•ãƒ»é‚„å…ƒã®å…·ä½“å†…å®¹ï¼ˆç‡/é¡ãƒ»ä¸Šé™ãƒ»å¯¾è±¡ï¼‰\",\n\"steps\": \"åˆ©ç”¨/ç”³è¾¼ã®æ‰‹é †ï¼ˆã‚¢ãƒ—ãƒªãƒ»ã‚¯ãƒ¼ãƒãƒ³ãƒ»æ™‚é–“å¸¯ãªã©ï¼‰\",\n\"service\": \"å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ãƒ»åº—èˆ—å\",\n\"url\": \"https://x.com/.../status/...\",\n\"source_name\": \"å‡ºå…¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå\",\n\"source_id\": \"@handle\",\n\"expiration\": \"YYYY-MM-DD ã‚‚ã—ãã¯ æœŸé–“ã®èª¬æ˜æ–‡ (çµ‚äº†æ¸ˆã¿ã¯null)\",\n\"conditions\": \"æ–°è¦/æ—¢å­˜/å…ˆç€/æŠ½é¸/å›æ•°ãªã©\",\n\"notes\": \"æ³¨æ„ç‚¹ãƒ»ä¾‹å¤–ãƒ»å‚™è€ƒ\"\n}\n]\n\n# åé›†ãƒ«ãƒ¼ãƒ«\n- tweet_created_atã«ã¯ã€ãƒ„ã‚¤ãƒ¼ãƒˆãŒæŠ•ç¨¿ã•ã‚ŒãŸæ—¥æ™‚ã‚’ISO 8601å½¢å¼ã§å–å¾—ã—ã¦ãã ã•ã„ï¼ˆä¾‹: \"2025-11-21T02:17:21.752Z\"ï¼‰\n- ç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å„ªå…ˆã—ã¤ã¤ã€é¡ä¼¼ç³»çµ±ã®ä¿¡é ¼ã§ãã‚‹ã‚‚ã®ã‚‚å«ã‚ã‚‹ (ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼500ä»¥ä¸Š)\n- è¨€ã„å›ã—ãŒé•ã£ã¦ã‚‚ã€Œå†…å®¹ãŒåŒã˜ã€ãªã‚‰çµ±åˆã—1ä»¶ã«ã¾ã¨ã‚ã‚‹\n- ä»¥ä¸‹ã®ã„ãšã‚Œã‹ãŒç•°ãªã‚‹å ´åˆã¯åˆ¥ä»¶ã¨ã™ã‚‹ï¼š\n  - å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹/åº—èˆ—\n  - å‰²å¼•/é‚„å…ƒã®ç‡ãƒ»ä¸Šé™ãƒ»æœŸé–“\n  - åˆ©ç”¨/ç”³è¾¼æ‰‹é †ï¼ˆæ”¯æ‰•ã„æ‰‹æ®µãƒ»æ¡ä»¶ã®å·®ï¼‰\n- æ•°å€¤ã¯åŠè§’çµ±ä¸€ï¼ˆä¾‹: 20%, 1000å††, ä¸Šé™1000ãƒã‚¤ãƒ³ãƒˆï¼‰\n- æ¬ æã¯ null ã‚’å…¥ã‚Œã‚‹ï¼ˆç©ºæ–‡å­— \"\" ã¯ä½¿ã‚ãªã„ï¼‰\n- åŒæ§˜ã®æƒ…å ±ãŒè¤‡æ•°ã‚ã£ãŸå ´åˆã¯ã€ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ãŒä¸€ç•ªå¤šã„å†…å®¹ã®urlã‚’æŒ¿å…¥ã™ã‚‹\n- çµ‚äº†ã—ãŸã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã¯é™¤å¤– (expirationãŒéå»ã®æ—¥ä»˜ã€ã¾ãŸã¯ã€Œçµ‚äº†ã€ã€Œçµ‚äº†é–“è¿‘ã€ã€Œä»Šæ—¥ã§çµ‚ã‚ã‚Šã€å«ã‚€ã‚‚ã®ã¯null)\n- é«˜é¡é‚„å…ƒ/å‰²å¼• (10%ä»¥ä¸Šã€1000å††ä»¥ä¸Š) ã‚’å„ªå…ˆ\n- ä¿¡é ¼æ€§ä½ã„ã‚‚ã® (ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼50æœªæº€) ã¯é™¤å¤–\n- æŠ½é¸ã§å½“é¸ç‡ãŒä½ã„ã‚‚ã®ï¼ˆå½“é¸è€…10000åä»¥ä¸‹ï¼‰ã¯é™¤å¤–\n- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚©ãƒ­ãƒ¼ã‚„ãƒªãƒã‚¹ãƒˆã‚’æ¡ä»¶ã¨ã™ã‚‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã¯é™¤å¤–\n- æŠ•è³‡é–¢é€£ï¼ˆæ ªã€æš—å·è³‡ç”£ã€ãƒˆãƒ¬ãƒ¼ãƒ‰ãªã©ï¼‰ã¯é™¤å¤–\n- é‡è¤‡å†…å®¹ã¯çµ±åˆã—ã€1ä»¶ã«ã¾ã¨ã‚ã‚‹\n- **TikTokã«é–¢ã™ã‚‹å†…å®¹ã¯é™¤å¤–**\n- ä¸Šå ´ä¼æ¥­ã®å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã¯é™¤å¤–ï¼ˆå€‹äººã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ãƒ¬ãƒ™ãƒ«ã®æƒ…å ±ãŒã»ã—ã„ï¼‰\n- â—¯â—¯ã‚’è²·ã†ã¨1å€‹ç„¡æ–™ãªã©ã®ã€ã„ã‚ã‚†ã‚‹ã€Œãƒ—ãƒ©ã‚¤ãƒã€ã¯é™¤å¤–\n\n# å„ªå…ˆç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ\nã“ã¨ã¯ã‚€ã€ãŠå¾—Ã—ãƒã‚¤æ´»ã€‘ @kotoham_pkt\nã‚¯ãƒ¼ãƒãƒ¡ @tosu5580\nã‹ã‚Šã‚“@åŒ»ç™‚è„±æ¯›ãƒãƒ‹ã‚¢ @buran_umeda\nãŸã£ãã‚“ @9kuIOQMh1T85626\nã‚ã‚“ã“ @an89no23\nã¡ã³ã†ã•ğŸ°@ç„¡çµ¦å…ãƒ–ãƒ­ã‚¬ãƒ¼ @chibiusachi\nã‚ãã³@ã‚ãã³ã‚¸ãƒ£ãƒ‘ãƒ³ @akubichan_sab\nã‚ãã³@è‚²å…ã®åˆé–“ã«å‰¯æ¥­ã‚ã‚Œã“ã‚Œ @akubichan62124\nã‚ã®ã²ã¨@ä¸‡åšVIP CARDä¿æœ‰æ¸ˆ @2akautebon\nHalohaloï½œæ—…è¡Œãƒ¬ã‚¸ãƒ£ãƒ¼æƒ…å ± @halohalo_travel\nã¨ã‚‚ã‚ŠPay @tomor1nn\nãƒãƒãƒ¼ã®çŠ¬ğŸ• @ourmoneybook\nmao (ã¾ãŠ)@ãƒã‚¤æ´»ã§å®¶ã‚’è²·ã£ãŸä¸»å©¦ @mao_otk_tw\nã‚ãã½ã‚“ @akipon229\nãƒ–ãƒ«ã‚¾ãƒ³@ãŠå¾—å¥½ã @BuruzonBBA\nakiko_lawson @akiko_lawson\nvtcosmetics_jp @vtcosmetics_jp\nTraicyï¼ˆãƒˆãƒ©ã‚¤ã‚·ãƒ¼ï¼‰ @traicycom\n\n# è¿½åŠ æ¤œç´¢ãƒ«ãƒ¼ãƒ«\n- ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã§é¡ä¼¼æƒ…å ±ã‚’è£œå®Œ: \"ãŠå¾—æƒ…å ± ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ å‰²å¼• ã‚¯ãƒ¼ãƒãƒ³ ãƒã‚¤ãƒ³ãƒˆ é‚„å…ƒ MNP povo UQ JAL ANA ã‚½ãƒ©ã‚·ãƒ‰ ã‚¦ã‚¨ãƒ«æ´» ãƒãƒ³æ´» ãƒ‰ãƒªãƒã‚± Vãƒã‚¤ãƒ³ãƒˆ PayPay\"\n- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã§æ–°é®®æƒ…å ±: \"(ãŠå¾— OR ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ OR å‰²å¼• OR ã‚¯ãƒ¼ãƒãƒ³ OR ãƒã‚¤ãƒ³ãƒˆ OR é‚„å…ƒ OR JAL OR ANA OR ã‚¸ã‚§ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ OR ã‚½ãƒ©ã‚·ãƒ‰ OR ã‚¦ã‚¨ãƒ«æ´» OR ãƒãƒ³æ´» OR ãƒ‰ãƒªãƒã‚± OR MNP OR PayPay OR Vãƒã‚¤ãƒ³ãƒˆ) min_faves:5 since:${startDate} -TikTok -çµ‚äº† -çµ‚ã‚ã‚Š -æŠ•è³‡ -æ ª -æš—å·è³‡ç”£ -ãƒˆãƒ¬ãƒ¼ãƒ‰\" limit:100\n`.trim();\n\nreturn [{ json: { prompt, startDate, endDate } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        300
      ],
      "id": "generate-prompt-bulk",
      "name": "GeneratePromptBulk"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.x.ai/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "xAiApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "grok-2-latest"
            },
            {
              "name": "search_parameters",
              "value": "={{ {   \"mode\": \"auto\",   \"from_date\": $json.startDate,   \"to_date\": $json.endDate,   \"max_search_results\": 100,   \"sources\": [{ \"type\": \"x\", \"post_favorite_count\": 5 }] } }}"
            },
            {
              "name": "messages",
              "value": "={{ [{ \"role\": \"user\", \"content\": $json.prompt }] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        480,
        300
      ],
      "id": "call-grok-bulk",
      "name": "CallGrokBulk",
      "credentials": {
        "xAiApi": {
          "id": "m3OLs9FipQlOJmOA",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Grokã‹ã‚‰è¿”ã£ã¦ããŸJSONæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹\ntry {\n  const response = $json.choices[0].message.content;\n  console.log(`ğŸ“¦ Grokå¿œç­”ã‚µã‚¤ã‚º: ${response.length}æ–‡å­—`);\n  \n  const items = JSON.parse(response);\n  console.log(`ğŸ“Š ãƒ‘ãƒ¼ã‚¹æˆåŠŸ: ${items.length}ä»¶`);\n  \n  return items.map(item => ({ json: item }));\n} catch (err) {\n  console.error(`âŒ ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${err.message}`);\n  return [{ json: { error: true, message: err.message } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        300
      ],
      "id": "parse-grok-bulk",
      "name": "ParseGrokBulk"
    },
    {
      "parameters": {
        "jsCode": "// TransformForTokuSearch - å¤§é‡ãƒ‡ãƒ¼ã‚¿ç‰ˆï¼ˆcreated_at = tweet_created_atå¯¾å¿œï¼‰\n\n// ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–é–¢æ•°\nfunction normalizeText(text) {\n  if (!text) return '';\n  return text\n    .toLowerCase()\n    .replace(/[ï¼!ï¼Ÿ?ã€€\\s\\n]/g, '')\n    .replace(/ã€.*?ã€‘/g, '')\n    .replace(/\\(.*?\\)/g, '')\n    .replace(/ï¼ˆ.*?ï¼‰/g, '')\n    .trim();\n}\n\n// ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒã‚·ãƒ¥é–¢æ•°\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(36);\n}\n\n// URLãƒ™ãƒ¼ã‚¹IDç”Ÿæˆ\nfunction generateURLBasedID(url) {\n  if (!url) return null;\n  const match = url.match(/status\\/(\\d+)/);\n  return match ? `x-${match[1]}` : null;\n}\n\n// å†…å®¹ãƒ™ãƒ¼ã‚¹IDç”Ÿæˆ\nfunction generateContentBasedID(data) {\n  const service = (data.service || '').toLowerCase().replace(/[^a-z0-9]/g, '');\n  const normalizedTitle = normalizeText(data.title || '');\n  const expiration = data.expiration || 'none';\n  \n  const serviceKey = service\n    .replace(/yahoo!?ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°/g, 'yahoo')\n    .replace(/yahoo!?ã—ã‚‡ã£ã´ã‚“ã/g, 'yahoo')\n    .replace(/paypay/g, 'paypay')\n    .replace(/aupay/g, 'aupay')\n    .replace(/aupa-i/g, 'aupay');\n  \n  const compositeKey = `${serviceKey}|${normalizedTitle.substring(0, 50)}|${expiration}`;\n  return `deal-${simpleHash(compositeKey)}`;\n}\n\n// æ±ºå®šçš„IDç”Ÿæˆ\nfunction generateDeterministicID(data) {\n  const urlID = generateURLBasedID(data.url);\n  const contentID = generateContentBasedID(data);\n  return urlID || contentID;\n}\n\n// ã‚«ãƒ†ã‚´ãƒªåˆ¤å®šé–¢æ•°\nfunction determineCategory(service, title, detail) {\n  const text = `${service} ${title} ${detail}`.toLowerCase();\n  \n  if (/ãƒãƒ„ã‚­ãƒ¨|ã‚µãƒ³ãƒ‰ãƒ©ãƒƒã‚°|ãƒ„ãƒ«ãƒ|ã‚¦ã‚¨ãƒ«ã‚·ã‚¢|ã‚³ã‚³ã‚«ãƒ©|ãƒ‰ãƒ©ãƒƒã‚°|æ—¥ç”¨å“|åŒ–ç²§å“|åŒ»è–¬å“|è–¬|è„±æ¯›/.test(text)) {\n    return 'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ãƒ»æ—¥ç”¨å“';\n  }\n  \n  if (/ã‚¤ã‚ªãƒ³|ã‚¤ãƒˆãƒ¼ãƒ¨ãƒ¼ã‚«ãƒ‰ãƒ¼|è¥¿å‹|ãƒ©ã‚¤ãƒ•|amazon|æ¥½å¤©|yahoo|ãƒ¤ãƒ•ãƒ¼|ec|é€šè²©|ã‚»ãƒ–ãƒ³|ãƒ•ã‚¡ãƒŸãƒ|ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ|ãƒ­ãƒ¼ã‚½ãƒ³|ã‚³ãƒ³ãƒ“ãƒ‹/.test(text)) {\n    return 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ»é‡è²©åº—ãƒ»EC';\n  }\n  \n  if (/ã‚¹ã‚¿ãƒ|ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹|ãƒãƒƒã‚¯|ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰|ã™ãå®¶|æ¾å±‹|å‰é‡å®¶|å¤–é£Ÿ|ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³|é£²é£Ÿ|ã‚°ãƒ«ãƒ¡|é£Ÿäº‹|ãƒ©ãƒ³ãƒ|ãƒ‡ã‚£ãƒŠãƒ¼/.test(text)) {\n    return 'ã‚°ãƒ«ãƒ¡ãƒ»å¤–é£Ÿ';\n  }\n  \n  if (/jr|jal|ana|ã‚½ãƒ©ã‚·ãƒ‰|ã‚¸ã‚§ãƒƒãƒˆ|ã‚¹ã‚¿ãƒ¼|traicy|æ—…è¡Œ|ãƒ›ãƒ†ãƒ«|å®¿æ³Š|èˆªç©º|æ–°å¹¹ç·š|é›»è»Š|äº¤é€š|ãƒˆãƒ©ãƒ™ãƒ«|é£›è¡Œæ©Ÿ|his/.test(text)) {\n    return 'æ—…è¡Œãƒ»äº¤é€š';\n  }\n  \n  if (/paypay|line pay|dæ‰•ã„|æ¥½å¤©pay|au pay|ãƒ¡ãƒ«ãƒšã‚¤|ãƒã‚¤ãƒ³ãƒˆ|ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯|é‚„å…ƒ|ã‚¯ãƒ¼ãƒãƒ³|æ±ºæ¸ˆ|pay|ãƒšã‚¤|ã‚¦ã‚¨ãƒ«æ´»|ãƒãƒ³æ´»|ãƒ‰ãƒªãƒã‚±|vãƒã‚¤ãƒ³ãƒˆ|mnp|povo|uq/.test(text)) {\n    return 'æ±ºæ¸ˆãƒ»ãƒã‚¤ãƒ³ãƒˆ';\n  }\n  \n  if (/ã‚¿ãƒã‚³|ãŸã°ã“|ç…™è‰|é›»å­ã‚¿ãƒã‚³|åŠ ç†±å¼|vape|ã‚¢ã‚¤ã‚³ã‚¹|ãƒ—ãƒ«ãƒ¼ãƒ |ã‚°ãƒ­ãƒ¼/.test(text)) {\n    return 'ã‚¿ãƒã‚³ãƒ»å—œå¥½å“';\n  }\n  \n  return 'ãã®ä»–';\n}\n\n// å‰²å¼•ç‡ãƒ»é‡‘é¡ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°\nfunction extractDiscountInfo(detail, summary) {\n  const text = `${detail} ${summary}`;\n  let rate = null;\n  let amount = null;\n  \n  const rateMatch = text.match(/(\\d+)%|é‚„å…ƒç‡[:ï¼š]?\\s*(\\d+)/);\n  if (rateMatch) {\n    rate = parseInt(rateMatch[1] || rateMatch[2]);\n  }\n  \n  const amountMatch = text.match(/(\\d{1,3}(?:,\\d{3})*)å††|é‚„å…ƒé¡[:ï¼š]?\\s*(\\d{1,3}(?:,\\d{3})*)/);\n  if (amountMatch) {\n    const amountStr = (amountMatch[1] || amountMatch[2]).replace(/,/g, '');\n    amount = parseInt(amountStr);\n  }\n  \n  return { rate, amount };\n}\n\n// å„ªå…ˆåº¦åˆ¤å®šé–¢æ•°\nfunction determinePriority(discountRate, discountAmount) {\n  if ((discountRate && discountRate >= 20) || (discountAmount && discountAmount >= 3000)) {\n    return 'A';\n  }\n  \n  if ((discountRate && discountRate >= 10) || (discountAmount && discountAmount >= 1000)) {\n    return 'B';\n  }\n  \n  return 'C';\n}\n\n// ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°ï¼ˆ0-100ï¼‰\nfunction calculateScore(discountRate, discountAmount, priority, hasExpiration) {\n  let score = 50;\n  \n  if (priority === 'A') score += 30;\n  else if (priority === 'B') score += 20;\n  else score += 10;\n  \n  if (discountRate) {\n    score += Math.min(discountRate / 2, 10);\n  }\n  \n  if (discountAmount) {\n    score += Math.min(discountAmount / 500, 10);\n  }\n  \n  if (hasExpiration) {\n    score += 5;\n  }\n  \n  return Math.min(Math.round(score), 100);\n}\n\n// ãƒ„ã‚¤ãƒ¼ãƒˆæ—¥æ™‚ã‚’ISOå½¢å¼ã«å¤‰æ›\nfunction formatTweetCreatedAt(tweetCreatedAt, fallbackDate) {\n  // tweet_created_atãŒæ—¢ã«ISOå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨\n  if (tweetCreatedAt && /\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}/.test(tweetCreatedAt)) {\n    return tweetCreatedAt;\n  }\n  \n  // fallbackDateãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’ä½¿ã£ã¦00:00:00ã®ISOå½¢å¼ã‚’ä½œæˆ\n  if (fallbackDate && /\\d{4}-\\d{2}-\\d{2}/.test(fallbackDate)) {\n    return `${fallbackDate}T00:00:00.000Z`;\n  }\n  \n  // ã©ã¡ã‚‰ã‚‚ãªã„å ´åˆã¯ç¾åœ¨æ™‚åˆ»\n  return new Date().toISOString();\n}\n\n// ãƒ¡ã‚¤ãƒ³å‡¦ç†\nconst items = $input.all();\nconst transformedItems = [];\n\nconsole.log(`ğŸ”„ TransformForTokuSearchï¼ˆå¤§é‡ç‰ˆï¼‰: ${items.length}ä»¶ã‚’å‡¦ç†é–‹å§‹`);\n\n// 300ä»¶ã«åˆ¶é™\nconst limitedItems = items.slice(0, 300);\nconsole.log(`ğŸ“Š ä¸Šé™300ä»¶ã«åˆ¶é™: ${limitedItems.length}ä»¶ã‚’å‡¦ç†`);\n\nfor (const item of limitedItems) {\n  const data = item.json;\n  \n  // ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚¹ã‚­ãƒƒãƒ—\n  if (data.error) {\n    console.log(`âš ï¸ ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${data.message}`);\n    continue;\n  }\n  \n  // æ±ºå®šçš„IDç”Ÿæˆ\n  const id = generateDeterministicID(data);\n  \n  // ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š\n  const category_main = determineCategory(data.service || '', data.title || '', data.detail || '');\n  \n  // å‰²å¼•æƒ…å ±æŠ½å‡º\n  const { rate, amount } = extractDiscountInfo(data.detail || '', data.summary || '');\n  \n  // å„ªå…ˆåº¦åˆ¤å®š\n  const priority = determinePriority(rate, amount);\n  \n  // ã‚¹ã‚³ã‚¢è¨ˆç®—\n  const score = calculateScore(rate, amount, priority, !!data.expiration);\n  \n  // notesã«è¿½è¨˜ï¼ˆURLã€å‡ºå…¸æƒ…å ±ï¼‰\n  let notes = data.notes || '';\n  if (data.url) {\n    notes += notes ? '\\n' : '';\n    notes += `ã€å‡ºå…¸ã€‘${data.source_name || ''} (${data.source_id || ''})\\n${data.url}`;\n  }\n  \n  // created_atã‚’ãƒ„ã‚¤ãƒ¼ãƒˆæ—¥æ™‚ã‹ã‚‰ç”Ÿæˆ\n  const created_at = formatTweetCreatedAt(data.tweet_created_at, data.date);\n  const updated_at = new Date().toISOString();\n  \n  // TokuSearchå½¢å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ\n  const transformed = {\n    id: id,\n    date: data.date || new Date().toISOString().slice(0, 10),\n    title: data.title || '',\n    summary: data.summary || '',\n    detail: data.detail || '',\n    steps: data.steps || '',\n    service: data.service || '',\n    expiration: data.expiration || '',\n    conditions: data.conditions || '',\n    notes: notes,\n    category_main: category_main,\n    category_sub: '',\n    is_public: 'TRUE',\n    priority: priority,\n    discount_rate: rate || '',\n    discount_amount: amount || '',\n    score: score,\n    created_at: created_at,\n    updated_at: updated_at\n  };\n  \n  transformedItems.push({ json: transformed });\n}\n\nconsole.log(`âœ… TransformForTokuSearchï¼ˆå¤§é‡ç‰ˆï¼‰: ${transformedItems.length}ä»¶ã®å¤‰æ›å®Œäº†`);\n\nreturn transformedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        300
      ],
      "id": "transform-bulk",
      "name": "TransformForTokuSearchBulk"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": []
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1200,
        300
      ],
      "id": "save-to-sheets-bulk",
      "name": "SaveToSheetsBulk",
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        0,
        300
      ],
      "id": "manual-trigger-bulk",
      "name": "ManualTrigger",
      "typeVersion": 1.2
    }
  ],
  "connections": {
    "GeneratePromptBulk": {
      "main": [
        [
          {
            "node": "CallGrokBulk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CallGrokBulk": {
      "main": [
        [
          {
            "node": "ParseGrokBulk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ParseGrokBulk": {
      "main": [
        [
          {
            "node": "TransformForTokuSearchBulk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TransformForTokuSearchBulk": {
      "main": [
        [
          {
            "node": "SaveToSheetsBulk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ManualTrigger": {
      "main": [
        [
          {
            "node": "GeneratePromptBulk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "instanceId": "temp-bulk-collection-workflow"
  },
  "tags": []
}




