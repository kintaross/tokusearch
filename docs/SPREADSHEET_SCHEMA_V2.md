# スプレッドシート構造仕様書 v2.0

## 概要

このドキュメントは、TokuSearchで使用するGoogleスプレッドシートのカラム構造を定義します。

**改修履歴:**
- v1.0: 初期リリース（基本カラムのみ）
- v2.0: タグ機能・ウエル活・ピックアップ対応（2025-11-21）

---

## カラム一覧

| # | カラム名 | 型 | 必須 | 値の例 | 説明 |
|---|---------|---|------|--------|------|
| 1 | id | 文字列 | ✅ | `x-1991325708623507930` | 一意のID（URL-based or Content-based） |
| 2 | date | 日付 | ✅ | `2025-11-20` | 掲載日（YYYY-MM-DD） |
| 3 | title | 文字列 | ✅ | `ヤフーショッピングブラックフライデーセール` | お得情報のタイトル |
| 4 | summary | 文字列 | ✅ | `PayPayポイント最大25%付与` | 短い要約 |
| 5 | detail | 文字列 | | `最大25%付与、期間限定...` | 詳細内容 |
| 6 | steps | 文字列 | | `ヤフーショッピングで対象商品を購入` | 利用手順 |
| 7 | service | 文字列 | | `Yahoo!ショッピング` | 対象サービス・店舗名 |
| 8 | expiration | 文字列 | | `2025-11-30` | 期限（YYYY-MM-DD または説明文） |
| 9 | conditions | 文字列 | | `誰でも` | 適用条件・注意点 |
| 10 | notes | 文字列 | | `PR、PayPayポイントは...` | 備考 |
| 11 | category_main | 文字列 | ✅ | `スーパー・量販店・EC` | メインカテゴリ |
| 12 | category_sub | 文字列 | | `通販` | サブカテゴリ |
| 13 | is_public | ブール | ✅ | `TRUE` | 公開フラグ |
| 14 | priority | 文字列 | ✅ | `A` | 優先度（A/B/C） |
| 15 | discount_rate | 数値 | | `25` | 割引率（%） |
| 16 | discount_amount | 数値 | | `3000` | 還元額（円） |
| 17 | score | 数値 | ✅ | `85` | スコア（0-100） |
| 18 | created_at | 日時 | ✅ | `2025-11-20T10:30:00Z` | 作成日時（ISO 8601） |
| 19 | updated_at | 日時 | ✅ | `2025-11-20T10:30:00Z` | 更新日時（ISO 8601） |
| 20 | **difficulty** | 文字列 | ✅ | `low` | **[v2.0新規] 難易度** |
| 21 | **area_type** | 文字列 | ✅ | `online` | **[v2.0新規] 利用チャネル** |
| 22 | **target_user_type** | 文字列 | ✅ | `all` | **[v2.0新規] 対象ユーザー種別** |
| 23 | **usage_type** | 文字列 | ✅ | `daily_goods` | **[v2.0新規] 主な用途** |
| 24 | **is_welkatsu** | ブール | ✅ | `FALSE` | **[v2.0新規] ウエル活関連** |
| 25 | **tags** | 文字列 | ✅ | `ブラックフライデー,PayPay,Yahoo!ショッピング` | **[v2.0新規] タグ（カンマ区切り）** |

---

## カラム詳細（v2.0 新規追加分）

### 20. difficulty（難易度）

**型:** 文字列

**必須:** ✅

**値の候補:**
- `low` - かんたん（エントリー＋支払い程度）
- `medium` - ふつう（2-3個の条件、2サービス連携等）
- `high` - 手間がかかる（口座開設・クレカ発行・審査等）

**判定ルール:**
- 口座開設・カード発行・審査が必要 → `high`
- 2サービス連携、複数条件 → `medium`
- エントリー＋支払い程度 → `low`
- 迷った場合は上位の難易度を選択

**例:**
```
low: "PayPayで500円以上購入で10%還元"
medium: "楽天市場で対象ショップ＋楽天カード決済で15%還元"
high: "新規口座開設＋10万円入金で5000円キャッシュバック"
```

---

### 21. area_type（利用チャネル）

**型:** 文字列

**必須:** ✅

**値の候補:**
- `online` - オンライン完結（通販・オンラインサービス）
- `store` - 実店舗がメイン（ドラッグストア・スーパー等）
- `online+store` - 両方で利用可能（決済手段・共通ポイント等）

**判定ルール:**
- 通販・オンラインサービス → `online`
- 実店舗での購入・利用 → `store`
- 決済・ポイント系で場所不問 → `online+store`

**例:**
```
online: "Amazonタイムセール"
store: "ウエルシア20日限定20%還元"
online+store: "PayPay20%還元キャンペーン"
```

---

### 22. target_user_type（対象ユーザー種別）

**型:** 文字列

**必須:** ✅

**値の候補:**
- `all` - 誰でも利用可能
- `new_or_inactive` - 新規・休眠ユーザー限定
- `limited` - 特定プラン・家族・学生等の限定

**判定ルール:**
- 「誰でも」明記 → `all`
- 「初めて」「新規」「利用なし」「久しぶり」 → `new_or_inactive`
- 特定属性限定 → `limited`

**例:**
```
all: "Yahoo!ショッピング 全員対象セール"
new_or_inactive: "au PAY 初回利用で300円還元"
limited: "楽天プレミアム会員限定ポイント10倍"
```

---

### 23. usage_type（主な用途）

**型:** 文字列

**必須:** ✅

**値の候補:**
- `daily_goods` - ドラッグストア・日用品・日常消費
- `eating_out` - グルメ・外食
- `travel` - 旅行・交通・レジャー
- `financial` - 銀行・証券・投資・クレカ・決済系
- `utility_bills` - 公共料金・通信費・税金
- `hobby` - ゲーム・サブスク・エンタメ
- `other` - その他

**判定ルール:**
- `category_main`を優先し、本文も参考にして決定
- ユーザー視点で「何に使うお得か」を重視

**例:**
```
daily_goods: "ウエルシア 日用品20%還元"
eating_out: "マクドナルド ハッピーセット半額"
travel: "JALマイル2倍キャンペーン"
financial: "新規口座開設で5000円"
```

---

### 24. is_welkatsu（ウエル活関連）

**型:** ブール

**必須:** ✅

**値の候補:**
- `TRUE` - ウエル活関連案件
- `FALSE` - 非ウエル活案件

**判定ルール:**
- `service`が「ウエルシア」を含む → `TRUE`
- `title`, `summary`, `detail`, `notes`, `conditions`のいずれかに「ウエルシア」または「ウエル活」を含む → `TRUE`
- 上記以外 → `FALSE`

**例:**
```
TRUE: "ウエルシア20日限定20%還元"
TRUE: "ウエル活で使えるTポイント2倍キャンペーン"
FALSE: "PayPay20%還元"
```

---

### 25. tags（タグ）

**型:** 文字列（カンマ区切り）

**必須:** ✅

**値の例:**
```
ブラックフライデー,PayPay,Yahoo!ショッピング,ポイント還元
ウエルシア,ウエル活,Tポイント,20日限定
au PAY,紹介キャンペーン,初回限定,300円還元
```

**付与ルール:**
- 3〜7個の日本語タグを配列で返す
- セール名、サービス名、決済名、汎用ワードを含む
- 類義語を重複させない（例: ブラックフライデー≒BF≒黒金 → 一つに統一）

**抽出対象:**
- `title`
- `summary`
- `detail`
- `service`
- `category_main`

---

## カテゴリマスタ（category_main）

| 値 | 説明 |
|---|------|
| ドラッグストア・日用品 | 薬局、化粧品、日用品 |
| スーパー・量販店・EC | イオン、Amazon、楽天等 |
| グルメ・外食 | レストラン、ファストフード |
| 旅行・交通 | 航空、鉄道、ホテル |
| 決済・ポイント | PayPay、クレカ、QR決済 |
| タバコ・嗜好品 | タバコ、電子タバコ |
| その他 | 上記以外 |

---

## 優先度（priority）

| 値 | 説明 | ピックアップ表示 |
|---|------|----------------|
| A | 高還元・高額・注目度高 | ✅ 表示される |
| B | 標準的なお得 | 表示されない |
| C | 軽微なお得 | 表示されない |

**注:** `/pickup`ページでは`priority = A`の案件をピックアップとして表示します。

---

## データ入力規則

### 1. 必須カラムは必ず埋める
- `id`, `date`, `title`, `summary`, `category_main`, `is_public`, `priority`, `score`, `created_at`, `updated_at`
- **v2.0追加:** `difficulty`, `area_type`, `target_user_type`, `usage_type`, `is_welkatsu`, `tags`

### 2. null・空文字を避ける
- 不明な場合でも「最も近い値」を選択する
- 例: `difficulty`が不明 → `medium`を選択

### 3. 日付形式の統一
- `date`, `expiration`: `YYYY-MM-DD` 形式
- `created_at`, `updated_at`: ISO 8601形式（`2025-11-20T10:30:00Z`）

### 4. タグのフォーマット
- カンマ区切り（スペースなし）
- 例: `タグ1,タグ2,タグ3`
- NG例: `タグ1, タグ2, タグ3`（スペースあり）

---

## n8nワークフローでの自動生成

v2.0で追加された以下のカラムは、n8nワークフロー内のLLM（Gemini）により自動生成されます：

1. `difficulty`
2. `area_type`
3. `target_user_type`
4. `usage_type`
5. `is_welkatsu`
6. `tags`

**処理フロー:**
1. Grokが基本情報を収集
2. **Geminiが上記6項目を自動判定・生成**（新規追加）
3. TransformForTokuSearchがTokuSearch形式に変換
4. Googleスプレッドシートに保存

---

## 既存データのマイグレーション

### マイグレーション対象
現在スプレッドシートに存在する全27件のデータ

### マイグレーション方法
1. 既存データを一括で取得
2. LLM（Gemini）でバッチ処理
3. 新カラムのみ更新（既存データは保持）

### マイグレーションスクリプト
`scripts/migrate-existing-data.js` を実行

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-11-21 | v2.0 | タグ機能・ウエル活・ピックアップ対応（6カラム追加） |
| 2025-XX-XX | v1.0 | 初期リリース |

---

## 関連ドキュメント

- [スプレッドシート設定ガイド](./SPREADSHEET_SETTINGS.md)
- [n8nワークフロー設定](../n8n-tokusearch-setup.md)
- [データ型定義](../types/deal.ts)



