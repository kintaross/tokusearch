{
  "name": "ãŠå¾—æƒ…å ±è‡ªå‹•åé›†ï¼†TokuSearchæ›´æ–°",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Grokã‹ã‚‰è¿”ã£ã¦ããŸ\"choices[0].message.content\"ã«JSONæ–‡å­—åˆ—ãŒã‚ã‚‹\ntry {\n  const response = $json.choices[0].message.content;\n  const items = JSON.parse(response); // æ–‡å­—åˆ—â†’é…åˆ—ã«å¤‰æ›\n  return items.map(item => ({ json: item }));\n} catch (err) {\n  return [{ json: { error: true, message: err.message } }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        -240
      ],
      "id": "009d962b-6024-451f-bd5c-d3de51ebb02d",
      "name": "ParseGrokResponse"
    },
    {
      "parameters": {
        "jsCode": "// æ—¥ä»˜ãƒ­ã‚¸ãƒƒã‚¯: éå»24æ™‚é–“ä»¥å†…ã«å¤‰æ›´ï¼ˆçµ‚äº†æƒ…å ±æ¸›ã‚‰ã™ï¼‰[1]\nconst now = new Date();\nconst oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);\nconst formatDate = (date) => date.toISOString().slice(0, 10);\nconst startDate = formatDate(oneDayAgo);\nconst endDate = formatDate(now);\n\n// æ”¹å–„ç‰ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: çµ‚äº†æƒ…å ±é™¤å¤–ã€ä¿¡é ¼æ€§ãƒ•ã‚£ãƒ«ã‚¿ã€é¡ä¼¼æƒ…å ±è¿½åŠ ã€æŠ½é¸/ãƒ•ã‚©ãƒ­ãƒ¼/æŠ•è³‡é™¤å¤–[1]\nconst prompt = `\n${startDate}ã€œ${endDate} ã®æœŸé–“ã«X(Twitter)ã§æŠ•ç¨¿ã•ã‚ŒãŸã€ŒãŠå¾—æƒ…å ±ã€ã‚’åé›†ã—ã€ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚[1]\n\n**é‡è¦**: å‡ºåŠ›ã¯ç´”ç²‹ãªJSONã®ã¿ã€‚ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹(\\`\\`\\`)ã‚„èª¬æ˜æ–‡ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚[1]\n\n[\n{\n\"date\": \"YYYY-MM-DD\",\n\"title\": \"ãŠå¾—æƒ…å ±ã®è¦‹å‡ºã—\",\n\"summary\": \"çŸ­ã„è¦ç´„ï¼ˆæœ¬æ–‡ã‚’å‡ç¸®ï¼‰\",\n\"detail\": \"å‰²å¼•ãƒ»é‚„å…ƒã®å…·ä½“å†…å®¹ï¼ˆç‡/é¡ãƒ»ä¸Šé™ãƒ»å¯¾è±¡ï¼‰\", [2]\n\"steps\": \"åˆ©ç”¨/ç”³è¾¼ã®æ‰‹é †ï¼ˆã‚¢ãƒ—ãƒªãƒ»ã‚¯ãƒ¼ãƒãƒ³ãƒ»æ™‚é–“å¸¯ãªã©ï¼‰\", [2]\n\"service\": \"å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ãƒ»åº—èˆ—å\", [2]\n\"url\": \"https://x.com/.../status/...\", [2]\n\"source_name\": \"å‡ºå…¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå\", [2]\n\"source_id\": \"@handle\", [2]\n\"expiration\": \"YYYY-MM-DD ã‚‚ã—ãã¯ æœŸé–“ã®èª¬æ˜æ–‡ (çµ‚äº†æ¸ˆã¿ã¯null)\", [2]\n\"conditions\": \"æ–°è¦/æ—¢å­˜/å…ˆç€/æŠ½é¸/å›æ•°ãªã©\", [2]\n\"notes\": \"æ³¨æ„ç‚¹ãƒ»ä¾‹å¤–ãƒ»å‚™è€ƒ\" [2]\n}\n]\n\n# åé›†ãƒ«ãƒ¼ãƒ«\n- ç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å„ªå…ˆã—ã¤ã¤ã€é¡ä¼¼ç³»çµ±ã®ä¿¡é ¼ã§ãã‚‹ã‚‚ã®ã‚‚å«ã‚ã‚‹ (ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼500ä»¥ä¸Š) [2]\n- è¨€ã„å›ã—ãŒé•ã£ã¦ã‚‚ã€Œå†…å®¹ãŒåŒã˜ã€ãªã‚‰çµ±åˆã—1ä»¶ã«ã¾ã¨ã‚ã‚‹ [2]\n- ä»¥ä¸‹ã®ã„ãšã‚Œã‹ãŒç•°ãªã‚‹å ´åˆã¯åˆ¥ä»¶ã¨ã™ã‚‹ï¼š [2]\n- å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹/åº—èˆ— [2]\n- å‰²å¼•/é‚„å…ƒã®ç‡ãƒ»ä¸Šé™ãƒ»æœŸé–“ [2]\n- åˆ©ç”¨/ç”³è¾¼æ‰‹é †ï¼ˆæ”¯æ‰•ã„æ‰‹æ®µãƒ»æ¡ä»¶ã®å·®ï¼‰ [2]\n- æ•°å€¤ã¯åŠè§’çµ±ä¸€ï¼ˆä¾‹: 20%, 1000å††, ä¸Šé™1000ãƒã‚¤ãƒ³ãƒˆï¼‰ [2]\n- æ¬ æã¯ null ã‚’å…¥ã‚Œã‚‹ï¼ˆç©ºæ–‡å­— \"\" ã¯ä½¿ã‚ãªã„ï¼‰ [2]\n- åŒæ§˜ã®æƒ…å ±ãŒè¤‡æ•°ã‚ã£ãŸå ´åˆã¯ã€ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°ãŒä¸€ç•ªå¤šã„å†…å®¹ã®urlã‚’æŒ¿å…¥ã™ã‚‹ [3]\n- çµ‚äº†ã—ãŸã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã¯é™¤å¤– (expirationãŒéå»ã®æ—¥ä»˜ã€ã¾ãŸã¯ã€Œçµ‚äº†ã€ã€Œçµ‚äº†é–“è¿‘ã€ã€Œä»Šæ—¥ã§çµ‚ã‚ã‚Šã€å«ã‚€ã‚‚ã®ã¯null) [3]\n- é«˜é¡é‚„å…ƒ/å‰²å¼• (10%ä»¥ä¸Šã€1000å††ä»¥ä¸Š) ã‚’å„ªå…ˆ [3]\n- ä¿¡é ¼æ€§ä½ã„ã‚‚ã® (ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼50æœªæº€) ã¯é™¤å¤– [3]\n- æŠ½é¸ã§å½“é¸ç‡ãŒä½ã„ã‚‚ã®ï¼ˆå½“é¸è€…10000åä»¥ä¸‹ï¼‰ã¯é™¤å¤– [3]\n- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚©ãƒ­ãƒ¼ã‚„ãƒªãƒã‚¹ãƒˆã‚’æ¡ä»¶ã¨ã™ã‚‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã¯é™¤å¤– [3]\n- æŠ•è³‡é–¢é€£ï¼ˆæ ªã€æš—å·è³‡ç”£ã€ãƒˆãƒ¬ãƒ¼ãƒ‰ãªã©ï¼‰ã¯é™¤å¤– [3]\n- é‡è¤‡å†…å®¹ã¯çµ±åˆã—ã€1ä»¶ã«ã¾ã¨ã‚ã‚‹ [3]\n- **TikTokã«é–¢ã™ã‚‹å†…å®¹ã¯é™¤å¤– (ãŠå®¢æ§˜ã®è¦æœ›ã«ã‚ˆã‚Šå³å®ˆ)** [3]\n- ä¸Šå ´ä¼æ¥­ã®å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã¯é™¤å¤–ï¼ˆå€‹äººã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ãƒ¬ãƒ™ãƒ«ã®æƒ…å ±ãŒã»ã—ã„ï¼‰ [3]\n- â—¯â—¯ã‚’è²·ã†ã¨1å€‹ç„¡æ–™ãªã©ã®ã€ã„ã‚ã‚†ã‚‹ã€Œãƒ—ãƒ©ã‚¤ãƒã€ã¯é™¤å¤– [3]\n\n# å„ªå…ˆç›£è¦–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ (æ›´æ–°: æ—…è¡Œç³»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆTraicyã‚’è¿½åŠ )\nã“ã¨ã¯ã‚€ã€ãŠå¾—Ã—ãƒã‚¤æ´»ã€‘ @kotoham_pkt [3]\nã‚¯ãƒ¼ãƒãƒ¡ @tosu5580 [3]\nã‹ã‚Šã‚“@åŒ»ç™‚è„±æ¯›ãƒãƒ‹ã‚¢ @buran_umeda [3]\nãŸã£ãã‚“ @9kuIOQMh1T85626 [3]\nã‚ã‚“ã“ @an89no23 [3]\nã¡ã³ã†ã•ğŸ°@ç„¡çµ¦å…ãƒ–ãƒ­ã‚¬ãƒ¼ @chibiusachi [3]\nã‚ãã³@ã‚ãã³ã‚¸ãƒ£ãƒ‘ãƒ³ @akubichan_sab [4]\nã‚ãã³@è‚²å…ã®åˆé–“ã«å‰¯æ¥­ã‚ã‚Œã“ã‚Œ @akubichan62124 [4]\nã‚ã®ã²ã¨@ä¸‡åšVIP CARDä¿æœ‰æ¸ˆ @2akautebon [4]\nHalohaloï½œæ—…è¡Œãƒ¬ã‚¸ãƒ£ãƒ¼æƒ…å ± @halohalo_travel [4]\nã¨ã‚‚ã‚ŠPay @tomor1nn [4]\nãƒãƒãƒ¼ã®çŠ¬ğŸ• @ourmoneybook [4]\nmao (ã¾ãŠ)@ãƒã‚¤æ´»ã§å®¶ã‚’è²·ã£ãŸä¸»å©¦ @mao_otk_tw [4]\nã‚ãã½ã‚“ @akipon229 [4]\nãƒ–ãƒ«ã‚¾ãƒ³@ãŠå¾—å¥½ã @BuruzonBBA [4]\nakiko_lawson @akiko_lawson [4]\nvtcosmetics_jp @vtcosmetics_jp [4]\n**Traicyï¼ˆãƒˆãƒ©ã‚¤ã‚·ãƒ¼ï¼‰ @traicycom** // <-- æ–°è¦è¿½åŠ \n\n# è¿½åŠ æ¤œç´¢ãƒ«ãƒ¼ãƒ« (æƒ…å ±é‡å¢—åŠ ã®ãŸã‚ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤§å¹…ã«å¼·åŒ–)\n- ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã§é¡ä¼¼æƒ…å ±ã‚’è£œå®Œ: \"ãŠå¾—æƒ…å ± ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ å‰²å¼• ã‚¯ãƒ¼ãƒãƒ³ ãƒã‚¤ãƒ³ãƒˆ é‚„å…ƒ MNP povo UQ JAL ANA ã‚½ãƒ©ã‚·ãƒ‰ ã‚¦ã‚¨ãƒ«æ´» ãƒãƒ³æ´» ãƒ‰ãƒªãƒã‚± Vãƒã‚¤ãƒ³ãƒˆ PayPay\"\n- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã§æ–°é®®æƒ…å ±: \"(ãŠå¾— OR ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ OR å‰²å¼• OR ã‚¯ãƒ¼ãƒãƒ³ OR ãƒã‚¤ãƒ³ãƒˆ OR é‚„å…ƒ OR JAL OR ANA OR ã‚¸ã‚§ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ OR ã‚½ãƒ©ã‚·ãƒ‰ OR ã‚¦ã‚¨ãƒ«æ´» OR ãƒãƒ³æ´» OR ãƒ‰ãƒªãƒã‚± OR MNP OR PayPay OR Vãƒã‚¤ãƒ³ãƒˆ) **min_faves:5** since:${startDate} -TikTok -çµ‚äº† -çµ‚ã‚ã‚Š -æŠ•è³‡ -æ ª -æš—å·è³‡ç”£ -ãƒˆãƒ¬ãƒ¼ãƒ‰\" **limit:50**\n`.trim();\n\nreturn [{ json: { prompt, startDate, endDate } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        -240
      ],
      "id": "7b0761ab-79f1-4d1e-a651-a5b1f676ba09",
      "name": "GeneratePrompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.x.ai/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "xAiApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "grok-4"
            },
            {
              "name": "search_parameters",
              "value": "={{ {   \"mode\": \"auto\",   \"from_date\": $json.startDate,   \"to_date\": $json.endDate,   \"max_search_results\": 30,   \"sources\": [{ \"type\": \"x\", \"post_favorite_count\": 10 }] } }}"
            },
            {
              "name": "messages",
              "value": "={{ [{ \"role\": \"user\", \"content\": $json.prompt }] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -544,
        -240
      ],
      "id": "22224c18-6923-46b8-88dc-0d7c118ded3c",
      "name": "CallGrokAI",
      "credentials": {
        "xAiApi": {
          "id": "m3OLs9FipQlOJmOA",
          "name": "xAi account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        -16
      ],
      "id": "3a607381-ed27-421b-8ebd-a4f606f8ed8b",
      "name": "GetSentHistory",
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst today = new Date().toISOString().slice(0, 10);\nlet message = `ğŸ“… ${today}ã®æ–°ç€æƒ…å ±ï¼ˆ${items.length}ä»¶ï¼‰ï¼š\\n\\n`;\n\nfor (const item of items) {\n  const d = item.json;\n\n  // ã‚¿ã‚¤ãƒˆãƒ«ãŒãªã„ã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ï¼ˆã¾ãŸã¯d.urlã§ã‚‚OKï¼‰\n  if (!d.title && !d.url) continue;\n\n  message += `ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘${d.title || 'ï¼ˆãªã—ï¼‰'}\\n`;\n  message += `ã€æ¦‚è¦ã€‘${d.summary || 'ï¼ˆãªã—ï¼‰'}\\n`;\n  message += `ã€æ‰‹é †ã€‘${d.steps || 'ï¼ˆãªã—ï¼‰'}\\n`;\n  message += `ã€æ¡ä»¶ã€‘${d.conditions || 'ï¼ˆãªã—ï¼‰'}\\n`;\n  message += `ã€æœŸé–“ã€‘${d.expiration || 'ï¼ˆä¸æ˜ï¼‰'}\\n`;\n  message += `ã€URLã€‘${d.url || ''} (${d.source_id || '??'})\\n\\n`;\n}\n\nreturn [{ json: { text: message.trim() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        400
      ],
      "id": "d76d0f73-bb89-4073-be8e-b86634818fe9",
      "name": "BuildSlackMessage"
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "#daily_o-toku",
          "mode": "name"
        },
        "text": "={{ $json.text }}",
        "otherOptions": {
          "includeLinkToWorkflow": false
        }
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        400,
        400
      ],
      "id": "04cdd427-f81e-4e81-aacd-2bb12730de95",
      "name": "SlackNotify",
      "webhookId": "a1ea8121-abd5-4a24-a6b4-655ddf5a6594",
      "credentials": {
        "slackApi": {
          "id": "kahTvH10blaEP2kb",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "database",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "date": "={{ $json.date }}",
            "title": "={{ $json.title }}",
            "summary": "={{ $json.summary }}",
            "detail": "={{ $json.detail }}",
            "steps": "={{ $json.steps }}",
            "service": "={{ $json.service }}",
            "expiration": "={{ $json.expiration }}",
            "conditions": "={{ $json.conditions }}",
            "notes": "={{ $json.notes }}",
            "category_main": "={{ $json.category_main }}",
            "category_sub": "={{ $json.category_sub }}",
            "is_public": "={{ $json.is_public }}",
            "priority": "={{ $json.priority }}",
            "discount_rate": "={{ $json.discount_rate }}",
            "discount_amount": "={{ $json.discount_amount }}",
            "score": "={{ $json.score }}",
            "created_at": "={{ $json.created_at }}",
            "updated_at": "={{ $json.updated_at }}",
            "difficulty": "={{ $json.difficulty }}",
            "area_type": "={{ $json.area_type }}",
            "target_user_type": "={{ $json.target_user_type }}",
            "usage_type": "={{ $json.usage_type }}",
            "is_welkatsu": "={{ $json.is_welkatsu }}",
            "tags": "={{ $json.tags }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "date",
              "displayName": "date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "summary",
              "displayName": "summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "detail",
              "displayName": "detail",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "steps",
              "displayName": "steps",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service",
              "displayName": "service",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "expiration",
              "displayName": "expiration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conditions",
              "displayName": "conditions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "category_main",
              "displayName": "category_main",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "category_sub",
              "displayName": "category_sub",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "is_public",
              "displayName": "is_public",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "discount_rate",
              "displayName": "discount_rate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "discount_amount",
              "displayName": "discount_amount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "difficulty",
              "displayName": "difficulty",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "area_type",
              "displayName": "area_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "target_user_type",
              "displayName": "target_user_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "usage_type",
              "displayName": "usage_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "is_welkatsu",
              "displayName": "is_welkatsu",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        48,
        224
      ],
      "id": "5296b703-b25f-4767-b75b-8c84f1ef5f5a",
      "name": "SaveToHistory",
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.prompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -1152,
        352
      ],
      "id": "9fb33656-00bd-40bb-9023-4de55c788d03",
      "name": "Message a model",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "16265a7f-47e9-4372-aba4-5cbb3efc89b9",
              "name": "prompt",
              "value": "={{(() => {\n  const items = $json.allItems;\n  \n  // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã«å¿…è¦ãªæƒ…å ±ã®ã¿æŠ½å‡ºï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰\n  const simplifiedItems = items.map(item => ({\n    title: item.title,\n    service: item.service,\n    expiration: item.expiration,\n    detail: item.detail ? item.detail.substring(0, 200) : null // è©³ç´°ã¯æœ€åˆã®200æ–‡å­—ã®ã¿\n  }));\n  \n  return 'ä»¥ä¸‹ã¯å–å¾—ã•ã‚ŒãŸãŠå¾—æƒ…å ±ã§ã™ã€‚\\n\\n' +\n    'ã“ã®ä¸­ã‹ã‚‰ã€æ˜ã‚‰ã‹ã«é‡è¤‡ã¾ãŸã¯åŒä¸€ã®å†…å®¹ã ã¨æ€ã‚ã‚Œã‚‹ã‚‚ã®ã‚’é™¤å¤–ã—ã€' +\n    'æ–°è¦ã¨æ€ã‚ã‚Œã‚‹æƒ…å ±ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·ã®ã¿ã‚’ **ç´”ç²‹ãªJSONé…åˆ—å½¢å¼** ã§è¿”ã—ã¦ãã ã•ã„ã€‚\\n\\n' +\n    'âš ï¸ æ³¨æ„ï¼šè¿”å´ã™ã‚‹ã®ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·ã®é…åˆ—ã®ã¿ã§ã™ã€‚\\n\\n' +\n    'ã€åˆ¤å®šåŸºæº–ã€‘\\n' +\n    '- åŒã˜ã‚µãƒ¼ãƒ“ã‚¹åã§åŒã˜ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å†…å®¹ãªã‚‰é‡è¤‡\\n' +\n    '- æœŸé™ãŒç•°ãªã‚Œã°åˆ¥ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³\\n' +\n    '- å‰²å¼•ç‡ãƒ»é‚„å…ƒé¡ãŒç•°ãªã‚Œã°åˆ¥ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³\\n\\n' +\n    'ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã€‘\\n' +\n    JSON.stringify(simplifiedItems, null, 2) + '\\n\\n' +\n    'ã€è¿”å´å½¢å¼ã€‘ï¼šæ–°è¦æƒ…å ±ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·ã®é…åˆ—ã‚’JSONã§è¿”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜ãƒ»ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ãªã©ä¸è¦ï¼‰ï¼š\\n' +\n    '[0, 2, 5, 8]  // ä¾‹: 0ç•ªç›®ã€2ç•ªç›®ã€5ç•ªç›®ã€8ç•ªç›®ãŒæ–°è¦';\n})()}}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -960,
        112
      ],
      "id": "0ea622ce-90da-471a-983c-0c5c2dfdd393",
      "name": "BuildGeminiPrompt"
    },
    {
      "parameters": {
        "content": "Grokå‡¦ç†",
        "height": 208,
        "width": 656,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -816,
        -288
      ],
      "typeVersion": 1,
      "id": "b544a38e-5518-497e-8ed8-226053c2ea78",
      "name": "Sticky Note"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -48,
        -224
      ],
      "id": "805a411a-9430-4fa6-8fa8-93d7314f5b1d",
      "name": "MergeInputs"
    },
    {
      "parameters": {
        "jsCode": "// ä¸€åº¦ã§ã‚‚å®Ÿè¡Œã•ã‚ŒãŸã‚‰1ä»¶ã ã‘è¿”ã™ã‚ˆã†ã«ã™ã‚‹\nif ($runIndex !== 0) return [];\n\nconst items = $input.all().map(item => item.json);\n\nreturn [\n  {\n    json: {\n      allItems: items\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        112
      ],
      "id": "9c1cbada-c0c8-49fd-995e-f68f842a1633",
      "name": "WrapItemsAsArray"
    },
    {
      "parameters": {
        "jsCode": "const rawText = $json.content.parts[0].text;\n\n// ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜å·ï¼ˆ```json\\n...```ï¼‰ã‚’é™¤å»\nconst jsonString = rawText\n  .replace(/^```json\\s*/, '')  // ```json ã§å§‹ã¾ã‚‹éƒ¨åˆ†ã‚’å‰Šé™¤\n  .replace(/```$/m, '')         // æœ€å¾Œã® ``` ã‚’å‰Šé™¤\n  .trim();\n\nlet indexArray;\ntry {\n  indexArray = JSON.parse(jsonString);\n} catch (e) {\n  throw new Error(\"âŒ Geminiã®å‡ºåŠ›ã‹ã‚‰JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å†…å®¹: \" + jsonString);\n}\n\nif (!Array.isArray(indexArray)) {\n  throw new Error(\"âŒ Geminiã®å‡ºåŠ›ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å†…å®¹: \" + jsonString);\n}\n\n// WrapItemsAsArrayã§ä¿å­˜ã•ã‚ŒãŸå…ƒã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—\nconst originalItems = $items(\"WrapItemsAsArray\", 0)[0].json.allItems;\n\n// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·ã«åŸºã¥ã„ã¦å…ƒã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŠ½å‡º\nconst filteredItems = indexArray\n  .filter(idx => idx >= 0 && idx < originalItems.length)\n  .map(idx => originalItems[idx]);\n\nconsole.log(`âœ… GeminiãŒé¸æŠã—ãŸæ–°è¦æƒ…å ±: ${filteredItems.length}ä»¶`);\n\n// å‡ºåŠ›å½¢å¼ã‚’ n8n ç”¨ã«å¤‰æ›\nreturn filteredItems.map(item => ({ json: item }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        352
      ],
      "id": "981767fd-bab4-470d-b48b-1827689c3fee",
      "name": "UnpackGeminiResults"
    },
    {
      "parameters": {
        "jsCode": "// ã€Œä»Šæ—¥ã‹ã‚‰éå»30æ—¥ä»¥å†…ã€ã®å±¥æ­´ã ã‘ã‚’æ®‹ã™\nconst thirtyDaysAgo = new Date();\nthirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n\nreturn items.filter(item => {\n  const dateStr = item.json.date || item.json.created_at;\n  if (!dateStr) return false;\n\n  const itemDate = new Date(dateStr);\n  return itemDate >= thirtyDaysAgo;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        -16
      ],
      "id": "e954e3b9-df77-4e9c-b295-d67edb1531f3",
      "name": "FilterRecentHistory"
    },
    {
      "parameters": {
        "content": "é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ äº‹å‰å‡¦ç†(å–å¾—)",
        "height": 464,
        "width": 416,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -128,
        -288
      ],
      "typeVersion": 1,
      "id": "6f299637-0859-42ad-91d4-8e01d0212534",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿäº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ + Geminiæœ€çµ‚åˆ¤å®šï¼‰",
        "height": 560,
        "width": 656,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1344,
        0
      ],
      "typeVersion": 1,
      "id": "98f6bca9-6fd1-464d-8934-9a325b973451",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "æœ€çµ‚å‡¦ç†ï¼ˆSlacké€šçŸ¥ãƒ»å±¥æ­´ä¿å­˜ï¼‰",
        "height": 352,
        "width": 800
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -128,
        208
      ],
      "typeVersion": 1,
      "id": "a9bdc4e1-92ba-4b80-9567-c82826551843",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 10
            },
            {
              "triggerAtHour": 20
            },
            {
              "triggerAtHour": 12
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1120,
        -240
      ],
      "id": "d4604ff9-682d-43c6-abb7-648192024987",
      "name": "TriggerEvery1"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// TransformForTokuSearch ãƒãƒ¼ãƒ‰ï¼ˆv2.0å¯¾å¿œï¼‰\n// æ±ºå®šçš„IDç”Ÿæˆ + TokuSearchå½¢å¼å¤‰æ› + æ–°ã‚«ãƒ©ãƒ å¯¾å¿œ\n// ========================================\n\n// ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–é–¢æ•°ï¼ˆè¡¨ç¾ã®æºã‚Œã‚’å¸åï¼‰\nfunction normalizeText(text) {\n  if (!text) return '';\n  return text\n    .toLowerCase()\n    .replace(/[ï¼!ï¼Ÿ?ã€€\\s\\n]/g, '') // è¨˜å·ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ãƒ»æ”¹è¡Œå‰Šé™¤\n    .replace(/ã€.*?ã€‘/g, '') // ã€ã€‘å†…å‰Šé™¤\n    .replace(/\\(.*?\\)/g, '') // ()å†…å‰Šé™¤\n    .replace(/ï¼ˆ.*?ï¼‰/g, '') // ï¼ˆï¼‰å†…å‰Šé™¤\n    .trim();\n}\n\n// ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒã‚·ãƒ¥é–¢æ•°\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›\n  }\n  return Math.abs(hash).toString(36);\n}\n\n// URLãƒ™ãƒ¼ã‚¹IDç”Ÿæˆ\nfunction generateURLBasedID(url) {\n  if (!url) return null;\n  const match = url.match(/status\\/(\\d+)/);\n  return match ? `x-${match[1]}` : null;\n}\n\n// å†…å®¹ãƒ™ãƒ¼ã‚¹IDç”Ÿæˆ\nfunction generateContentBasedID(data) {\n  const service = (data.service || '').toLowerCase().replace(/[^a-z0-9]/g, '');\n  const normalizedTitle = normalizeText(data.title || '');\n  const expiration = data.expiration || 'none';\n  \n  // ã‚µãƒ¼ãƒ“ã‚¹åã®çŸ­ç¸®å½¢ã‚‚è€ƒæ…®\n  const serviceKey = service\n    .replace(/yahoo!?ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°/g, 'yahoo')\n    .replace(/yahoo!?ã—ã‚‡ã£ã´ã‚“ã/g, 'yahoo')\n    .replace(/paypay/g, 'paypay')\n    .replace(/aupay/g, 'aupay')\n    .replace(/aupa-i/g, 'aupay');\n  \n  const compositeKey = `${serviceKey}|${normalizedTitle.substring(0, 50)}|${expiration}`;\n  return `deal-${simpleHash(compositeKey)}`;\n}\n\n// æ±ºå®šçš„IDç”Ÿæˆï¼ˆURLå„ªå…ˆã€ãªã‘ã‚Œã°å†…å®¹ãƒ™ãƒ¼ã‚¹ï¼‰\nfunction generateDeterministicID(data) {\n  const urlID = generateURLBasedID(data.url);\n  const contentID = generateContentBasedID(data);\n  \n  // ãƒ—ãƒ©ã‚¤ãƒãƒªIDã¯URLå„ªå…ˆï¼ˆURLãŒã‚ã‚‹å ´åˆï¼‰\n  return urlID || contentID;\n}\n\n// ã‚«ãƒ†ã‚´ãƒªåˆ¤å®šé–¢æ•°\nfunction determineCategory(service, title, detail) {\n  const text = `${service} ${title} ${detail}`.toLowerCase();\n  \n  // ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ãƒ»æ—¥ç”¨å“\n  if (/ãƒãƒ„ã‚­ãƒ¨|ã‚µãƒ³ãƒ‰ãƒ©ãƒƒã‚°|ãƒ„ãƒ«ãƒ|ã‚¦ã‚¨ãƒ«ã‚·ã‚¢|ã‚³ã‚³ã‚«ãƒ©|ãƒ‰ãƒ©ãƒƒã‚°|æ—¥ç”¨å“|åŒ–ç²§å“|åŒ»è–¬å“|è–¬|è„±æ¯›/.test(text)) {\n    return 'ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ãƒ»æ—¥ç”¨å“';\n  }\n  \n  // ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ»é‡è²©åº—ãƒ»EC\n  if (/ã‚¤ã‚ªãƒ³|ã‚¤ãƒˆãƒ¼ãƒ¨ãƒ¼ã‚«ãƒ‰ãƒ¼|è¥¿å‹|ãƒ©ã‚¤ãƒ•|amazon|æ¥½å¤©|yahoo|ãƒ¤ãƒ•ãƒ¼|ec|é€šè²©|ã‚»ãƒ–ãƒ³|ãƒ•ã‚¡ãƒŸãƒ|ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ|ãƒ­ãƒ¼ã‚½ãƒ³|ã‚³ãƒ³ãƒ“ãƒ‹/.test(text)) {\n    return 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ»é‡è²©åº—ãƒ»EC';\n  }\n  \n  // ã‚°ãƒ«ãƒ¡ãƒ»å¤–é£Ÿ\n  if (/ã‚¹ã‚¿ãƒ|ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹|ãƒãƒƒã‚¯|ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰|ã™ãå®¶|æ¾å±‹|å‰é‡å®¶|å¤–é£Ÿ|ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³|é£²é£Ÿ|ã‚°ãƒ«ãƒ¡|é£Ÿäº‹|ãƒ©ãƒ³ãƒ|ãƒ‡ã‚£ãƒŠãƒ¼/.test(text)) {\n    return 'ã‚°ãƒ«ãƒ¡ãƒ»å¤–é£Ÿ';\n  }\n  \n  // æ—…è¡Œãƒ»äº¤é€š\n  if (/jr|jal|ana|ã‚½ãƒ©ã‚·ãƒ‰|ã‚¸ã‚§ãƒƒãƒˆ|ã‚¹ã‚¿ãƒ¼|traicy|æ—…è¡Œ|ãƒ›ãƒ†ãƒ«|å®¿æ³Š|èˆªç©º|æ–°å¹¹ç·š|é›»è»Š|äº¤é€š|ãƒˆãƒ©ãƒ™ãƒ«|é£›è¡Œæ©Ÿ|his/.test(text)) {\n    return 'æ—…è¡Œãƒ»äº¤é€š';\n  }\n  \n  // æ±ºæ¸ˆãƒ»ãƒã‚¤ãƒ³ãƒˆ\n  if (/paypay|line pay|dæ‰•ã„|æ¥½å¤©pay|au pay|ãƒ¡ãƒ«ãƒšã‚¤|ãƒã‚¤ãƒ³ãƒˆ|ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯|é‚„å…ƒ|ã‚¯ãƒ¼ãƒãƒ³|æ±ºæ¸ˆ|pay|ãƒšã‚¤|ã‚¦ã‚¨ãƒ«æ´»|ãƒãƒ³æ´»|ãƒ‰ãƒªãƒã‚±|vãƒã‚¤ãƒ³ãƒˆ|mnp|povo|uq/.test(text)) {\n    return 'æ±ºæ¸ˆãƒ»ãƒã‚¤ãƒ³ãƒˆ';\n  }\n  \n  // ã‚¿ãƒã‚³ãƒ»å—œå¥½å“\n  if (/ã‚¿ãƒã‚³|ãŸã°ã“|ç…™è‰|é›»å­ã‚¿ãƒã‚³|åŠ ç†±å¼|vape|ã‚¢ã‚¤ã‚³ã‚¹|ãƒ—ãƒ«ãƒ¼ãƒ |ã‚°ãƒ­ãƒ¼/.test(text)) {\n    return 'ã‚¿ãƒã‚³ãƒ»å—œå¥½å“';\n  }\n  \n  return 'ãã®ä»–';\n}\n\n// å‰²å¼•ç‡ãƒ»é‡‘é¡ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°\nfunction extractDiscountInfo(detail, summary) {\n  const text = `${detail} ${summary}`;\n  let rate = null;\n  let amount = null;\n  \n  // å‰²å¼•ç‡ã®æŠ½å‡ºï¼ˆ%ï¼‰\n  const rateMatch = text.match(/(\\d+)%|é‚„å…ƒç‡[:ï¼š]?\\s*(\\d+)/);\n  if (rateMatch) {\n    rate = parseInt(rateMatch[1] || rateMatch[2]);\n  }\n  \n  // é‡‘é¡ã®æŠ½å‡ºï¼ˆå††ï¼‰\n  const amountMatch = text.match(/(\\d{1,3}(?:,\\d{3})*)å††|é‚„å…ƒé¡[:ï¼š]?\\s*(\\d{1,3}(?:,\\d{3})*)/);\n  if (amountMatch) {\n    const amountStr = (amountMatch[1] || amountMatch[2]).replace(/,/g, '');\n    amount = parseInt(amountStr);\n  }\n  \n  return { rate, amount };\n}\n\n// å„ªå…ˆåº¦åˆ¤å®šé–¢æ•°\nfunction determinePriority(discountRate, discountAmount) {\n  // A: 20%ä»¥ä¸Š ã¾ãŸã¯ 3000å††ä»¥ä¸Š\n  if ((discountRate && discountRate >= 20) || (discountAmount && discountAmount >= 3000)) {\n    return 'A';\n  }\n  \n  // B: 10%ä»¥ä¸Š ã¾ãŸã¯ 1000å††ä»¥ä¸Š\n  if ((discountRate && discountRate >= 10) || (discountAmount && discountAmount >= 1000)) {\n    return 'B';\n  }\n  \n  // C: ãã®ä»–\n  return 'C';\n}\n\n// ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°ï¼ˆ0-100ï¼‰\nfunction calculateScore(discountRate, discountAmount, priority, hasExpiration) {\n  let score = 50; // ãƒ™ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢\n  \n  // å„ªå…ˆåº¦ã«ã‚ˆã‚‹ãƒœãƒ¼ãƒŠã‚¹\n  if (priority === 'A') score += 30;\n  else if (priority === 'B') score += 20;\n  else score += 10;\n  \n  // å‰²å¼•ç‡ã«ã‚ˆã‚‹ãƒœãƒ¼ãƒŠã‚¹\n  if (discountRate) {\n    score += Math.min(discountRate / 2, 10); // æœ€å¤§10ç‚¹\n  }\n  \n  // å‰²å¼•é¡ã«ã‚ˆã‚‹ãƒœãƒ¼ãƒŠã‚¹\n  if (discountAmount) {\n    score += Math.min(discountAmount / 500, 10); // æœ€å¤§10ç‚¹\n  }\n  \n  // æœŸé™æƒ…å ±ãŒã‚ã‚‹ã‹ã©ã†ã‹\n  if (hasExpiration) {\n    score += 5;\n  }\n  \n  // 100ç‚¹æº€ç‚¹ã«æ­£è¦åŒ–\n  return Math.min(Math.round(score), 100);\n}\n\n// ãƒ¡ã‚¤ãƒ³å‡¦ç†\nconst items = $input.all();\nconst transformedItems = [];\n\nconsole.log(`ğŸ”„ TransformForTokuSearch: ${items.length}ä»¶ã‚’å‡¦ç†é–‹å§‹`);\n\nfor (const item of items) {\n  const data = item.json;\n  \n  // æ±ºå®šçš„IDç”Ÿæˆï¼ˆURLå„ªå…ˆã€ãªã‘ã‚Œã°å†…å®¹ãƒ™ãƒ¼ã‚¹ï¼‰\n  const id = generateDeterministicID(data);\n  console.log(`ğŸ“ ç”ŸæˆID: ${id} (ã‚¿ã‚¤ãƒˆãƒ«: ${data.title})`);\n  \n  // ã‚«ãƒ†ã‚´ãƒªåˆ¤å®š\n  const category_main = determineCategory(data.service || '', data.title || '', data.detail || '');\n  \n  // å‰²å¼•æƒ…å ±æŠ½å‡º\n  const { rate, amount } = extractDiscountInfo(data.detail || '', data.summary || '');\n  \n  // å„ªå…ˆåº¦åˆ¤å®š\n  const priority = determinePriority(rate, amount);\n  \n  // ã‚¹ã‚³ã‚¢è¨ˆç®—\n  const score = calculateScore(rate, amount, priority, !!data.expiration);\n  \n  // notesã«è¿½è¨˜ï¼ˆURLã€å‡ºå…¸æƒ…å ±ï¼‰\n  let notes = data.notes || '';\n  if (data.url) {\n    notes += notes ? '\\n' : '';\n    notes += `ã€å‡ºå…¸ã€‘${data.source_name || ''} (${data.source_id || ''})\\n${data.url}`;\n  }\n  \n  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—\n  const now = new Date().toISOString();\n  \n  // TokuSearchå½¢å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ\n  const transformed = {\n    id: id,\n    date: data.date || new Date().toISOString().slice(0, 10),\n    title: data.title || '',\n    summary: data.summary || '',\n    detail: data.detail || '',\n    steps: data.steps || '',\n    service: data.service || '',\n    expiration: data.expiration || '',\n    conditions: data.conditions || '',\n    notes: notes,\n    category_main: category_main,\n    category_sub: '', // ã‚ªãƒ—ã‚·ãƒ§ãƒ³\n    is_public: 'TRUE',\n    priority: priority,\n    discount_rate: rate || '',\n    discount_amount: amount || '',\n    score: score,\n    created_at: now,\n    updated_at: now,\n    // v2.0 æ–°è¦è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆLLMã‚¿ã‚°ä»˜ã‘ãƒãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ï¼‰\n    difficulty: data.difficulty || 'medium',\n    area_type: data.area_type || 'online+store',\n    target_user_type: data.target_user_type || 'all',\n    usage_type: data.usage_type || 'other',\n    is_welkatsu: data.is_welkatsu === true ? 'TRUE' : 'FALSE',\n    tags: data.tags || ''\n  };\n  \n  transformedItems.push({ json: transformed });\n}\n\nconsole.log(`âœ… TransformForTokuSearch: ${transformedItems.length}ä»¶ã®å¤‰æ›å®Œäº†`);\n\nreturn transformedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -160,
        352
      ],
      "id": "3aca6689-7116-4293-9812-8f47fe6127aa",
      "name": "TransformForTokuSearch"
    },
    {
      "parameters": {
        "content": "TokuSearchå¤‰æ›ï¼ˆv2.0å¯¾å¿œï¼‰",
        "height": 288,
        "width": 416,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -240,
        272
      ],
      "typeVersion": 1,
      "id": "4492fd60-5d74-4959-a2fb-3100c5a537ec",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// FilterByID: é«˜é€Ÿäº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆURL + å†…å®¹ãƒ™ãƒ¼ã‚¹ï¼‰\n// ========================================\n\n// ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–é–¢æ•°ï¼ˆTransformForTokuSearchã¨åŒã˜ï¼‰\nfunction normalizeText(text) {\n  if (!text) return '';\n  return text\n    .toLowerCase()\n    .replace(/[ï¼!ï¼Ÿ?ã€€\\s\\n]/g, '')\n    .replace(/ã€.*?ã€‘/g, '')\n    .replace(/\\(.*?\\)/g, '')\n    .replace(/ï¼ˆ.*?ï¼‰/g, '')\n    .trim();\n}\n\n// ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒã‚·ãƒ¥é–¢æ•°\nfunction simpleHash(str) {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return Math.abs(hash).toString(36);\n}\n\n// URLãƒ™ãƒ¼ã‚¹IDç”Ÿæˆ\nfunction generateURLBasedID(url) {\n  if (!url) return null;\n  const match = url.match(/status\\/(\\d+)/);\n  return match ? `x-${match[1]}` : null;\n}\n\n// å†…å®¹ãƒ™ãƒ¼ã‚¹IDç”Ÿæˆ\nfunction generateContentBasedID(data) {\n  const service = (data.service || '').toLowerCase().replace(/[^a-z0-9]/g, '');\n  const normalizedTitle = normalizeText(data.title || '');\n  const expiration = data.expiration || 'none';\n  \n  const serviceKey = service\n    .replace(/yahoo!?ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°/g, 'yahoo')\n    .replace(/yahoo!?ã—ã‚‡ã£ã´ã‚“ã/g, 'yahoo')\n    .replace(/paypay/g, 'paypay')\n    .replace(/aupay/g, 'aupay')\n    .replace(/aupa-i/g, 'aupay');\n  \n  const compositeKey = `${serviceKey}|${normalizedTitle.substring(0, 50)}|${expiration}`;\n  return `deal-${simpleHash(compositeKey)}`;\n}\n\n// ãƒ¡ã‚¤ãƒ³å‡¦ç†\nconst historyItems = $items(\"FilterRecentHistory\", 0).map(i => i.json);\nconst grokItems = $input.all().map(i => i.json);\n\n// å±¥æ­´ã®IDä¸€è¦§ï¼ˆURL + å†…å®¹ï¼‰\nconst historyURLIDs = new Set();\nconst historyContentIDs = new Set();\n\nhistoryItems.forEach(item => {\n  // URL-based ID\n  const urlID = generateURLBasedID(item.url);\n  if (urlID) historyURLIDs.add(urlID);\n  \n  // Content-based IDï¼ˆæ—¢å­˜ã®å±¥æ­´ã‹ã‚‰ã‚‚ç”Ÿæˆï¼‰\n  if (item.id) {\n    // æ—¢å­˜IDãŒx-ã§å§‹ã¾ã‚‹å ´åˆã‚‚URLãƒ™ãƒ¼ã‚¹ã¨ã—ã¦æ‰±ã†\n    if (item.id.startsWith('x-')) {\n      historyURLIDs.add(item.id);\n    } else if (item.id.startsWith('deal-')) {\n      historyContentIDs.add(item.id);\n    }\n  }\n  \n  // IDãŒãªã„å ´åˆã¯å†…å®¹ã‹ã‚‰ç”Ÿæˆ\n  if (!item.id) {\n    const contentID = generateContentBasedID(item);\n    historyContentIDs.add(contentID);\n  }\n});\n\nconsole.log(`ğŸ“Š å±¥æ­´URL-IDæ•°: ${historyURLIDs.size}`);\nconsole.log(`ğŸ“Š å±¥æ­´Content-IDæ•°: ${historyContentIDs.size}`);\nconsole.log(`ğŸ“Š Grokçµæœæ•°: ${grokItems.length}`);\n\n// é‡è¤‡ãƒã‚§ãƒƒã‚¯\nconst filtered = grokItems.filter(item => {\n  // URL-based ãƒã‚§ãƒƒã‚¯\n  const urlID = generateURLBasedID(item.url);\n  if (urlID && historyURLIDs.has(urlID)) {\n    console.log(`âš ï¸ URLé‡è¤‡: ${item.title} (${urlID})`);\n    return false; // é‡è¤‡\n  }\n  \n  // Content-based ãƒã‚§ãƒƒã‚¯\n  const contentID = generateContentBasedID(item);\n  if (historyContentIDs.has(contentID)) {\n    console.log(`âš ï¸ å†…å®¹é‡è¤‡: ${item.title} (${contentID})`);\n    return false; // é‡è¤‡\n  }\n  \n  return true; // æ–°è¦\n});\n\nconsole.log(`âœ… FilterByIDå®Œäº†: ${filtered.length}ä»¶ãŒæ–°è¦ï¼ˆ${grokItems.length - filtered.length}ä»¶ã‚’é™¤å¤–ï¼‰`);\n\nreturn filtered.map(i => ({ json: i }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1344,
        112
      ],
      "id": "0dff1da4-ce54-49a5-b85e-61662c8660f8",
      "name": "FilterByID"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// SimpleLLMTagging: 1ä»¶ãšã¤é«˜é€Ÿã‚¿ã‚°ä»˜ã‘\n// ========================================\n\nconst items = $input.all();\nconst enrichedItems = [];\n\n// ç°¡æ½”ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ\nconst buildPrompt = (item) => `\nä»¥ä¸‹ã®ãŠå¾—æƒ…å ±ã‚’åˆ†æã—ã€JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚\n\nã‚¿ã‚¤ãƒˆãƒ«: ${item.title}\nã‚µãƒ¼ãƒ“ã‚¹: ${item.service}\nè©³ç´°: ${(item.detail || '').substring(0, 200)}\næ¡ä»¶: ${item.conditions}\n\nä»¥ä¸‹ã®å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜ä¸è¦ã€JSONã®ã¿ï¼‰:\n{\n  \"difficulty\": \"low/medium/high\",\n  \"area_type\": \"online/store/online+store\",\n  \"target_user_type\": \"all/new_or_inactive/limited\",\n  \"usage_type\": \"daily_goods/eating_out/travel/financial/utility_bills/hobby/other\",\n  \"is_welkatsu\": true/false,\n  \"tags\": [\"ã‚¿ã‚°1\", \"ã‚¿ã‚°2\", \"ã‚¿ã‚°3\"]\n}\n\nåˆ¤å®šåŸºæº–:\n- difficulty: low=ç°¡å˜, medium=æ™®é€š, high=å£åº§é–‹è¨­ç­‰\n- area_type: online=ãƒãƒƒãƒˆ, store=åº—èˆ—, online+store=ä¸¡æ–¹\n- target_user_type: all=èª°ã§ã‚‚, new_or_inactive=æ–°è¦é™å®š, limited=æ¡ä»¶ä»˜ã\n- usage_type: ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã‹ã‚‰åˆ¤æ–­\n- is_welkatsu: ã‚¦ã‚¨ãƒ«ã‚·ã‚¢é–¢é€£ãªã‚‰true\n- tags: 3-5å€‹ã®æ¤œç´¢ç”¨ã‚¿ã‚°\n`.trim();\n\n// ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹åˆ¤å®šï¼ˆLLMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰\nconst ruleBasedTagging = (item) => {\n  const text = `${item.title} ${item.service} ${item.detail}`.toLowerCase();\n  \n  // ã‚¦ã‚¨ãƒ«æ´»åˆ¤å®š\n  const is_welkatsu = /ã‚¦ã‚¨ãƒ«ã‚·ã‚¢|ã‚¦ã‚¨ãƒ«æ´»/.test(text);\n  \n  // é›£æ˜“åº¦åˆ¤å®š\n  let difficulty = 'medium';\n  if (/å£åº§|è¨¼åˆ¸|ã‚¯ãƒ¬ã‚«|ä¿é™º/.test(text)) difficulty = 'high';\n  else if (/ã‚¨ãƒ³ãƒˆãƒªãƒ¼|ç™»éŒ²|ã‚¯ãƒ¼ãƒãƒ³/.test(text)) difficulty = 'low';\n  \n  // ãƒãƒ£ãƒãƒ«åˆ¤å®š\n  let area_type = 'online+store';\n  if (/ã‚ªãƒ³ãƒ©ã‚¤ãƒ³|ec|é€šè²©|amazon|æ¥½å¤©|yahoo/.test(text)) area_type = 'online';\n  else if (/åº—èˆ—|æ¥åº—|å®Ÿåº—/.test(text)) area_type = 'store';\n  \n  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¤å®š\n  let target_user_type = 'all';\n  if (/åˆã‚ã¦|æ–°è¦|åˆ©ç”¨ãªã—|ä¹…ã—ã¶ã‚Š/.test(text)) target_user_type = 'new_or_inactive';\n  else if (/é™å®š|å®¶æ—|å­¦ç”Ÿ|ä¼šå“¡/.test(text)) target_user_type = 'limited';\n  \n  // ç”¨é€”åˆ¤å®š\n  let usage_type = 'other';\n  if (/ãƒ‰ãƒ©ãƒƒã‚°|æ—¥ç”¨å“|åŒ–ç²§å“/.test(text)) usage_type = 'daily_goods';\n  else if (/ã‚°ãƒ«ãƒ¡|å¤–é£Ÿ|ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³|é£²é£Ÿ/.test(text)) usage_type = 'eating_out';\n  else if (/æ—…è¡Œ|ãƒ›ãƒ†ãƒ«|èˆªç©º|jr/.test(text)) usage_type = 'travel';\n  else if (/paypay|æ±ºæ¸ˆ|ãƒã‚¤ãƒ³ãƒˆ|é‚„å…ƒ|éŠ€è¡Œ/.test(text)) usage_type = 'financial';\n  \n  // ã‚¿ã‚°ç”Ÿæˆ\n  const tags = [];\n  if (item.service) tags.push(item.service);\n  if (/paypay/.test(text)) tags.push('PayPay');\n  if (/ã‚»ãƒ¼ãƒ«|ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³/.test(text)) tags.push('ã‚»ãƒ¼ãƒ«');\n  if (is_welkatsu) tags.push('ã‚¦ã‚¨ãƒ«æ´»');\n  tags.push(usage_type === 'daily_goods' ? 'æ—¥ç”¨å“' : 'å‰²å¼•');\n  \n  return { difficulty, area_type, target_user_type, usage_type, is_welkatsu, tags: tags.slice(0, 5).join(',') };\n};\n\nconsole.log(`ğŸ·ï¸ LLMã‚¿ã‚°ä»˜ã‘é–‹å§‹: ${items.length}ä»¶`);\n\n// å…¨ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¿ã‚°ä»˜ã‘ã‚’é©ç”¨ï¼ˆé«˜é€Ÿãƒ»ç¢ºå®Ÿï¼‰\nfor (const item of items) {\n  const data = item.json;\n  const tagging = ruleBasedTagging(data);\n  \n  enrichedItems.push({\n    json: {\n      ...data,\n      ...tagging\n    }\n  });\n}\n\nconsole.log(`âœ… ã‚¿ã‚°ä»˜ã‘å®Œäº†: ${enrichedItems.length}ä»¶ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰`);\n\nreturn enrichedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -560,
        352
      ],
      "id": "llm-tagging-simple",
      "name": "SimpleLLMTagging"
    },
    {
      "parameters": {
        "content": "ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¿ã‚°ä»˜ã‘ï¼ˆv2.0 - é«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰",
        "height": 288,
        "width": 416,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -640,
        272
      ],
      "typeVersion": 1,
      "id": "llm-tagging-sticky-note",
      "name": "Sticky Note5"
    }
  ],
  "pinData": {},
  "connections": {
    "ParseGrokResponse": {
      "main": [
        [
          {
            "node": "MergeInputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GeneratePrompt": {
      "main": [
        [
          {
            "node": "CallGrokAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CallGrokAI": {
      "main": [
        [
          {
            "node": "ParseGrokResponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetSentHistory": {
      "main": [
        [
          {
            "node": "FilterRecentHistory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildSlackMessage": {
      "main": [
        [
          {
            "node": "SlackNotify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "UnpackGeminiResults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildGeminiPrompt": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MergeInputs": {
      "main": [
        [
          {
            "node": "FilterByID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WrapItemsAsArray": {
      "main": [
        [
          {
            "node": "BuildGeminiPrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UnpackGeminiResults": {
      "main": [
        [
          {
            "node": "SimpleLLMTagging",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FilterRecentHistory": {
      "main": [
        [
          {
            "node": "MergeInputs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "TransformForTokuSearch": {
      "main": [
        [
          {
            "node": "BuildSlackMessage",
            "type": "main",
            "index": 0
          },
          {
            "node": "SaveToHistory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TriggerEvery1": {
      "main": [
        [
          {
            "node": "GeneratePrompt",
            "type": "main",
            "index": 0
          },
          {
            "node": "GetSentHistory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FilterByID": {
      "main": [
        [
          {
            "node": "WrapItemsAsArray",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SimpleLLMTagging": {
      "main": [
        [
          {
            "node": "TransformForTokuSearch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "updated-v2-with-llm-tagging",
  "meta": {
    "instanceId": "fefffd21e64fa94994bb4bf38b5a050c59f6cf28bd3cad9da0a5804220d9e97f"
  },
  "id": "9Q6T3O2xHWhcAjFC",
  "tags": []
}

