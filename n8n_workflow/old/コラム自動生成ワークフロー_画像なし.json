{
  "name": "ã‚³ãƒ©ãƒ è‡ªå‹•ç”Ÿæˆï¼ˆç”»åƒãªã—ç‰ˆï¼‰",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "days",
              "daysInterval": 1,
              "triggerAtHour": 9,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "id": "a1-schedule",
      "name": "ScheduleTrigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_themes",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "used",
              "lookupValue": "FALSE"
            }
          ]
        },
        "options": {}
      },
      "id": "a2-get-themes",
      "name": "GetUnusedThemes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [460, 300],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const unusedThemes = $input.all().map(item => item.json);\n\nif (unusedThemes.length === 0) {\n  throw new Error('âŒ æœªä½¿ç”¨ãƒ†ãƒ¼ãƒãŒã‚ã‚Šã¾ã›ã‚“');\n}\n\nconst randomIndex = Math.floor(Math.random() * unusedThemes.length);\nconst selectedTheme = unusedThemes[randomIndex];\n\nconsole.log(`âœ… ãƒ†ãƒ¼ãƒé¸æŠ: ${selectedTheme.theme}`);\n\nreturn [{ json: selectedTheme }];"
      },
      "id": "a3-random",
      "name": "RandomThemeSelection",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "const theme = $json.theme;\nconst level = $json.level;\nconst themeNo = $json.no;\n\nconst prompt = `\nã‚ãªãŸã¯JSONç”Ÿæˆå°‚é–€AIã§ã™ã€‚å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nã€ãƒ†ãƒ¼ãƒã€‘${theme}\nã€ãƒ¬ãƒ™ãƒ«ã€‘${level}\n\nã€å‡ºåŠ›å½¢å¼ã€‘\nä»¥ä¸‹ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ\\`\\`\\`ï¼‰ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚\n\n{\n  \"title\": \"è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30-40æ–‡å­—ï¼‰\",\n  \"description\": \"è¨˜äº‹ã®æ¦‚è¦ï¼ˆ80-120æ–‡å­—ï¼‰\",\n  \"content_markdown\": \"# è¦‹å‡ºã—1\\\\n\\\\næœ¬æ–‡...\\\\n\\\\n## è¦‹å‡ºã—2\\\\n\\\\næœ¬æ–‡...ï¼ˆ2000-3000æ–‡å­—ã€Markdownå½¢å¼ï¼‰\",\n  \"category\": \"ãƒã‚¤ãƒ³ãƒˆæ´»ç”¨\",\n  \"tags\": \"ã‚¿ã‚°1,ã‚¿ã‚°2,ã‚¿ã‚°3\"\n}\n\nã€è¨˜äº‹æ§‹æˆã®æŒ‡ç¤ºã€‘\ncontent_markdownã«ã¯ä»¥ä¸‹ã®æ§‹æˆã§è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„ï¼š\n1. å°å…¥ï¼ˆèª­è€…ã®æ‚©ã¿ã¨è§£æ±ºç­–ï¼‰\n2. åŸºæœ¬ã®è€ƒãˆæ–¹\n3. å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—\n4. æ³¨æ„ç‚¹ãƒ»ã‚ˆãã‚ã‚‹å¤±æ•—\n5. ã¾ã¨ã‚\n\nã€ã‚«ãƒ†ã‚´ãƒªå€™è£œã€‘\nãƒã‚¤ãƒ³ãƒˆæ´»ç”¨ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€ç¯€ç´„è¡“ã€æ—…è¡Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹ã€å®¶è¨ˆç®¡ç†ã€ãµã‚‹ã•ã¨ç´ç¨\n\nã€çµ¶å¯¾å³å®ˆã€‘\n- å‡ºåŠ›ã¯ç´”ç²‹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿\n- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜å·ï¼ˆ\\`\\`\\`jsonï¼‰ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„\n- å‰å¾Œã«èª¬æ˜æ–‡ã‚’å…¥ã‚Œãªã„\n- JSONã¨ã—ã¦æ­£ã—ããƒ‘ãƒ¼ã‚¹å¯èƒ½ãªå½¢å¼ã§å‡ºåŠ›\n`.trim();\n\nreturn [{ json: { prompt, theme, level, themeNo } }];"
      },
      "id": "a4-prompt",
      "name": "BuildArticlePrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.prompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [1120, 300],
      "id": "a5-generate",
      "name": "GenerateArticle",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rawText = $json.content.parts[0].text;\n\nconst jsonString = rawText\n  .replace(/^```json\\s*/m, '')\n  .replace(/```$/m, '')\n  .trim();\n\nlet article;\ntry {\n  article = JSON.parse(jsonString);\n} catch (e) {\n  console.error('âŒ JSONè§£æã‚¨ãƒ©ãƒ¼:', jsonString.substring(0, 300));\n  throw new Error('è¨˜äº‹ã®JSONè§£æã«å¤±æ•—');\n}\n\nconst result = {\n  ...article,\n  theme: $items('BuildArticlePrompt')[0].json.theme,\n  level: $items('BuildArticlePrompt')[0].json.level,\n  themeNo: $items('BuildArticlePrompt')[0].json.themeNo\n};\n\nconsole.log('âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†:', result.title);\n\nreturn [{ json: result }];"
      },
      "id": "a6-parse",
      "name": "ParseArticleJSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "jsCode": "const articleData = $json;\n\nconst slug = articleData.title\n  .toLowerCase()\n  .replace(/[^\\w\\s-]/g, '')\n  .replace(/\\s+/g, '-')\n  .substring(0, 50);\n\nconst content_html = articleData.content_markdown\n  .replace(/^### (.*$)/gim, '<h3>$1</h3>')\n  .replace(/^## (.*$)/gim, '<h2>$1</h2>')\n  .replace(/^# (.*$)/gim, '<h1>$1</h1>')\n  .replace(/\\*\\*(.*?)\\*\\*/gim, '<strong>$1</strong>')\n  .replace(/\\*(.*?)\\*/gim, '<em>$1</em>')\n  .replace(/\\n\\n/gim, '</p><p>')\n  .replace(/\\n/gim, '<br>');\n\nconst columnData = {\n  slug: slug,\n  title: articleData.title,\n  description: articleData.description,\n  content_markdown: articleData.content_markdown,\n  content_html: '<p>' + content_html + '</p>',\n  category: articleData.category,\n  tags: articleData.tags,\n  thumbnail_url: '',\n  author: 'TokuSearch AI',\n  status: 'published',\n  is_featured: false,\n  theme: articleData.theme,\n  themeNo: articleData.themeNo\n};\n\nconsole.log('âœ… ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†:', columnData.title);\n\nreturn [{ json: columnData }];"
      },
      "id": "a7-prepare",
      "name": "PrepareColumnData",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://tokusearch.vercel.app/api/admin/columns",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "a8-post",
      "name": "PostColumn",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1780, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "create-new",
          "name": "TokuSearch API Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_themes",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "used": "TRUE",
            "used_at": "={{new Date().toISOString()}}"
          }
        },
        "options": {
          "dataLocationOnSheet": "={{ \"A\" + ($items('PrepareColumnData')[0].json.themeNo + 1) }}"
        }
      },
      "id": "a9-update",
      "name": "UpdateThemeUsed",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [2000, 300],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const columnData = $items('PrepareColumnData')[0].json;\n\nconst message = `ğŸ‰ ã‚³ãƒ©ãƒ è‡ªå‹•ç”Ÿæˆå®Œäº†ï¼\n\nã‚¿ã‚¤ãƒˆãƒ«: ${columnData.title}\nã‚«ãƒ†ã‚´ãƒª: ${columnData.category}\nURL: https://tokusearch.vercel.app/columns/${columnData.slug}\n\nâ€»ç”»åƒãªã—ç‰ˆ`;\n\nconsole.log(message);\n\nreturn [{ json: { message, success: true } }];"
      },
      "id": "a10-complete",
      "name": "BuildCompletionMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 300]
    }
  ],
  "connections": {
    "ScheduleTrigger": {
      "main": [[{"node": "GetUnusedThemes", "type": "main", "index": 0}]]
    },
    "GetUnusedThemes": {
      "main": [[{"node": "RandomThemeSelection", "type": "main", "index": 0}]]
    },
    "RandomThemeSelection": {
      "main": [[{"node": "BuildArticlePrompt", "type": "main", "index": 0}]]
    },
    "BuildArticlePrompt": {
      "main": [[{"node": "GenerateArticle", "type": "main", "index": 0}]]
    },
    "GenerateArticle": {
      "main": [[{"node": "ParseArticleJSON", "type": "main", "index": 0}]]
    },
    "ParseArticleJSON": {
      "main": [[{"node": "PrepareColumnData", "type": "main", "index": 0}]]
    },
    "PrepareColumnData": {
      "main": [[{"node": "PostColumn", "type": "main", "index": 0}]]
    },
    "PostColumn": {
      "main": [[{"node": "UpdateThemeUsed", "type": "main", "index": 0}]]
    },
    "UpdateThemeUsed": {
      "main": [[{"node": "BuildCompletionMessage", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-11-27T00:00:00.000Z",
  "versionId": "1"
}

