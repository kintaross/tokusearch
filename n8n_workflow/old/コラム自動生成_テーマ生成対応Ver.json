{
  "name": "ã‚³ãƒ©ãƒ è‡ªå‹•ç”Ÿæˆ_ãƒ†ãƒ¼ãƒç”Ÿæˆå¯¾å¿œVer",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9
            }
          ]
        }
      },
      "id": "a47f54f5-78a9-4346-bf77-ac946223e92e",
      "name": "ScheduleTrigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1200,
        -144
      ]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_themes",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "used",
              "lookupValue": "FALSE"
            }
          ]
        },
        "options": {}
      },
      "id": "bf34564a-5fb7-4e50-872a-f817800b61f6",
      "name": "GetUnusedThemes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -880,
        -144
      ],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.all();\nconst unusedThemes = inputData.map(item => item.json);\n\n// IFãƒãƒ¼ãƒ‰ã§æ—¢ã«åˆ†å²ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã«ã¯å¸¸ã«ãƒ†ãƒ¼ãƒãŒå­˜åœ¨ã™ã‚‹\nconst randomIndex = Math.floor(Math.random() * unusedThemes.length);\nconst selectedTheme = unusedThemes[randomIndex];\n\nconsole.log(`âœ… ãƒ†ãƒ¼ãƒé¸æŠ: ${selectedTheme.theme}`);\n\nreturn [{ json: selectedTheme }];"
      },
      "id": "3ab8d7a9-086a-45f8-afac-feb653709c5d",
      "name": "RandomThemeSelection",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -928,
        512
      ]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch"
        },
        "sheetName": {
          "__rl": true,
          "value": "database",
          "mode": "name"
        },
        "options": {}
      },
      "id": "53fc0f81-77dd-4350-902f-5847b1671644",
      "name": "GetRecentDeals",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -704,
        512
      ],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const allDeals = $input.all().map(item => item.json);\n\n// éå»2é€±é–“ï¼ˆ14æ—¥é–“ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿\nconst twoWeeksAgo = new Date();\ntwoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);\nconst cutoffDate = twoWeeksAgo.toISOString().split('T')[0];\n\n// å„ªå…ˆåº¦A/Bã‚’ä¸­å¿ƒã«å–å¾—\nconst recentDeals = allDeals.filter(deal => {\n  const dealDate = deal.date || deal.created_at || '';\n  const dateStr = dealDate.split('T')[0];\n  const priority = deal.priority || '';\n  return dateStr >= cutoffDate && (priority === 'A' || priority === 'B');\n});\n\nconsole.log(`ğŸ“Š éå»2é€±é–“ã®ãŠå¾—æƒ…å ±: ${recentDeals.length}ä»¶`);\n\n// ã‚«ãƒ†ã‚´ãƒªåˆ†æ\nconst categoryCount = {};\nrecentDeals.forEach(deal => {\n  const cat = deal.category_main || 'ãã®ä»–';\n  categoryCount[cat] = (categoryCount[cat] || 0) + 1;\n});\nconst topCategories = Object.entries(categoryCount)\n  .sort((a, b) => b[1] - a[1])\n  .slice(0, 3)\n  .map(([cat]) => cat);\n\n// ã‚¿ã‚°åˆ†æ\nconst tagCount = {};\nrecentDeals.forEach(deal => {\n  const tags = (deal.tags || '').split(',').map(t => t.trim()).filter(t => t);\n  tags.forEach(tag => {\n    tagCount[tag] = (tagCount[tag] || 0) + 1;\n  });\n});\nconst topTags = Object.entries(tagCount)\n  .sort((a, b) => b[1] - a[1])\n  .slice(0, 10)\n  .map(([tag]) => tag);\n\n// ã‚µãƒ¼ãƒ“ã‚¹ååˆ†æ\nconst serviceCount = {};\nrecentDeals.forEach(deal => {\n  const service = deal.service || '';\n  if (service) {\n    serviceCount[service] = (serviceCount[service] || 0) + 1;\n  }\n});\nconst topServices = Object.entries(serviceCount)\n  .sort((a, b) => b[1] - a[1])\n  .slice(0, 5)\n  .map(([service]) => service);\n\n// é‚„å…ƒç‡åˆ†æï¼ˆ20%ä»¥ä¸Šï¼‰\nconst highDiscountCategories = {};\nrecentDeals.forEach(deal => {\n  const rate = parseInt(deal.discount_rate || '0', 10);\n  if (rate >= 20) {\n    const cat = deal.category_main || 'ãã®ä»–';\n    highDiscountCategories[cat] = (highDiscountCategories[cat] || 0) + 1;\n  }\n});\nconst trendingDiscountCategories = Object.entries(highDiscountCategories)\n  .sort((a, b) => b[1] - a[1])\n  .slice(0, 3)\n  .map(([cat]) => cat);\n\nconst trendInfo = {\n  topCategories: topCategories,\n  topTags: topTags,\n  topServices: topServices,\n  trendingDiscountCategories: trendingDiscountCategories,\n  dealCount: recentDeals.length\n};\n\nconsole.log('ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æçµæœ:', JSON.stringify(trendInfo, null, 2));\n\nreturn [{ json: trendInfo }];"
      },
      "id": "35834d56-c444-4df2-bdc1-79a3448001b6",
      "name": "AnalyzeTrends",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        512
      ]
    },
    {
      "parameters": {
        "jsCode": "const unusedThemes = $input.all().map(item => item.json);\nconst themeCount = unusedThemes.length;\n\nconsole.log(`ğŸ“Š æœªä½¿ç”¨ãƒ†ãƒ¼ãƒæ•°: ${themeCount}ä»¶`);\n\nif (themeCount === 0) {\n  console.log('âš ï¸ æœªä½¿ç”¨ãƒ†ãƒ¼ãƒãŒ0ä»¶ã®ãŸã‚ã€æ–°è¦ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¾ã™');\n  return [{ json: { shouldGenerate: true, themeCount: 0 } }];\n} else {\n  console.log('âœ… æœªä½¿ç”¨ãƒ†ãƒ¼ãƒãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€é€šå¸¸ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š');\n  // ãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ã‚‚ä¿æŒã—ã¦RandomThemeSelectionã«æ¸¡ã™\n  return unusedThemes.map(t => ({ json: { ...t, shouldGenerate: false, themeCount } }));\n}"
      },
      "id": "f79adf86-53ed-4464-84bf-a405a5c425af",
      "name": "CheckThemesCount",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        -144
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "if-theme-count-check",
              "leftValue": "={{ $json.shouldGenerate }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5614a702-a9ef-44f2-9534-e66589aae07d",
      "name": "IF_ThemeGeneration",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -464,
        -144
      ]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_themes",
          "mode": "name"
        },
        "options": {}
      },
      "id": "8c23a211-e63d-4718-98c6-9917f27b704f",
      "name": "GetAllThemes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -144,
        -352
      ],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const allThemes = $items('GetAllThemes')[0].json;\nconst existingThemes = $input.all().map(item => item.json);\n\n// æ—¢å­˜ãƒ†ãƒ¼ãƒã®æœ€å¤§Noã‚’å–å¾—\nlet maxNo = 0;\nif (existingThemes.length > 0) {\n  existingThemes.forEach(theme => {\n    const no = parseInt(theme.no || '0', 10);\n    if (no > maxNo) maxNo = no;\n  });\n}\nconst startNo = maxNo + 1;\n\n// æ—¢å­˜ãƒ†ãƒ¼ãƒä¸€è¦§ã‚’CSVå½¢å¼ã§æº–å‚™\nconst existingThemesCSV = existingThemes\n  .map(t => `${t.no || ''},${t.level || ''},${t.theme || ''}`)\n  .join('\\n');\n\n// ç”Ÿæˆæ•°ã¨ãƒ¬ãƒ™ãƒ«é…åˆ†\nconst generateCount = 50;\nconst levelDistribution = 'åˆå¿ƒè€…å‘ã‘15ä»¶ï¼ä¸­ç´šè€…ä»¥ä¸Šå‘ã‘20ä»¶ï¼ä¸Šç´šè€…å‘ã‘10ä»¶ï¼è¶…ãƒã‚¤æ´»ç‰¹åŒ–5ä»¶';\n\nconst prompt = `ã‚ãªãŸã¯ã€ç”Ÿæ´»ã‚’è±Šã‹ã«ã™ã‚‹ç¯€ç´„ãƒ»ãƒã‚¤æ´»ãƒ»ãŠå¾—æƒ…å ±ã®å°‚é–€ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚\n\n# å‰æ\n- ã™ã§ã« No.1ã€œNo.${maxNo} ã¾ã§ã®ã€ŒãŠå¾—ã‚³ãƒ©ãƒ ãƒ†ãƒ¼ãƒã€ãŒå­˜åœ¨ã—ã¾ã™ã€‚\n- ã“ã‚Œã‚‰ã¨é‡è¤‡ã—ãªã„ã€æ–°ã—ã„ã‚³ãƒ©ãƒ ãƒ†ãƒ¼ãƒã‚’è¿½åŠ ã§ä½œæˆã—ã¾ã™ã€‚\n\n# ä»Šå›ã®ç›®çš„\n- æ—¢å­˜ãƒ†ãƒ¼ãƒã¨è¢«ã‚‰ãªã„ã€Œæ–°ã—ã„ã‚³ãƒ©ãƒ ãƒ†ãƒ¼ãƒã€ã‚’ ${generateCount}ä»¶ ç”Ÿæˆã—ã¾ã™ã€‚\n- No.ã¯ ${startNo} ã‹ã‚‰å§‹ã‚ã¦ã€é€£ç•ªã§ä»˜ä¸ã—ã¾ã™ã€‚\n- ãƒ¬ãƒ™ãƒ«é…åˆ†: ${levelDistribution}\n\n# æ—¢å­˜ãƒ†ãƒ¼ãƒä¸€è¦§ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰\n\nNo,ãƒ¬ãƒ™ãƒ«,ã‚¿ã‚¤ãƒˆãƒ«\n${existingThemesCSV}\n\n# ãƒ†ãƒ¼ãƒè¨­è¨ˆãƒ«ãƒ¼ãƒ«\n- ã‚¸ãƒ£ãƒ³ãƒ«ã¯ã€Œæ—¥å¸¸ç”Ÿæ´»ãƒ»è²·ã„ç‰©ãƒ»æ—…è¡Œãƒ»ãŠé‡‘ãƒ»ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãƒ»ãƒã‚¤ãƒ³ãƒˆãƒ»æ™‚çŸ­ã€ãªã©ã‚’å¹…åºƒãå«ã‚ã‚‹ã€‚\n- æ—¢å­˜ãƒ†ãƒ¼ãƒã¨åŒã˜ãƒ»é¡ä¼¼ã®åˆ‡ã‚Šå£ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã€ã§ãã‚‹é™ã‚Šé‡è¤‡ã‚’é¿ã‘ã‚‹ã€‚\n- èª­è€…ã®é–¢å¿ƒã‚’å¼•ã\"ç‹¬è‡ªæ€§\"ã®ã‚ã‚‹ãƒ†ãƒ¼ãƒã‚’å¿…ãšå«ã‚ã‚‹ã€‚\n- ã‚¿ã‚¤ãƒˆãƒ«ã¯çŸ­ãã€ã‚­ãƒ£ãƒƒãƒãƒ¼ã«ã™ã‚‹ã€‚\n- å°‚é–€ç”¨èªã¯ã§ãã‚‹ã ã‘é¿ã‘ã€ä¸€èˆ¬ã®èª­è€…ã«ã‚‚ã‚ã‹ã‚‹èªå½™ã‚’ä¸­å¿ƒã«ã™ã‚‹ã€‚\n- é•æ³•è¡Œç‚ºã‚„è¦ç´„é•åã«ã¤ãªãŒã‚‹å†…å®¹ã¯å«ã‚ãªã„ã€‚\n\n# ãƒ¬ãƒ™ãƒ«ã”ã¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸\n- åˆå¿ƒè€…å‘ã‘: ã€ŒåŸºç¤çŸ¥è­˜ã€ã€Œå…¥é–€ã€ã€Œä»Šæ—¥ã‹ã‚‰ã§ãã‚‹ç°¡å˜ãƒ†ã‚¯ã€ã€Œå¤±æ•—ã—ã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆã®æ•´ç†ã€ãŒä¸­å¿ƒã€‚\n- ä¸­ç´šè€…ä»¥ä¸Šå‘ã‘: ã€Œæ¯”è¼ƒã€ã€Œæˆ¦ç•¥ã€ã€Œçµ„ã¿åˆã‚ã›ã€ã€Œå¹´é–“è¨ˆç”»ã€ãªã©ã€ä¸€æ®µæ·±ã„è¦–ç‚¹ã‚’å…¥ã‚Œã‚‹ã€‚\n- ä¸Šç´šè€…å‘ã‘: ã€Œä»•çµ„ã¿åŒ–ã€ã€Œæ•°å€¤ç®¡ç†ï¼ˆé‚„å…ƒç‡ãƒ»æ™‚é–“å˜ä¾¡ï¼‰ã€ã€Œè¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹æ¨ªæ–­ã€ãªã©é«˜åº¦ãªå†…å®¹ã€‚\n- è¶…ãƒã‚¤æ´»ç‰¹åŒ–: ãƒã‚¤ãƒ³ãƒˆå¤šé‡å–ã‚Šãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æ´»ç”¨ãƒ»å¤±åŠ¹ç®¡ç†ãƒ»ç¨é‡‘æ”¯æ‰•ã„ã§ã®ãƒã‚¤ãƒ³ãƒˆç²å¾—ãªã©ã€ãƒã‚¤æ´»ã«å¼·ãç‰¹åŒ–ã—ãŸãƒãƒ‹ã‚¢å‘ã‘ãƒ†ãƒ¼ãƒã‚’ä¸­å¿ƒã«ã™ã‚‹ã€‚\n\n# å‡ºåŠ›å½¢å¼ï¼ˆé‡è¦ï¼‰\n- å‡ºåŠ›ã¯ **CSVå½¢å¼ã®ã¿** ã¨ã—ã€1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€è¡Œã¨ã—ã¾ã™ã€‚\n- 1è¡Œç›®: No,ãƒ¬ãƒ™ãƒ«,ã‚¿ã‚¤ãƒˆãƒ«\n- 2è¡Œç›®ä»¥é™: No,ãƒ¬ãƒ™ãƒ«,ã‚¿ã‚¤ãƒˆãƒ« ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ ${generateCount}è¡Œåˆ† å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n- No ã¯ ${startNo} ã‹ã‚‰å§‹ã‚ã¦ã€1ãšã¤å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚\n- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ\\`\\`\\`ï¼‰ã‚„èª¬æ˜æ–‡ã€æ—¥æœ¬èªã«ã‚ˆã‚‹å‰ç½®ããƒ»ã‚ã¨ãŒããªã©ã€CSVä»¥å¤–ã®æ–‡å­—ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„ã“ã¨ã€‚\n\nOUTPUT ONLY THE CSV - START NOW:`;\n\nreturn [{ json: { prompt, startNo, generateCount, existingThemesCount: existingThemes.length } }];"
      },
      "id": "8be1cecd-b7c1-4455-9273-62d7c83c7653",
      "name": "BuildThemeGenerationPrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32,
        -352
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.prompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        224,
        -352
      ],
      "id": "91e78d12-be73-4e5e-b5c3-d9a11a13a924",
      "name": "GenerateNewThemes",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rawText = $json.content.parts[0].text;\n\n// CSVå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º\nlet csvText = rawText.trim()\n  .replace(/^```csv\\s*/i, '')\n  .replace(/^```\\s*/i, '')\n  .replace(/\\s*```$/i, '')\n  .trim();\n\n// ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ‡ãƒ¼ã‚¿è¡Œã®ã¿å–å¾—\nconst lines = csvText.split('\\n').filter(line => line.trim());\nconst dataLines = lines.slice(1); // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤å¤–\n\nconst themes = [];\n\nfor (const line of dataLines) {\n  // CSVè§£æï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰\n  const parts = line.split(',').map(p => p.trim());\n  if (parts.length >= 3) {\n    const no = parts[0];\n    const level = parts[1];\n    const theme = parts.slice(2).join(','); // ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚«ãƒ³ãƒãŒå«ã¾ã‚Œã‚‹å ´åˆã«å¯¾å¿œ\n    \n    themes.push({\n      no: no,\n      level: level,\n      theme: theme,\n      used: 'FALSE',\n      used_at: ''\n    });\n  }\n}\n\nconsole.log(`âœ… ${themes.length}ä»¶ã®ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¾ã—ãŸ`);\n\nreturn themes.map(t => ({ json: t }));"
      },
      "id": "01ea6161-f66b-4404-bee5-2f625bf448c7",
      "name": "ParseThemesCSV",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        -352
      ]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_themes",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "no": "={{ $json.no }}",
            "level": "={{ $json.level }}",
            "theme": "={{ $json.theme }}",
            "used": "={{ $json.used }}",
            "used_at": "={{ $json.used_at }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "no",
              "displayName": "no",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "level",
              "displayName": "level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "theme",
              "displayName": "theme",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "used",
              "displayName": "used",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "used_at",
              "displayName": "used_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "ea26fbd2-c636-4207-9d2c-09d8c2b2dabf",
      "name": "AppendThemesToSheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        688,
        -352
      ],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "console.log('âœ… æ–°è¦ãƒ†ãƒ¼ãƒã®è¿½åŠ ãŒå®Œäº†ã—ã¾ã—ãŸã€‚é€šå¸¸ãƒ•ãƒ­ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚');\nreturn [{ json: { message: 'Themes generated successfully', retry: true } }];"
      },
      "id": "ff013334-87a6-43c9-b8b8-2580a74add09",
      "name": "AfterThemeGeneration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -352
      ]
    },
    {
      "parameters": {
        "jsCode": "const theme = $json.theme;\nconst level = $json.level;\nconst themeNo = $json.no;\n\n// ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±ã‚’å–å¾—ï¼ˆAnalyzeTrendsã‹ã‚‰ï¼‰\nlet trendContext = '';\ntry {\n  const trendInfo = $items('AnalyzeTrends')[0]?.json;\n  if (trendInfo && trendInfo.dealCount > 0) {\n    trendContext = `\n# ãŠå¾—æƒ…å ±ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»2é€±é–“ï¼‰\n- äººæ°—ã‚«ãƒ†ã‚´ãƒª: ${trendInfo.topCategories.join(', ') || 'ãªã—'}\n- ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ã‚°: ${trendInfo.topTags.slice(0, 5).join(', ') || 'ãªã—'}\n- äººæ°—ã‚µãƒ¼ãƒ“ã‚¹: ${trendInfo.topServices.join(', ') || 'ãªã—'}\n- é«˜é‚„å…ƒç‡ã‚«ãƒ†ã‚´ãƒª: ${trendInfo.trendingDiscountCategories.join(', ') || 'ãªã—'}\n\nè¨˜äº‹ä½œæˆæ™‚ã®æ³¨æ„:\n- ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±ã‚’è‡ªç„¶ã«æœ¬æ–‡ã«çµ„ã¿è¾¼ã‚€ï¼ˆç„¡ç†ã«å«ã‚ã‚‹å¿…è¦ã¯ãªã„ï¼‰\n- èª­è€…ã®é–¢å¿ƒãŒé«˜ã„ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’é©åº¦ã«åæ˜ ã™ã‚‹\n`;\n  }\n} catch (e) {\n  console.log('ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±ã®å–å¾—ã«å¤±æ•—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', e.message);\n}\n\nconst prompt = `\nYou are a JSON generation specialist. Output ONLY a valid JSON object.\n\nãƒ†ãƒ¼ãƒ: ${theme}\nãƒ¬ãƒ™ãƒ«: ${level}\n${trendContext}\n\nIMPORTANT RULES:\n1. Output ONLY the JSON object - NO markdown code blocks, NO explanations\n2. Start directly with { and end with }\n3. Use \\\\n for line breaks in content_markdown\n4. Properly escape all special characters (quotes, backslashes)\n5. Keep content_markdown between 2000-3000 characters\n6. Use <mark>text</mark> for important highlights (yellow background + yellow underline)\n7. Use **bold** for emphasis\n8. Add [IMAGE: description] markers where images would enhance understanding\n\nJSON Structure:\n{\n  \"title\": \"article title (30-40 chars)\",\n  \"description\": \"article summary (80-120 chars)\",\n  \"content_markdown\": \"# Heading1\\\\n\\\\nContent...\\\\n\\\\n## Heading2\\\\n\\\\nMore content...\",\n  \"category\": \"one of: ãƒã‚¤ãƒ³ãƒˆæ´»ç”¨, ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰, ç¯€ç´„è¡“, æ—…è¡Œ, ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹, å®¶è¨ˆç®¡ç†, ãµã‚‹ã•ã¨ç´ç¨\",\n  \"tags\": \"tag1,tag2,tag3\"\n}\n\nArticle Structure for content_markdown:\n1. å°å…¥ï¼ˆèª­è€…ã®æ‚©ã¿ã¨è§£æ±ºç­–ï¼‰\n2. åŸºæœ¬ã®è€ƒãˆæ–¹\n3. å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—\n4. æ³¨æ„ç‚¹ãƒ»ã‚ˆãã‚ã‚‹å¤±æ•—\n5. ã¾ã¨ã‚\n\nContent Enhancement Guidelines:\n- Use **bold** for key terms and important numbers (2-3 per section)\n- Use <mark>highlight</mark> for critical information that MUST be remembered\n  - Apply the test preparation strategy: highlight what you would underline when studying\n  - Criteria for highlighting (like test prep):\n    * Core concepts that everything else builds upon\n    * Common mistakes or critical warnings (\"ã€œã—ã¦ã¯ã„ã‘ãªã„\")\n    * Key numbers, percentages, or deadlines that directly impact results\n    * Action steps that are essential for success\n  - DO NOT highlight:\n    * General background information\n    * Examples or supplementary details\n    * Redundant information\n  - Example: <mark>ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒç‡20%ã¯æœŸé–“é™å®šã§11æœˆ30æ—¥ã¾ã§</mark>\n  - Limit to 1-3 highlights per article for maximum impact\n  - The system will automatically add yellow background + yellow underline\n- Add [IMAGE: brief description] where visuals would help (e.g., flow charts, comparison tables, step illustrations)\n  - Example: [IMAGE: ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒç‡ã®æ¯”è¼ƒè¡¨]\n  - Place markers at natural breaks, not mid-paragraph\n- Use bullet points (- or *) for lists\n- Use numbered lists (1. 2. 3.) for sequential steps\n\nOUTPUT ONLY THE JSON - START NOW:\n`.trim();\n\nreturn [{ json: { prompt, theme, level, themeNo } }];"
      },
      "id": "c73a9a64-5895-4062-b8a2-b530571d37c2",
      "name": "BuildArticlePrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        336
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.prompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -256,
        336
      ],
      "id": "6d346ff5-2557-4b2f-9a0b-e9af1fc32373",
      "name": "GenerateArticle",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rawText = $json.content.parts[0].text;\n\n// Step 1: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¨ä½™è¨ˆãªãƒ†ã‚­ã‚¹ãƒˆã‚’é™¤å»\nlet jsonString = rawText.trim()\n  .replace(/^```json\\s*/i, '')\n  .replace(/^```\\s*/i, '')\n  .replace(/\\s*```$/i, '')\n  .trim();\n\n// Step 2: JSONã®é–‹å§‹ãƒ»çµ‚äº†ä½ç½®ã‚’æ¢ã™\nconst jsonStart = jsonString.indexOf('{');\nconst jsonEnd = jsonString.lastIndexOf('}');\n\nif (jsonStart === -1 || jsonEnd === -1) {\n  console.error('âŒ JSONæ§‹é€ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');\n  throw new Error('JSONã® { } ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');\n}\n\njsonString = jsonString.substring(jsonStart, jsonEnd + 1);\n\nconsole.log('ğŸ“ JSONæŠ½å‡ºï¼ˆé•·ã•: ' + jsonString.length + 'æ–‡å­—ï¼‰');\nconsole.log('ğŸ“ JSONå…ˆé ­500æ–‡å­—:', jsonString.substring(0, 500));\n\n// Step 3: ã‚ˆã‚Šç©æ¥µçš„ãªJSONä¿®æ­£å‡¦ç†\nfunction sanitizeJSON(str) {\n  let result = str;\n  \n  // æ–¹æ³•1: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã«å‡¦ç†ï¼ˆã‚ˆã‚Šå®‰å…¨ï¼‰\n  // \"content_markdown\":\"...\" ã®éƒ¨åˆ†ã‚’æ¢ã—ã¦ä¿®æ­£\n  \n  // ã¾ãšã€content_markdownã®é–‹å§‹ä½ç½®ã‚’æ¢ã™\n  const cmStart = result.indexOf('\"content_markdown\"');\n  if (cmStart === -1) {\n    console.log('âš ï¸ content_markdownãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');\n    return result;\n  }\n  \n  // content_markdownã®å€¤ã®é–‹å§‹ä½ç½®ï¼ˆ: \"ã®å¾Œï¼‰\n  const valueStart = result.indexOf('\"', cmStart + 18) + 1; // \"content_markdown\"ã®å¾Œã®\"\n  \n  // å€¤ã®çµ‚äº†ä½ç½®ã‚’æ¢ã™ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ãªã„\"ã‚’æ¢ã™ï¼‰\n  let valueEnd = valueStart;\n  let escapeCount = 0;\n  \n  for (let i = valueStart; i < result.length; i++) {\n    if (result[i] === '\\\\') {\n      escapeCount++;\n    } else if (result[i] === '\"') {\n      // å¶æ•°å€‹ã®ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã®å¾Œã®\"ã¯çµ‚äº†\n      if (escapeCount % 2 === 0) {\n        valueEnd = i;\n        break;\n      }\n      escapeCount = 0;\n    } else {\n      escapeCount = 0;\n    }\n  }\n  \n  console.log('ğŸ“„ content_markdownä½ç½®: ' + valueStart + ' ~ ' + valueEnd);\n  \n  // content_markdownã®å€¤ã‚’æŠ½å‡º\n  let content = result.substring(valueStart, valueEnd);\n  console.log('ğŸ“„ content_markdowné•·ã•: ' + content.length);\n  \n  // ä¿®æ­£å‡¦ç†\n  // 1. æ—¢ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’ä¿è­·\n  content = content.replace(/\\\\n/g, '<<<NL>>>');\n  content = content.replace(/\\\\\"/g, '<<<QT>>>');\n  content = content.replace(/\\\\\\\\/g, '<<<BS>>>');\n  \n  // 2. å®Ÿéš›ã®æ”¹è¡Œã‚’\\nã«\n  content = content.replace(/\\r?\\n/g, '\\\\n');\n  \n  // 3. ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ãªã„\"ã‚’\\\"ã«ï¼ˆã“ã‚ŒãŒé‡è¦ï¼‰\n  // ãŸã ã—ã€æ—¢ã«ä¿è­·ã—ãŸã‚‚ã®ã¯é™¤å¤–\n  content = content.replace(/\"/g, '\\\\\"');\n  \n  // 4. ã‚¿ãƒ–ã‚’ç©ºç™½ã«\n  content = content.replace(/\\t/g, '  ');\n  \n  // 5. ä¿è­·ã—ãŸã‚‚ã®ã‚’æˆ»ã™\n  content = content.replace(/<<<NL>>>/g, '\\\\n');\n  content = content.replace(/<<<QT>>>/g, '\\\\\"');\n  content = content.replace(/<<<BS>>>/g, '\\\\\\\\');\n  \n  // å…ƒã®æ–‡å­—åˆ—ã§ç½®æ›\n  result = result.substring(0, valueStart) + content + result.substring(valueEnd);\n  \n  return result;\n}\n\nlet article;\nlet parseAttempts = 0;\n\n// Step 4: ãƒ‘ãƒ¼ã‚¹è©¦è¡Œï¼ˆè¤‡æ•°ã®æ–¹æ³•ã‚’è©¦ã™ï¼‰\nwhile (parseAttempts < 3) {\n  parseAttempts++;\n  \n  try {\n    if (parseAttempts === 1) {\n      // è©¦è¡Œ1: ãã®ã¾ã¾ãƒ‘ãƒ¼ã‚¹\n      console.log('ğŸ”„ ãƒ‘ãƒ¼ã‚¹è©¦è¡Œ1: é€šå¸¸');\n      article = JSON.parse(jsonString);\n    } else if (parseAttempts === 2) {\n      // è©¦è¡Œ2: ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¦ãƒ‘ãƒ¼ã‚¹\n      console.log('ğŸ”„ ãƒ‘ãƒ¼ã‚¹è©¦è¡Œ2: ã‚µãƒ‹ã‚¿ã‚¤ã‚º');\n      const sanitized = sanitizeJSON(jsonString);\n      article = JSON.parse(sanitized);\n    } else {\n      // è©¦è¡Œ3: ã‚ˆã‚Šç©æ¥µçš„ãªä¿®æ­£\n      console.log('ğŸ”„ ãƒ‘ãƒ¼ã‚¹è©¦è¡Œ3: ç©æ¥µçš„ä¿®æ­£');\n      let fixed = sanitizeJSON(jsonString);\n      // ã‚¿ãƒ–ã‚’å‰Šé™¤\n      fixed = fixed.replace(/\\t/g, ' ');\n      article = JSON.parse(fixed);\n    }\n    \n    console.log('âœ… JSONè§£ææˆåŠŸï¼ˆè©¦è¡Œ' + parseAttempts + 'ï¼‰');\n    break;\n    \n  } catch (e) {\n    console.error('âŒ è©¦è¡Œ' + parseAttempts + 'å¤±æ•—:', e.message);\n    \n    // ã‚¨ãƒ©ãƒ¼ä½ç½®ã‚’å¸¸ã«è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰\n    const match = e.message.match(/position (\\d+)/);\n    if (match) {\n      const pos = parseInt(match[1]);\n      const start = Math.max(0, pos - 200);\n      const end = Math.min(jsonString.length, pos + 200);\n      console.error('ğŸ“ ã‚¨ãƒ©ãƒ¼ä½ç½®: ' + pos + ' / ' + jsonString.length);\n      console.error('ğŸ“ å‰å¾Œ400æ–‡å­—:', jsonString.substring(start, end));\n      \n      // ã‚¨ãƒ©ãƒ¼ä½ç½®ã®æ–‡å­—ã‚’è¡¨ç¤º\n      if (pos < jsonString.length) {\n        console.error('ğŸ“ ã‚¨ãƒ©ãƒ¼ä½ç½®ã®æ–‡å­—: [' + jsonString[pos] + '] (charCode: ' + jsonString.charCodeAt(pos) + ')');\n        console.error('ğŸ“ ã‚¨ãƒ©ãƒ¼å‰10æ–‡å­—: [' + jsonString.substring(Math.max(0, pos-10), pos) + ']');\n        console.error('ğŸ“ ã‚¨ãƒ©ãƒ¼å¾Œ10æ–‡å­—: [' + jsonString.substring(pos, Math.min(jsonString.length, pos+10)) + ']');\n      }\n    }\n    \n    if (parseAttempts === 3) {\n      throw new Error('JSONè§£æå¤±æ•—ï¼ˆå…¨è©¦è¡Œçµ‚äº†ï¼‰: ' + e.message);\n    }\n  }\n}\n\nconst result = {\n  ...article,\n  theme: $items('BuildArticlePrompt')[0].json.theme,\n  level: $items('BuildArticlePrompt')[0].json.level,\n  themeNo: $items('BuildArticlePrompt')[0].json.themeNo\n};\n\nconsole.log('âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†:', result.title);\n\nreturn [{ json: result }];"
      },
      "id": "b36b07f4-bec6-4ffb-8d6a-6ce83cff1106",
      "name": "ParseArticleJSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        32,
        336
      ]
    },
    {
      "parameters": {
        "jsCode": "const article = $json;\n\nconst qualityCheckPrompt = `ã‚ãªãŸã¯ã€ç¯€ç´„ãƒ»ãƒã‚¤æ´»ãƒ»ãŠå¾—æƒ…å ±ã®å°‚é–€ãƒ©ã‚¤ã‚¿ãƒ¼å…¼ç·¨é›†è€…ã§ã™ã€‚\n\nä»¥ä¸‹ã®è¨˜äº‹ã«å¯¾ã—ã¦ã€ä»¥ä¸‹ã®3ã¤ã®è¦³ç‚¹ã‹ã‚‰å“è³ªãƒã‚§ãƒƒã‚¯ã¨æ”¹å–„ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ï¼š\n\n1. **æ–‡ç« æ ¡æ­£**: èª¤å­—è„±å­—ã€æ–‡æ³•ã‚¨ãƒ©ãƒ¼ã€èª­ã¿ã‚„ã™ã•ã®æ”¹å–„\n2. **SEOæœ€é©åŒ–**: ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30-40æ–‡å­—ï¼‰ã€descriptionï¼ˆ80-120æ–‡å­—ï¼‰ã€ã‚¿ã‚°ã®æœ€é©åŒ–\n3. **é‡è¤‡ãƒã‚§ãƒƒã‚¯**: æ—¢å­˜ã®é¡ä¼¼è¨˜äº‹ã¨ã®é‡è¤‡åº¦è©•ä¾¡ï¼ˆ0-100ã€100ãŒå®Œå…¨é‡è¤‡ï¼‰\n\n# ãƒã‚§ãƒƒã‚¯å¯¾è±¡è¨˜äº‹\n\nã‚¿ã‚¤ãƒˆãƒ«: ${article.title}\nèª¬æ˜: ${article.description}\nã‚«ãƒ†ã‚´ãƒª: ${article.category}\nã‚¿ã‚°: ${article.tags}\næœ¬æ–‡ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰: ${article.content_markdown.substring(0, 500)}...\n\n# å‡ºåŠ›å½¢å¼ï¼ˆJSONã®ã¿ï¼‰\n\n{\n  \"corrections\": {\n    \"title\": \"æ”¹å–„å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¤‰æ›´ãŒãªã„å ´åˆã¯å…ƒã®ã¾ã¾ï¼‰\",\n    \"description\": \"æ”¹å–„å¾Œã®èª¬æ˜ï¼ˆå¤‰æ›´ãŒãªã„å ´åˆã¯å…ƒã®ã¾ã¾ï¼‰\",\n    \"tags\": \"æ”¹å–„å¾Œã®ã‚¿ã‚°ï¼ˆå¤‰æ›´ãŒãªã„å ´åˆã¯å…ƒã®ã¾ã¾ï¼‰\",\n    \"content_improvements\": \"æœ¬æ–‡ã®æ”¹å–„ç‚¹ï¼ˆç®‡æ¡æ›¸ãã€å¤‰æ›´ãŒãªã„å ´åˆã¯ç©ºæ–‡å­—ï¼‰\"\n  },\n  \"seo_score\": 85,\n  \"duplicate_score\": 15,\n  \"overall_quality\": \"good\",\n  \"recommendations\": [\"æ¨å¥¨äº‹é …1\", \"æ¨å¥¨äº‹é …2\"]\n}\n\né‡è¦:\n- å‡ºåŠ›ã¯JSONã®ã¿ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãªã—ï¼‰\n- duplicate_scoreãŒ50ä»¥ä¸Šã®å ´åˆã€å¤§å¹…ãªå¤‰æ›´ã‚’æ¨å¥¨\n- SEOæœ€é©åŒ–ã¯æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ã®ç™ºè¦‹æ€§ã‚’é‡è¦–\n- æ–‡ç« æ ¡æ­£ã¯èª­ã¿ã‚„ã™ã•ã¨æ­£ç¢ºæ€§ã‚’é‡è¦–\n\nOUTPUT ONLY THE JSON:`;\n\nreturn [{ json: { ...article, qualityCheckPrompt } }];"
      },
      "id": "4ee11f6a-6d88-41c1-8c1f-1841536dde7e",
      "name": "BuildQualityCheckPrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        336
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.qualityCheckPrompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        432,
        336
      ],
      "id": "b9f9b1d4-8d04-4c57-92b3-21d67cd09882",
      "name": "CallGeminiForQualityCheck",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const article = $items('ParseArticleJSON')[0].json;\nconst qualityResultText = $json.content.parts[0].text;\n\n// JSONæŠ½å‡º\nlet qualityJSON = qualityResultText.trim()\n  .replace(/^```json\\s*/i, '')\n  .replace(/^```\\s*/i, '')\n  .replace(/\\s*```$/i, '')\n  .trim();\n\nconst jsonStart = qualityJSON.indexOf('{');\nconst jsonEnd = qualityJSON.lastIndexOf('}');\nif (jsonStart !== -1 && jsonEnd !== -1) {\n  qualityJSON = qualityJSON.substring(jsonStart, jsonEnd + 1);\n}\n\nlet qualityResult;\ntry {\n  qualityResult = JSON.parse(qualityJSON);\n} catch (e) {\n  console.error('å“è³ªãƒã‚§ãƒƒã‚¯çµæœã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e.message);\n  // ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯å…ƒã®è¨˜äº‹ã‚’ãã®ã¾ã¾è¿”ã™\n  return [{ json: article }];\n}\n\n// é‡è¤‡ã‚¹ã‚³ã‚¢ãŒé«˜ã„å ´åˆã¯è­¦å‘Š\nif (qualityResult.duplicate_score >= 50) {\n  console.warn(`âš ï¸ é‡è¤‡ã‚¹ã‚³ã‚¢ãŒé«˜ã„ã§ã™: ${qualityResult.duplicate_score}`);\n}\n\n// æ”¹å–„ã‚’é©ç”¨ï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰\nconst improvedArticle = { ...article };\n\nif (qualityResult.corrections) {\n  if (qualityResult.corrections.title && qualityResult.corrections.title !== article.title) {\n    console.log('ğŸ“ ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ”¹å–„:', article.title, 'â†’', qualityResult.corrections.title);\n    improvedArticle.title = qualityResult.corrections.title;\n  }\n  \n  if (qualityResult.corrections.description && qualityResult.corrections.description !== article.description) {\n    console.log('ğŸ“ èª¬æ˜ã‚’æ”¹å–„');\n    improvedArticle.description = qualityResult.corrections.description;\n  }\n  \n  if (qualityResult.corrections.tags && qualityResult.corrections.tags !== article.tags) {\n    console.log('ğŸ“ ã‚¿ã‚°ã‚’æ”¹å–„');\n    improvedArticle.tags = qualityResult.corrections.tags;\n  }\n}\n\n// å“è³ªã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ï¼ˆãƒ­ã‚°ç”¨ï¼‰\nconsole.log(`âœ… å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº† - SEO: ${qualityResult.seo_score}, é‡è¤‡: ${qualityResult.duplicate_score}`);\n\nreturn [{ json: improvedArticle }];"
      },
      "id": "e3a934a4-34da-43cf-93d0-1479b1ebca8a",
      "name": "ApplyQualityImprovements",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        336
      ]
    },
    {
      "parameters": {
        "jsCode": "const articleData = $json;\n\n// æ—¥æœ¬èªå¯¾å¿œã®ã‚¹ãƒ©ãƒƒã‚°ç”Ÿæˆï¼ˆlib/columns.tsã¨å®Œå…¨ä¸€è‡´ï¼‰\nconst slug = articleData.title\n  .toLowerCase()\n  .replace(/[^a-z0-9\\u3040-\\u309f\\u30a0-\\u30ff\\u4e00-\\u9faf]+/g, '-')\n  .replace(/^-+|-+$/g, '');\n\nconst content_html = articleData.content_markdown\n  .replace(/^### (.*$)/gim, '<h3>$1</h3>')\n  .replace(/^## (.*$)/gim, '<h2>$1</h2>')\n  .replace(/^# (.*$)/gim, '<h1>$1</h1>')\n  .replace(/\\*\\*(.*?)\\*\\*/gim, '<strong>$1</strong>')\n  .replace(/\\*(.*?)\\*/gim, '<em>$1</em>')\n  .replace(/\\n\\n/gim, '</p><p>')\n  .replace(/\\n/gim, '<br>');\n\nconst columnData = {\n  slug: slug,\n  title: articleData.title,\n  description: articleData.description,\n  content_markdown: articleData.content_markdown,\n  content_html: '<p>' + content_html + '</p>',\n  category: articleData.category,\n  tags: articleData.tags,\n  thumbnail_url: '',\n  author: 'TokuSearch AI',\n  status: 'published',\n  is_featured: false,\n  theme: articleData.theme,\n  themeNo: articleData.themeNo\n};\n\nconsole.log('âœ… ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†:', columnData.title);\nconsole.log('ğŸ“ ç”Ÿæˆã•ã‚ŒãŸã‚¹ãƒ©ãƒƒã‚°:', slug);\n\nreturn [{ json: columnData }];"
      },
      "id": "ddfff8d7-7b19-4ab0-82d3-73763fe091b3",
      "name": "PrepareColumnData",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        336
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://tokusearch.vercel.app/api/admin/columns",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "c5b23ddd-8d5e-4278-928e-34f3a67b26ee",
      "name": "PostColumn",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1328,
        336
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "RT6aq4TB1Vj8V2Tn",
          "name": "Credential Name"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 348743133,
          "mode": "list",
          "cachedResultName": "column_themes",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14/edit#gid=348743133"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "no": "={{$items('RandomThemeSelection')[0].json.no}}",
            "used": "TRUE",
            "used_at": "={{new Date().toISOString()}}"
          },
          "matchingColumns": [
            "no"
          ],
          "schema": [
            {
              "id": "no",
              "displayName": "no",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "level",
              "displayName": "level",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "theme",
              "displayName": "theme",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "used",
              "displayName": "used",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "used_at",
              "displayName": "used_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "6c5099d9-0cfa-4788-b66a-9e78bd6e9c86",
      "name": "UpdateThemeUsed",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1120,
        560
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const columnData = $items('PrepareColumnData')[0].json;\n\nconst message = `ğŸ‰ ã‚³ãƒ©ãƒ è‡ªå‹•ç”Ÿæˆå®Œäº†ï¼\n\nã‚¿ã‚¤ãƒˆãƒ«: ${columnData.title}\nã‚«ãƒ†ã‚´ãƒª: ${columnData.category}\nURL: https://tokusearch.vercel.app/columns/${columnData.slug}\n\nâ€»ç”»åƒãªã—ç‰ˆ`;\n\nconsole.log(message);\n\nreturn [{ json: { message, success: true } }];"
      },
      "id": "9ce7f54b-18ae-419e-a032-c37c71a1c771",
      "name": "BuildCompletionMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        560
      ]
    },
    {
      "parameters": {
        "content": "ã€Aæ©Ÿèƒ½ã€‘ãƒ†ãƒ¼ãƒè‡ªå‹•ç”Ÿæˆ\n\næœªä½¿ç”¨ãƒ†ãƒ¼ãƒãŒ0ä»¶ã®å ´åˆã€è‡ªå‹•çš„ã«æ–°è¦ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚\n\n1. æ—¢å­˜ãƒ†ãƒ¼ãƒä¸€è¦§ã‚’å–å¾—\n2. Geminiã§æ–°è¦ãƒ†ãƒ¼ãƒ50ä»¶ã‚’ç”Ÿæˆ\n3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½åŠ \n4. é€šå¸¸ãƒ•ãƒ­ãƒ¼ã«æˆ»ã‚‹",
        "height": 384,
        "width": 656
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -944,
        -384
      ],
      "id": "37a1c32e-2276-4b99-9ddb-60aedf95bf6c",
      "name": "Sticky Note - Aæ©Ÿèƒ½"
    },
    {
      "parameters": {
        "content": "ã€Gæ©Ÿèƒ½ã€‘ãŠå¾—ç³»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ\n\néå»2é€±é–“ã®ãŠå¾—æƒ…å ±ã‚’åˆ†æã—ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã™ã€‚\n\n- äººæ°—ã‚«ãƒ†ã‚´ãƒªï¼ˆä¸Šä½3ï¼‰\n- ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ã‚°ï¼ˆä¸Šä½10ï¼‰\n- äººæ°—ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¸Šä½5ï¼‰\n- é«˜é‚„å…ƒç‡ã‚«ãƒ†ã‚´ãƒª\n\nâ€»Geminiä¸ä½¿ç”¨ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰",
        "height": 472,
        "width": 656,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -976,
        224
      ],
      "id": "3eee3a3f-6957-4662-80ff-c3cb3cf16854",
      "name": "Sticky Note - Gæ©Ÿèƒ½"
    },
    {
      "parameters": {
        "content": "ã€ãƒ¡ã‚¤ãƒ³ã€‘è¨˜äº‹ç”Ÿæˆ\n\n1. ãƒ†ãƒ¼ãƒã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ\n2. ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±ã‚’å«ã‚€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰\n3. Geminiã§è¨˜äº‹ç”Ÿæˆ\n4. JSONè§£æ",
        "height": 672,
        "width": 1120,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -960,
        64
      ],
      "id": "9e8c8a91-87f0-4fab-ab50-5c0c3879bedc",
      "name": "Sticky Note - ãƒ¡ã‚¤ãƒ³"
    },
    {
      "parameters": {
        "content": "ã€Dæ©Ÿèƒ½ã€‘å“è³ªå‘ä¸Š\n\nç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã®å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ãƒ»æ”¹å–„ã—ã¾ã™ã€‚\n\n1. æ–‡ç« æ ¡æ­£ï¼ˆèª¤å­—è„±å­—ãƒ»æ–‡æ³•ï¼‰\n2. SEOæœ€é©åŒ–ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ã‚¿ã‚°ï¼‰\n3. é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜è¨˜äº‹ã¨ã®é¡ä¼¼åº¦ï¼‰\n\nâ€»é‡è¤‡ã‚¹ã‚³ã‚¢50ä»¥ä¸Šã§è­¦å‘Š",
        "height": 664,
        "width": 720,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        208,
        64
      ],
      "id": "7502c135-fdad-45f5-b97d-5014fb1853a3",
      "name": "Sticky Note - Dæ©Ÿèƒ½"
    },
    {
      "parameters": {
        "content": "ã€æŠ•ç¨¿ãƒ»å®Œäº†ã€‘\n\n1. ã‚³ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆã‚¹ãƒ©ãƒƒã‚°ç”Ÿæˆãƒ»HTMLå¤‰æ›ï¼‰\n2. APIã«æŠ•ç¨¿\n3. ãƒ†ãƒ¼ãƒã‚’ã€Œä½¿ç”¨æ¸ˆã¿ã€ã«æ›´æ–°\n4. å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ",
        "height": 656,
        "width": 704,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1008,
        64
      ],
      "id": "f88cde9d-61fd-461f-a964-4b8a2755aaa5",
      "name": "Sticky Note - æŠ•ç¨¿å®Œäº†"
    }
  ],
  "pinData": {},
  "connections": {
    "ScheduleTrigger": {
      "main": [
        [
          {
            "node": "GetUnusedThemes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetUnusedThemes": {
      "main": [
        [
          {
            "node": "CheckThemesCount",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CheckThemesCount": {
      "main": [
        [
          {
            "node": "IF_ThemeGeneration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_ThemeGeneration": {
      "main": [
        [
          {
            "node": "GetAllThemes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "RandomThemeSelection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetAllThemes": {
      "main": [
        [
          {
            "node": "BuildThemeGenerationPrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildThemeGenerationPrompt": {
      "main": [
        [
          {
            "node": "GenerateNewThemes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GenerateNewThemes": {
      "main": [
        [
          {
            "node": "ParseThemesCSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ParseThemesCSV": {
      "main": [
        [
          {
            "node": "AppendThemesToSheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AppendThemesToSheet": {
      "main": [
        [
          {
            "node": "AfterThemeGeneration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AfterThemeGeneration": {
      "main": [
        [
          {
            "node": "GetUnusedThemes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RandomThemeSelection": {
      "main": [
        [
          {
            "node": "GetRecentDeals",
            "type": "main",
            "index": 0
          },
          {
            "node": "BuildArticlePrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetRecentDeals": {
      "main": [
        [
          {
            "node": "AnalyzeTrends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AnalyzeTrends": {
      "main": [
        [
          {
            "node": "BuildArticlePrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildArticlePrompt": {
      "main": [
        [
          {
            "node": "GenerateArticle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GenerateArticle": {
      "main": [
        [
          {
            "node": "ParseArticleJSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ParseArticleJSON": {
      "main": [
        [
          {
            "node": "BuildQualityCheckPrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildQualityCheckPrompt": {
      "main": [
        [
          {
            "node": "CallGeminiForQualityCheck",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CallGeminiForQualityCheck": {
      "main": [
        [
          {
            "node": "ApplyQualityImprovements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ApplyQualityImprovements": {
      "main": [
        [
          {
            "node": "PrepareColumnData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PrepareColumnData": {
      "main": [
        [
          {
            "node": "PostColumn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostColumn": {
      "main": [
        [
          {
            "node": "UpdateThemeUsed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UpdateThemeUsed": {
      "main": [
        [
          {
            "node": "BuildCompletionMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "89431522-9a67-4727-9a6b-e0134ed17751",
  "meta": {
    "instanceId": "fefffd21e64fa94994bb4bf38b5a050c59f6cf28bd3cad9da0a5804220d9e97f"
  },
  "id": "VzqkMj6Rl8ZylTSC",
  "tags": []
}