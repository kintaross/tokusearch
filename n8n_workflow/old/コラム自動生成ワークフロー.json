{
  "name": "ã‚³ãƒ©ãƒ è‡ªå‹•ç”Ÿæˆï¼†TokuSearchæŠ•ç¨¿",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "days",
              "daysInterval": 1,
              "triggerAtHour": 9,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "id": "a1b2c3d4-schedule-trigger",
      "name": "ScheduleTrigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_themes",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "used",
              "lookupValue": "FALSE"
            }
          ]
        },
        "options": {}
      },
      "id": "b2c3d4e5-get-themes",
      "name": "GetUnusedThemes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [460, 300],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æœªä½¿ç”¨ãƒ†ãƒ¼ãƒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ä»¶é¸æŠ\nconst unusedThemes = $input.all().map(item => item.json);\n\nif (unusedThemes.length === 0) {\n  throw new Error('âŒ æœªä½¿ç”¨ãƒ†ãƒ¼ãƒãŒã‚ã‚Šã¾ã›ã‚“');\n}\n\nconst randomIndex = Math.floor(Math.random() * unusedThemes.length);\nconst selectedTheme = unusedThemes[randomIndex];\n\nconsole.log(`âœ… ãƒ†ãƒ¼ãƒé¸æŠ: ${selectedTheme.theme}`);\n\nreturn [{ json: selectedTheme }];"
      },
      "id": "c3d4e5f6-random-selection",
      "name": "RandomThemeSelection",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "const theme = $json.theme;\nconst level = $json.level;\nconst themeNo = $json.no;\n\nconst prompt = `\nã€ã‚·ã‚¹ãƒ†ãƒ æŒ‡ç¤ºã€‘\nã‚ãªãŸã¯ã€ŒTokuSearchã€ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚\nä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒã§ã€æ—¥æœ¬ã®ãƒã‚¤æ´»ãƒ»ç¯€ç´„ã«é–¢ã™ã‚‹å®Ÿç”¨çš„ãªè¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\nã€ãƒ†ãƒ¼ãƒã€‘\n${theme}\n\nã€ãƒ¬ãƒ™ãƒ«ã€‘\n${level}\n\nã€å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰ã€‘\n{\n  \"title\": \"è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30-40æ–‡å­—ï¼‰\",\n  \"description\": \"è¨˜äº‹ã®æ¦‚è¦ï¼ˆ80-120æ–‡å­—ã€SEOç”¨ï¼‰\",\n  \"content_markdown\": \"æœ¬æ–‡ï¼ˆMarkdownå½¢å¼ã€2000-3000æ–‡å­—ï¼‰\",\n  \"category\": \"ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹: ãƒã‚¤ãƒ³ãƒˆæ´»ç”¨ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€ç¯€ç´„è¡“ã€æ—…è¡Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹ã€å®¶è¨ˆç®¡ç†ã€ãµã‚‹ã•ã¨ç´ç¨ï¼‰\",\n  \"tags\": \"ã‚¿ã‚°1,ã‚¿ã‚°2,ã‚¿ã‚°3ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€3-5å€‹ï¼‰\"\n}\n\nã€è¨˜äº‹æ§‹æˆã€‘\n1. ## å°å…¥ï¼ˆèª­è€…ã®æ‚©ã¿ã€ã“ã®è¨˜äº‹ã§åˆ†ã‹ã‚‹ã“ã¨ï¼‰\n2. ## åŸºæœ¬ã®è€ƒãˆæ–¹ï¼ˆå‰æçŸ¥è­˜ï¼‰\n3. ## å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ‰‹é †ã‚’æ˜ç¢ºã«ï¼‰\n4. ## æ³¨æ„ç‚¹ãƒ»ã‚ˆãã‚ã‚‹å¤±æ•—\n5. ## ã¾ã¨ã‚ï¼ˆè¦ç‚¹ã¨æœ€åˆã®ä¸€æ­©ï¼‰\n\nã€æ–‡å­—æ•°ã€‘: 2000-3000æ–‡å­—\n\nã€é‡è¦ã€‘\n- JSONå½¢å¼ã®ã¿å‡ºåŠ›\n- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ\\`\\`\\`jsonï¼‰ã¯ä¸è¦\n- æ—¥æœ¬èªã®ã¿\n`.trim();\n\nreturn [{ json: { prompt, theme, level, themeNo } }];"
      },
      "id": "d4e5f6a7-article-prompt",
      "name": "BuildArticlePrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.prompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [1120, 300],
      "id": "e5f6a7b8-generate-article",
      "name": "GenerateArticle",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rawText = $json.content.parts[0].text;\n\nconst jsonString = rawText\n  .replace(/^```json\\s*/m, '')\n  .replace(/```$/m, '')\n  .trim();\n\nlet article;\ntry {\n  article = JSON.parse(jsonString);\n} catch (e) {\n  console.error('âŒ JSONè§£æã‚¨ãƒ©ãƒ¼:', jsonString.substring(0, 300));\n  throw new Error('è¨˜äº‹ã®JSONè§£æã«å¤±æ•—');\n}\n\nconst result = {\n  ...article,\n  theme: $items('BuildArticlePrompt')[0].json.theme,\n  level: $items('BuildArticlePrompt')[0].json.level,\n  themeNo: $items('BuildArticlePrompt')[0].json.themeNo\n};\n\nconsole.log('âœ… è¨˜äº‹ç”Ÿæˆå®Œäº†:', result.title);\n\nreturn [{ json: result }];"
      },
      "id": "f6a7b8c9-parse-article",
      "name": "ParseArticleJSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "jsCode": "const theme = $json.theme;\nconst level = $json.level;\n\nconst imagePrompt = `\n${theme}ã«é–¢ã™ã‚‹ã€æ—¥æœ¬ã®ãƒã‚¤æ´»ãƒ»ç¯€ç´„è¨˜äº‹ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\nã€ã‚¹ã‚¿ã‚¤ãƒ«ã€‘\n- ãƒ¢ãƒ€ãƒ³ã§ãƒ•ãƒ©ãƒƒãƒˆãªã‚¤ãƒ©ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«\n- è¦ªã—ã¿ã‚„ã™ãã€æ˜ã‚‹ã„é›°å›²æ°—\n- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ: ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆ#f97316ï¼‰ã€ãƒ™ãƒ¼ã‚¸ãƒ¥ï¼ˆ#fef3e2ï¼‰ã€ãƒ–ãƒ«ãƒ¼ã€ã‚°ãƒªãƒ¼ãƒ³ã‚’åŸºèª¿\n- æ¨ªé•·ï¼ˆ16:9ï¼‰\n\nã€å«ã‚ã‚‹è¦ç´ ã€‘\n- ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã€ã‚³ã‚¤ãƒ³ã€çŸ¢å°ã€ã‚¢ã‚¤ã‚³ãƒ³\n- ${level === 'åˆå¿ƒè€…å‘ã‘' ? 'ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ' : 'æ´—ç·´ã•ã‚ŒãŸæ§‹æˆ'}\n\nã€é‡è¦ã€‘\n- ç”»åƒå†…ã«ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸è¦\n- Webã‚µãƒ ãƒã‚¤ãƒ«ã¨ã—ã¦æœ€é©åŒ–\n`.trim();\n\nreturn [{ json: { ...$json, imagePrompt } }];"
      },
      "id": "a7b8c9d0-image-prompt",
      "name": "BuildImagePrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/imagen-3.0-generate-001",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.imagePrompt}}"
            }
          ]
        },
        "options": {
          "aspectRatio": "16:9",
          "outputMimeType": "image/png"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [1780, 300],
      "id": "b8c9d0e1-generate-image",
      "name": "GenerateImage",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "mode": "jsonToBinary",
        "jsonPropertyName": "predictions[0].bytesBase64Encoded",
        "options": {
          "fileName": "={{\"thumbnail-\" + Date.now() + \".png\"}}",
          "mimeType": "image/png"
        }
      },
      "id": "c9d0e1f2-convert-file",
      "name": "ConvertToFile",
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "mode": "binaryToJson",
        "options": {}
      },
      "id": "d0e1f2a3-extract-file",
      "name": "ExtractFromFile",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [2220, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://tokusearch.vercel.app/api/admin/columns/upload-image",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"image\": $json.data,\n  \"filename\": \"col-\" + Date.now() + \".png\"\n} }}",
        "options": {}
      },
      "id": "e1f2a3b4-upload-image",
      "name": "UploadImage",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2440, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "create-new-credential",
          "name": "TokuSearch API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const articleData = $items('ParseArticleJSON')[0].json;\nconst imageUrl = $json.url;\n\nconst slug = articleData.title\n  .toLowerCase()\n  .replace(/[^\\w\\s-]/g, '')\n  .replace(/\\s+/g, '-')\n  .substring(0, 50);\n\nconst content_html = articleData.content_markdown\n  .replace(/^### (.*$)/gim, '<h3>$1</h3>')\n  .replace(/^## (.*$)/gim, '<h2>$1</h2>')\n  .replace(/^# (.*$)/gim, '<h1>$1</h1>')\n  .replace(/\\*\\*(.*?)\\*\\*/gim, '<strong>$1</strong>')\n  .replace(/\\*(.*?)\\*/gim, '<em>$1</em>')\n  .replace(/\\n\\n/gim, '</p><p>')\n  .replace(/\\n/gim, '<br>');\n\nconst columnData = {\n  slug: slug,\n  title: articleData.title,\n  description: articleData.description,\n  content_markdown: articleData.content_markdown,\n  content_html: '<p>' + content_html + '</p>',\n  category: articleData.category,\n  tags: articleData.tags,\n  thumbnail_url: imageUrl,\n  author: 'TokuSearch AI',\n  status: 'published',\n  is_featured: false,\n  theme: articleData.theme,\n  themeNo: articleData.themeNo\n};\n\nconsole.log('âœ… ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†:', columnData.title);\n\nreturn [{ json: columnData }];"
      },
      "id": "f2a3b4c5-prepare-data",
      "name": "PrepareColumnData",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2660, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://tokusearch.vercel.app/api/admin/columns",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "a3b4c5d6-post-column",
      "name": "PostColumn",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2880, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "create-new-credential",
          "name": "TokuSearch API Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_themes",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "used": "TRUE",
            "used_at": "={{new Date().toISOString()}}"
          }
        },
        "options": {
          "dataLocationOnSheet": "={{ \"A\" + ($json.themeNo + 1) }}"
        }
      },
      "id": "b4c5d6e7-update-theme",
      "name": "UpdateThemeUsed",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [3100, 300],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const columnData = $items('PrepareColumnData')[0].json;\n\nconst message = `ğŸ‰ ã‚³ãƒ©ãƒ è‡ªå‹•ç”Ÿæˆå®Œäº†ï¼\n\nã‚¿ã‚¤ãƒˆãƒ«: ${columnData.title}\nã‚«ãƒ†ã‚´ãƒª: ${columnData.category}\nURL: https://tokusearch.vercel.app/columns/${columnData.slug}`;\n\nconsole.log(message);\n\nreturn [{ json: { message } }];"
      },
      "id": "c5d6e7f8-completion",
      "name": "BuildCompletionMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3320, 300]
    }
  ],
  "connections": {
    "ScheduleTrigger": {
      "main": [[{"node": "GetUnusedThemes", "type": "main", "index": 0}]]
    },
    "GetUnusedThemes": {
      "main": [[{"node": "RandomThemeSelection", "type": "main", "index": 0}]]
    },
    "RandomThemeSelection": {
      "main": [[{"node": "BuildArticlePrompt", "type": "main", "index": 0}]]
    },
    "BuildArticlePrompt": {
      "main": [[{"node": "GenerateArticle", "type": "main", "index": 0}]]
    },
    "GenerateArticle": {
      "main": [[{"node": "ParseArticleJSON", "type": "main", "index": 0}]]
    },
    "ParseArticleJSON": {
      "main": [[{"node": "BuildImagePrompt", "type": "main", "index": 0}]]
    },
    "BuildImagePrompt": {
      "main": [[{"node": "GenerateImage", "type": "main", "index": 0}]]
    },
    "GenerateImage": {
      "main": [[{"node": "ConvertToFile", "type": "main", "index": 0}]]
    },
    "ConvertToFile": {
      "main": [[{"node": "ExtractFromFile", "type": "main", "index": 0}]]
    },
    "ExtractFromFile": {
      "main": [[{"node": "UploadImage", "type": "main", "index": 0}]]
    },
    "UploadImage": {
      "main": [[{"node": "PrepareColumnData", "type": "main", "index": 0}]]
    },
    "PrepareColumnData": {
      "main": [[{"node": "PostColumn", "type": "main", "index": 0}]]
    },
    "PostColumn": {
      "main": [[{"node": "UpdateThemeUsed", "type": "main", "index": 0}]]
    },
    "UpdateThemeUsed": {
      "main": [[{"node": "BuildCompletionMessage", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-11-27T00:00:00.000Z",
  "versionId": "1"
}
