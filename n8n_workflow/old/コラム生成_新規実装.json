{
  "name": "ã‚³ãƒ©ãƒ ç”Ÿæˆï¼ˆSlack + Webé€£æºï¼‰",
  "nodes": [
    {
      "parameters": {
        "content": "## ğŸ“‹ ã‚³ãƒ©ãƒ ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼\n\n**æ¦‚è¦**: Slack ã¾ãŸã¯ Webã‚µã‚¤ãƒˆã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€ãƒ†ãƒ¼ãƒæ¡ˆã‚’ç”Ÿæˆãƒ»æ‰¿èªå¾Œã«è¨˜äº‹ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚\n\n**ãƒˆãƒªã‚¬ãƒ¼**:\n1. SlackTrigger: #column-request ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³\n2. WebhookTrigger: Webã‚µã‚¤ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n**ãƒ•ãƒ­ãƒ¼**:\n```\nãƒ¡ãƒ³ã‚·ãƒ§ãƒ³/Webhook â†’ ãƒ†ãƒ¼ãƒæ¡ˆç”Ÿæˆ â†’ Slackã§æ‰¿èªå¾…ã¡\n        â†“\næ‰¿èª â†’ è¨˜äº‹ç”Ÿæˆ â†’ ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã§é€šçŸ¥\n```\n\n**æ‰¿èªæ–¹å¼**: Slack sendAndWait",
        "height": 400,
        "width": 450,
        "color": 4
      },
      "id": "sticky-overview",
      "name": "ğŸ“‹ æ¦‚è¦",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-200, -400]
    },
    {
      "parameters": {
        "trigger": ["app_mention"],
        "channelId": {
          "__rl": true,
          "value": "C0A0AAKQ7D1",
          "mode": "id",
          "cachedResultName": "column-request"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.slackTrigger",
      "typeVersion": 1,
      "position": [280, -160],
      "id": "slack-trigger-001",
      "name": "SlackTrigger",
      "webhookId": "cac3afd2-2feb-445f-a792-c7c10d26319d",
      "credentials": {
        "slackApi": {
          "id": "kahTvH10blaEP2kb",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// SlackTriggerã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†\nconst message = $json.text || $json.event?.text || '';\nconst userId = $json.user || $json.event?.user || '';\nconst channelId = $json.channel || $json.event?.channel || '';\nconst ts = $json.ts || $json.event?.ts || '';\n\nconsole.log('ğŸ“¥ Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', message);\n\n// ãƒœãƒƒãƒˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’é™¤å»ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º\nlet requestText = message.replace(/<@[A-Z0-9]+>/g, '').trim();\n\nif (!requestText || requestText.length === 0) {\n  throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ãŒç©ºã§ã™ã€‚ãƒ†ãƒ¼ãƒã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');\n}\n\nconsole.log('âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆæŠ½å‡º:', requestText);\n\nreturn [{\n  json: {\n    requestText: requestText,\n    source: 'slack',\n    userId: userId,\n    channelId: channelId,\n    messageTs: ts,\n    parent_thread_ts: ts,\n    originalMessage: message\n  }\n}];"
      },
      "id": "extract-slack-001",
      "name": "ExtractSlackRequest",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [520, -160]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "column-request",
        "options": {}
      },
      "id": "webhook-trigger-001",
      "name": "WebhookTrigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [280, 80],
      "webhookId": "column-request-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Webhookã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º\nconst body = $json.body || $json;\nconst requestText = body.requestText || body.request || '';\n\nconsole.log('ğŸ“¥ Webhookãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡:', requestText);\n\nif (!requestText || requestText.length === 0) {\n  throw new Error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ãŒç©ºã§ã™ã€‚');\n}\n\nconst channelId = 'column-request';\n\nconsole.log('âœ… Webãƒªã‚¯ã‚¨ã‚¹ãƒˆæŠ½å‡º:', requestText);\n\nreturn [{\n  json: {\n    requestText: requestText,\n    source: 'web',\n    userId: 'web-user',\n    channelId: channelId,\n    messageTs: '',\n    parent_thread_ts: '',\n    originalMessage: requestText\n  }\n}];"
      },
      "id": "extract-webhook-001",
      "name": "ExtractWebhookRequest",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [520, 80]
    },
    {
      "parameters": {},
      "id": "merge-requests-001",
      "name": "MergeRequests",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [760, -40]
    },
    {
      "parameters": {
        "jsCode": "const requestText = $json.requestText;\nconst source = $json.source;\n\nconst prompt = `ã‚ãªãŸã¯ãƒã‚¤æ´»ãƒ»ç¯€ç´„ãƒ¡ãƒ‡ã‚£ã‚¢ã€ŒTokuSearchã€ã®ç·¨é›†è€…ã§ã™ã€‚\n\nä»¥ä¸‹ã®ã–ã£ãã‚Šã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã€å…·ä½“çš„ãªã‚³ãƒ©ãƒ è¨˜äº‹ã®ãƒ†ãƒ¼ãƒæ¡ˆã‚’1ã€œ3ä»¶ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n## ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹\n${requestText}\n\n## å‡ºåŠ›å½¢å¼ï¼ˆé‡è¦ï¼‰\nä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚\n\n{\n  \"themes\": [\n    {\n      \"no\": 1,\n      \"title\": \"ãƒ†ãƒ¼ãƒã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30ã€œ50æ–‡å­—ç¨‹åº¦ã€ã‚­ãƒ£ãƒƒãƒãƒ¼ã«ï¼‰\",\n      \"level\": \"åˆå¿ƒè€…å‘ã‘\",\n      \"description\": \"ã“ã®ãƒ†ãƒ¼ãƒã§æ›¸ãè¨˜äº‹ã®æ¦‚è¦ï¼ˆ50ã€œ100æ–‡å­—ï¼‰\"\n    }\n  ]\n}\n\n## ãƒ†ãƒ¼ãƒè¨­è¨ˆãƒ«ãƒ¼ãƒ«\n- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‹ã‚‰1ã€œ3ä»¶ã®ãƒ†ãƒ¼ãƒã‚’æŠ½å‡º\n- 1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¤‡æ•°ã®ãƒˆãƒ”ãƒƒã‚¯ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ã€ãã‚Œãã‚Œåˆ¥ãƒ†ãƒ¼ãƒã¨ã—ã¦ææ¡ˆ\n- ã‚¿ã‚¤ãƒˆãƒ«ã¯èª­è€…ã®èˆˆå‘³ã‚’å¼•ãå…·ä½“çš„ãªè¡¨ç¾ã«\n- ãƒ¬ãƒ™ãƒ«ã¯ã€Œåˆå¿ƒè€…å‘ã‘ã€ã€Œä¸­ç´šè€…ä»¥ä¸Šå‘ã‘ã€ã€Œä¸Šç´šè€…å‘ã‘ã€ã€Œè¶…ãƒã‚¤æ´»ç‰¹åŒ–ã€ã‹ã‚‰é¸æŠ\n\n## å‡ºåŠ›é–‹å§‹\nJSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„:`;\n\nreturn [{ json: { prompt, requestText, source, ...($json) } }];"
      },
      "id": "build-theme-prompt-001",
      "name": "BuildThemePrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, -40]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.prompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [1240, -40],
      "id": "generate-themes-001",
      "name": "GenerateThemes",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Geminiã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ãƒ¼ãƒæ¡ˆã‚’æŠ½å‡º\nconst rawText = $json.content.parts[0].text;\nconsole.log('ğŸ“¥ Geminiå‡ºåŠ›:', rawText.substring(0, 500));\n\n// JSONã‚’æŠ½å‡º\nlet jsonString = rawText.trim();\njsonString = jsonString.replace(/^```(?:json)?\\s*/i, '').replace(/\\s*```$/i, '').trim();\n\nconst jsonStart = jsonString.indexOf('{');\nconst jsonEnd = jsonString.lastIndexOf('}');\n\nif (jsonStart === -1 || jsonEnd === -1) {\n  throw new Error('JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ' + rawText.substring(0, 200));\n}\n\njsonString = jsonString.substring(jsonStart, jsonEnd + 1);\n\nlet themesData;\ntry {\n  themesData = JSON.parse(jsonString);\n} catch (e) {\n  throw new Error('JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—: ' + e.message);\n}\n\nconst themes = themesData.themes || [];\n\nif (themes.length === 0) {\n  throw new Error('ãƒ†ãƒ¼ãƒãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');\n}\n\nconsole.log(`âœ… ãƒ†ãƒ¼ãƒæŠ½å‡ºå®Œäº†: ${themes.length}ä»¶`);\n\n// å‰ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã\nconst prevData = $items('BuildThemePrompt')[0].json;\n\nreturn [{\n  json: {\n    themes: themes,\n    requestText: prevData.requestText,\n    source: prevData.source,\n    userId: prevData.userId,\n    channelId: prevData.channelId,\n    messageTs: prevData.messageTs,\n    parent_thread_ts: prevData.parent_thread_ts\n  }\n}];"
      },
      "id": "parse-themes-001",
      "name": "ParseThemes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1480, -40]
    },
    {
      "parameters": {
        "jsCode": "// Slack Block Kitå½¢å¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ï¼ˆæ‰¿èªãƒ»éæ‰¿èªãƒœã‚¿ãƒ³ä»˜ãï¼‰\nconst themes = $json.themes;\nconst source = $json.source;\nconst requestText = $json.requestText;\nconst requestId = $json.messageTs || `req_${Date.now()}`;\n\n// ãƒ†ãƒ¼ãƒæ¡ˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰\nlet themesText = '';\nif (source === 'web') {\n  themesText += `ğŸŒ *Webã‚µã‚¤ãƒˆã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*\\n`;\n  themesText += `ã€Œ${requestText}ã€\\n\\n`;\n}\n\nthemesText += `ğŸ“ *ãƒ†ãƒ¼ãƒæ¡ˆï¼ˆ${themes.length}ä»¶ï¼‰*\\n\\n`;\n\nthemes.forEach((theme, index) => {\n  themesText += `*${index + 1}. ${theme.title}*\\n`;\n  themesText += `   ãƒ¬ãƒ™ãƒ«: ${theme.level}\\n`;\n  themesText += `   ${theme.description}\\n\\n`;\n});\n\nthemesText += `---\\n`;\nthemesText += `ä¸Šè¨˜ã®ãƒ†ãƒ¼ãƒæ¡ˆã§è¨˜äº‹ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ`;\n\n// Block Kitå½¢å¼ã®JSONã‚’æ§‹ç¯‰\nconst blocks = [\n  {\n    type: 'section',\n    text: {\n      type: 'mrkdwn',\n      text: themesText\n    }\n  },\n  {\n    type: 'actions',\n    elements: [\n      {\n        type: 'button',\n        text: {\n          type: 'plain_text',\n          text: 'âœ… æ‰¿èª'\n        },\n        style: 'primary',\n        value: JSON.stringify({ action: 'approve', requestId: requestId })\n      },\n      {\n        type: 'button',\n        text: {\n          type: 'plain_text',\n          text: 'âŒ éæ‰¿èª'\n        },\n        style: 'danger',\n        value: JSON.stringify({ action: 'reject', requestId: requestId })\n      }\n    ]\n  }\n];\n\nreturn [{\n  json: {\n    slackMessage: themesText,\n    slackBlocks: JSON.stringify(blocks),\n    themes: themes,\n    themesJson: JSON.stringify(themes),\n    requestText: $json.requestText,\n    requestId: requestId,\n    source: $json.source,\n    userId: $json.userId,\n    channelId: $json.channelId,\n    messageTs: $json.messageTs,\n    parent_thread_ts: $json.parent_thread_ts\n  }\n}];"
      },
      "id": "format-message-001",
      "name": "FormatSlackMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1720, -40]
    },
    {
      "parameters": {
        "jsCode": "// Google Sheetsã«ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ï¼ˆæ‰¿èªå¾Œã®ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼‰\nconst data = $items('FormatSlackMessage')[0].json;\nconst now = new Date().toISOString();\n\nconst saveData = {\n  request_id: data.messageTs || `req_${Date.now()}`,\n  source: data.source || 'slack',\n  channel_id: data.channelId || '',\n  thread_ts: data.messageTs || '',\n  original_text: data.requestText || '',\n  themes_json: data.themesJson || '[]',\n  status: 'pending',\n  created_at: now,\n  parent_thread_ts: data.parent_thread_ts || data.messageTs || '',\n  // æ‰¿èªå¾Œã®ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ\n  themes: data.themes || [],\n  themesJson: data.themesJson || '[]',\n  slackMessage: data.slackMessage || 'ãƒ†ãƒ¼ãƒæ¡ˆã®æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™',\n  slackBlocks: data.slackBlocks || '[]',\n  channelId: data.channelId || '',\n  requestText: data.requestText || ''\n};\n\nconsole.log('âœ… SaveRequestç”¨ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†:', JSON.stringify(saveData, null, 2));\n\nreturn [{ json: { ...saveData, ...data } }];"
      },
      "id": "prepare-save-data-001",
      "name": "PrepareSaveData",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1960, -40]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_requests",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": []
        },
        "options": {}
      },
      "id": "save-request-001",
      "name": "SaveRequest",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [2200, -40],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Wait for Approval ã®å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆsendAndWaitã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹ãŸã‚ï¼‰\nconst data = $json;\n\n// æ‰¿èªå¾Œã«ä½¿ç”¨ã™ã‚‹ãŸã‚ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ\nconst preservedData = {\n  themes: data.themes || [],\n  themesJson: data.themesJson || '[]',\n  slackBlocks: data.slackBlocks || '[]',\n  slackMessage: data.slackMessage || 'ãƒ†ãƒ¼ãƒæ¡ˆã®æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™',\n  channelId: data.channelId || '',\n  requestText: data.requestText || '',\n  source: data.source || 'slack',\n  userId: data.userId || '',\n  messageTs: data.messageTs || '',\n  parent_thread_ts: data.parent_thread_ts || '',\n  requestId: data.requestId || ''\n};\n\nconsole.log('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¾ã—ãŸ:', JSON.stringify(preservedData, null, 2));\nconsole.log('ğŸ“ slackMessage:', preservedData.slackMessage);\nconsole.log('ğŸ“¦ slackBlocks:', preservedData.slackBlocks);\n\n// å…ƒã®ãƒ‡ãƒ¼ã‚¿ã¨ä¿æŒãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ã‚’è¿”ã™\nreturn [{ json: { ...data, ...preservedData, preservedData: preservedData } }];"
      },
      "id": "preserve-data-001",
      "name": "PreserveData",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, -40]
    },
    {
      "parameters": {
        "jsCode": "// PostApprovalMessageç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆtextãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«è¨­å®šï¼‰\nconst data = $json;\n\n// slackMessageã‚’ç¢ºå®Ÿã«å–å¾—\nlet slackMessage = data.slackMessage || data.preservedData?.slackMessage || '';\n\n// slackMessageãŒç©ºã®å ´åˆã€ãƒ†ãƒ¼ãƒã‹ã‚‰ç”Ÿæˆ\nif (!slackMessage || slackMessage === '') {\n  const themes = data.themes || (data.themesJson ? JSON.parse(data.themesJson) : []) || [];\n  slackMessage = `ğŸ“ *ãƒ†ãƒ¼ãƒæ¡ˆï¼ˆ${themes.length}ä»¶ï¼‰*\\n\\n`;\n  themes.forEach((theme, index) => {\n    slackMessage += `*${index + 1}. ${theme.title}*\\n`;\n    slackMessage += `   ãƒ¬ãƒ™ãƒ«: ${theme.level}\\n`;\n    slackMessage += `   ${theme.description}\\n\\n`;\n  });\n  slackMessage += `---\\nä¸Šè¨˜ã®ãƒ†ãƒ¼ãƒæ¡ˆã§è¨˜äº‹ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ`;\n}\n\n// slackBlocksã‚’ç¢ºå®Ÿã«å–å¾—\nlet slackBlocks = data.slackBlocks || data.preservedData?.slackBlocks || '[]';\n\n// slackBlocksãŒç©ºã®å ´åˆã€ç”Ÿæˆ\nif (!slackBlocks || slackBlocks === '[]') {\n  const themes = data.themes || (data.themesJson ? JSON.parse(data.themesJson) : []) || [];\n  const requestId = data.requestId || data.messageTs || `req_${Date.now()}`;\n  \n  let themesText = slackMessage;\n  \n  const blocks = [\n    {\n      type: 'section',\n      text: {\n        type: 'mrkdwn',\n        text: themesText\n      }\n    },\n    {\n      type: 'actions',\n      elements: [\n        {\n          type: 'button',\n          text: {\n            type: 'plain_text',\n            text: 'âœ… æ‰¿èª'\n          },\n          style: 'primary',\n          value: JSON.stringify({ action: 'approve', requestId: requestId })\n        },\n        {\n          type: 'button',\n          text: {\n            type: 'plain_text',\n            text: 'âŒ éæ‰¿èª'\n          },\n          style: 'danger',\n          value: JSON.stringify({ action: 'reject', requestId: requestId })\n        }\n      ]\n    }\n  ];\n  \n  slackBlocks = JSON.stringify(blocks);\n}\n\nconsole.log('ğŸ“ slackMessage:', slackMessage);\nconsole.log('ğŸ“¦ slackBlocks:', slackBlocks);\n\nreturn [{\n  json: {\n    ...data,\n    slackMessage: slackMessage,\n    slackBlocks: slackBlocks,\n    text: slackMessage // Slackãƒãƒ¼ãƒ‰ç”¨ã«textã‚‚è¨­å®š\n  }\n}];"
      },
      "id": "prepare-slack-message-001",
      "name": "PrepareSlackMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2440, -40]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "={{ $json.channelId || '#column-request' }}",
          "mode": "id"
        },
        "message": "={{ $json.text || $json.slackMessage || 'ãƒ†ãƒ¼ãƒæ¡ˆã®æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™' }}",
        "operation": "sendAndWait",
        "options": {
          "limitWaitTime": {
            "values": {
              "resumeUnit": "days"
            }
          }
        },
        "authentication": "oAuth2"
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [2680, -40],
      "id": "post-approval-message-001",
      "name": "Wait for Approval",
      "credentials": {}
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-approved",
              "leftValue": "={{ $json.data.approved }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-approved-001",
      "name": "If Approved?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [3400, -40]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-approved",
              "leftValue": "={{ $json.data.approved }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-approved-001",
      "name": "If Approved?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [2680, -40]
    },
    {
      "parameters": {
        "jsCode": "// æ‰¿èªã•ã‚ŒãŸå ´åˆã€ä¿æŒã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’å–å¾—\nconst approvalData = $json;\n\n// PreserveDataãƒãƒ¼ãƒ‰ã§ä¿æŒã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—\nconst preservedData = $items('PreserveData')[0]?.json?.preservedData || $items('PreserveData')[0]?.json;\n\nif (!preservedData) {\n  console.log('ğŸ“¥ æ‰¿èªãƒ‡ãƒ¼ã‚¿å…¨ä½“:', JSON.stringify(approvalData, null, 2));\n  console.log('ğŸ“¥ PreserveDataãƒãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿:', JSON.stringify($items('PreserveData')[0]?.json, null, 2));\n  throw new Error('ä¿æŒã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');\n}\n\n// ãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—\nlet themes = [];\nif (preservedData.themes && Array.isArray(preservedData.themes)) {\n  themes = preservedData.themes;\n} else if (preservedData.themesJson) {\n  try {\n    themes = JSON.parse(preservedData.themesJson);\n  } catch (e) {\n    console.log('themesJsonè§£æã‚¨ãƒ©ãƒ¼:', e.message);\n  }\n}\n\nif (themes.length === 0) {\n  throw new Error('ãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚preservedData: ' + JSON.stringify(preservedData));\n}\n\nconst channelId = preservedData.channelId || '';\nconst threadTs = preservedData.parent_thread_ts || '';\n\nconsole.log('âœ… æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚ãƒ†ãƒ¼ãƒæ•°:', themes.length);\nconsole.log('ğŸ“Š ãƒ†ãƒ¼ãƒãƒ‡ãƒ¼ã‚¿:', JSON.stringify(themes, null, 2));\n\nreturn [{\n  json: {\n    themes: themes,\n    selectedThemes: themes,\n    channelId: channelId,\n    threadTs: threadTs,\n    requestData: preservedData\n  }\n}];"
      },
      "id": "prepare-article-generation-001",
      "name": "PrepareArticleGeneration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3400, -40]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "={{ $json.channelId }}",
          "mode": "id"
        },
        "text": "âœ… *{{ $json.selectedThemes.length }}ä»¶ã®è¨˜äº‹ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™...*",
        "otherOptions": {
          "includeLinkToWorkflow": false,
          "mrkdwn": true,
          "thread_ts": "={{ $json.threadTs }}"
        }
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [3160, -40],
      "id": "notify-start-001",
      "name": "NotifyStart",
      "credentials": {
        "slackApi": {
          "id": "kahTvH10blaEP2kb",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ‰¿èªã•ã‚ŒãŸãƒ†ãƒ¼ãƒã‚’å€‹åˆ¥ã«å‡ºåŠ›ï¼ˆãƒ«ãƒ¼ãƒ—ç”¨ï¼‰\nconst data = $json;\nconst themes = data.selectedThemes || [];\n\nif (themes.length === 0) {\n  throw new Error('æ‰¿èªã•ã‚ŒãŸãƒ†ãƒ¼ãƒãŒã‚ã‚Šã¾ã›ã‚“');\n}\n\nreturn themes.map((theme, index) => ({\n  json: {\n    theme: theme,\n    themeIndex: index,\n    totalThemes: themes.length,\n    channelId: data.channelId,\n    threadTs: data.threadTs,\n    requestData: data.requestData\n  }\n}));"
      },
      "id": "split-themes-001",
      "name": "SplitThemes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3400, -40]
    },
    {
      "parameters": {
        "jsCode": "const theme = $json.theme;\n\nconst prompt = `\nã‚ãªãŸã¯JSONç”Ÿæˆã®å°‚é–€å®¶ã§ã™ã€‚æœ‰åŠ¹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\n## è¨˜äº‹æƒ…å ±\n- ã‚¿ã‚¤ãƒˆãƒ«: ${theme.title}\n- ãƒ¬ãƒ™ãƒ«: ${theme.level}\n- æ¦‚è¦: ${theme.description || ''}\n\n## é‡è¦ãªãƒ«ãƒ¼ãƒ«\n1. JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’å‡ºåŠ›ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã€èª¬æ˜æ–‡ã¯ä¸è¦ï¼‰\n2. { ã§å§‹ã¾ã‚Š } ã§çµ‚ã‚ã‚‹ã“ã¨\n3. content_markdownå†…ã®æ”¹è¡Œã¯ \\\\n ã‚’ä½¿ç”¨\n4. ç‰¹æ®Šæ–‡å­—ï¼ˆå¼•ç”¨ç¬¦ã€ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ã¯é©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—\n5. content_markdownã¯2500ã€œ3500æ–‡å­—ç¨‹åº¦\n6. é‡è¦ãªæƒ…å ±ã«ã¯ <mark>ãƒ†ã‚­ã‚¹ãƒˆ</mark> ã‚’ä½¿ç”¨\n7. å¼·èª¿ã«ã¯ **å¤ªå­—** ã‚’ä½¿ç”¨\n\n## å‡ºåŠ›ã™ã‚‹JSONã®æ§‹é€ \n{\n  \"title\": \"${theme.title}\",\n  \"description\": \"è¨˜äº‹ã®è¦ç´„ï¼ˆ80ã€œ120æ–‡å­—ï¼‰\",\n  \"content_markdown\": \"è¨˜äº‹æœ¬æ–‡ï¼ˆMarkdownå½¢å¼ï¼‰\",\n  \"category\": \"ä»¥ä¸‹ã‹ã‚‰1ã¤é¸æŠ: ãƒã‚¤ãƒ³ãƒˆæ´»ç”¨, ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰, ç¯€ç´„è¡“, æ—…è¡Œ, ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹, å®¶è¨ˆç®¡ç†, ãµã‚‹ã•ã¨ç´ç¨\",\n  \"tags\": \"ã‚¿ã‚°1,ã‚¿ã‚°2,ã‚¿ã‚°3\"\n}\n\n## è¨˜äº‹ã®æ§‹æˆ\n1. **å°å…¥**ï¼ˆèª­è€…ã®æ‚©ã¿ã¨è§£æ±ºç­–ã®æç¤ºï¼‰\n2. **åŸºæœ¬ã®è€ƒãˆæ–¹**ï¼ˆã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼‰\n3. **å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—**ï¼ˆå®Ÿè·µæ–¹æ³•ï¼‰\n4. **æ³¨æ„ç‚¹ãƒ»ã‚ˆãã‚ã‚‹å¤±æ•—**\n5. **ã¾ã¨ã‚**\n\n## å‡ºåŠ›é–‹å§‹\nJSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„:\n`.trim();\n\nreturn [{ json: { prompt, theme, ...$json } }];"
      },
      "id": "build-article-prompt-001",
      "name": "BuildArticlePrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3640, -40]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list"
        },
        "messages": {
          "values": [
            {
              "content": "={{$json.prompt}}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [3880, -40],
      "id": "generate-article-001",
      "name": "GenerateArticle",
      "credentials": {
        "googlePalmApi": {
          "id": "gojn353h4HLDUzF2",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rawText = $json.content.parts[0].text;\nconsole.log('ğŸ“¥ LLMå‡ºåŠ›ï¼ˆå…ˆé ­500æ–‡å­—ï¼‰:', rawText.substring(0, 500));\n\nlet jsonString = rawText.trim();\njsonString = jsonString.replace(/^```(?:json)?\\s*/i, '').replace(/\\s*```$/i, '').trim();\n\nconst jsonStart = jsonString.indexOf('{');\nconst jsonEnd = jsonString.lastIndexOf('}');\n\nif (jsonStart === -1 || jsonEnd === -1 || jsonEnd <= jsonStart) {\n  throw new Error('JSONã® { } ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');\n}\n\njsonString = jsonString.substring(jsonStart, jsonEnd + 1);\n\nlet article;\ntry {\n  const cleaned = jsonString.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F]/g, '');\n  article = JSON.parse(cleaned);\n} catch (e) {\n  throw new Error('JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—: ' + e.message);\n}\n\nconst prevData = $items('BuildArticlePrompt')[0].json;\nconst theme = prevData.theme;\n\nconst result = {\n  ...article,\n  title: theme.title,\n  theme: theme,\n  channelId: prevData.channelId,\n  threadTs: prevData.threadTs,\n  themeIndex: prevData.themeIndex,\n  totalThemes: prevData.totalThemes,\n  requestData: prevData.requestData\n};\n\nconsole.log('âœ… è¨˜äº‹ãƒ‘ãƒ¼ã‚¹å®Œäº†:', result.title);\n\nreturn [{ json: result }];"
      },
      "id": "parse-article-001",
      "name": "ParseArticleJSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4120, -40]
    },
    {
      "parameters": {
        "jsCode": "const articleData = $json;\n\nconst slug = articleData.title\n  .toLowerCase()\n  .replace(/[^a-z0-9\\u3040-\\u309f\\u30a0-\\u30ff\\u4e00-\\u9faf]+/g, '-')\n  .replace(/^-+|-+$/g, '');\n\nconst content_html = articleData.content_markdown\n  .replace(/^### (.*$)/gim, '<h3>$1</h3>')\n  .replace(/^## (.*$)/gim, '<h2>$1</h2>')\n  .replace(/^# (.*$)/gim, '<h1>$1</h1>')\n  .replace(/\\*\\*(.*?)\\*\\*/gim, '<strong>$1</strong>')\n  .replace(/\\*(.*?)\\*/gim, '<em>$1</em>')\n  .replace(/\\n\\n/gim, '</p><p>')\n  .replace(/\\n/gim, '<br>');\n\nconst columnData = {\n  slug: slug,\n  title: articleData.title,\n  description: articleData.description,\n  content_markdown: articleData.content_markdown,\n  content_html: '<p>' + content_html + '</p>',\n  category: articleData.category,\n  tags: articleData.tags,\n  thumbnail_url: '',\n  author: 'TokuSearch AI',\n  status: 'published',\n  is_featured: false,\n  channelId: articleData.channelId,\n  threadTs: articleData.threadTs,\n  themeIndex: articleData.themeIndex,\n  totalThemes: articleData.totalThemes,\n  requestData: articleData.requestData\n};\n\nconsole.log('âœ… ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†:', columnData.title);\n\nreturn [{ json: columnData }];"
      },
      "id": "prepare-data-001",
      "name": "PrepareColumnData",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4360, -40]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://tokusearch.vercel.app/api/admin/columns",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { slug: $json.slug, title: $json.title, description: $json.description, content_markdown: $json.content_markdown, content_html: $json.content_html, category: $json.category, tags: $json.tags, thumbnail_url: $json.thumbnail_url, author: $json.author, status: $json.status, is_featured: $json.is_featured } }}",
        "options": {}
      },
      "id": "post-column-001",
      "name": "PostColumn",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4600, -40],
      "credentials": {
        "httpHeaderAuth": {
          "id": "RT6aq4TB1Vj8V2Tn",
          "name": "Credential Name"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const apiResponse = $json;\nconst prevData = $items('PrepareColumnData')[0].json;\n\nconst url = `https://tokusearch.vercel.app/columns/${prevData.slug}`;\n\nreturn [{\n  json: {\n    title: prevData.title,\n    url: url,\n    slug: prevData.slug,\n    channelId: prevData.channelId,\n    threadTs: prevData.threadTs,\n    themeIndex: prevData.themeIndex,\n    totalThemes: prevData.totalThemes,\n    requestData: prevData.requestData\n  }\n}];"
      },
      "id": "build-result-001",
      "name": "BuildResult",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4840, -40]
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(item => item.json);\n\nlet message = `ğŸ‰ *è¨˜äº‹ç”Ÿæˆå®Œäº†ï¼*\\n\\n`;\n\nresults.forEach((result, index) => {\n  message += `${index + 1}. *${result.title}*\\n`;\n  message += `   ${result.url}\\n\\n`;\n});\n\nconst firstResult = results[0];\n\nreturn [{\n  json: {\n    text: message,\n    channelId: firstResult.channelId,\n    threadTs: firstResult.threadTs,\n    requestData: firstResult.requestData\n  }\n}];"
      },
      "id": "aggregate-results-001",
      "name": "AggregateResults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5080, -40]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "={{ $json.channelId }}",
          "mode": "id"
        },
        "text": "={{ $json.text }}",
        "otherOptions": {
          "includeLinkToWorkflow": false,
          "mrkdwn": true,
          "thread_ts": "={{ $json.threadTs }}"
        }
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [5320, -40],
      "id": "notify-complete-001",
      "name": "NotifyComplete",
      "credentials": {
        "slackApi": {
          "id": "kahTvH10blaEP2kb",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1iz1ApPwoLMMyqeQW_GA0XYM1qU74tzULNVq6vav3g14",
          "mode": "list",
          "cachedResultName": "TokuSearch"
        },
        "sheetName": {
          "__rl": true,
          "value": "column_requests",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "parent_thread_ts": "={{ $items('FormatSlackMessage')[0].json.parent_thread_ts }}",
            "status": "completed"
          },
          "matchingColumns": ["parent_thread_ts"]
        },
        "options": {}
      },
      "id": "update-status-001",
      "name": "UpdateStatus",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [5560, -40],
      "credentials": {
        "googleApi": {
          "id": "r9kAyVencycJeNjy",
          "name": "Google Service Account account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// éæ‰¿èªæ™‚ã®å‡¦ç†ï¼šåˆ¥ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆ\nconst approvalData = $json;\nconst saveData = $items('SaveRequest')[0]?.json;\n\nif (!saveData) {\n  throw new Error('SaveRequestã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');\n}\n\n// å†è©¦è¡Œå›æ•°ã‚’ç¢ºèªï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰\nconst retryCount = saveData.retryCount || 0;\nconst maxRetries = 2; // æœ€å¤§2å›ã¾ã§å†è©¦è¡Œ\n\nif (retryCount >= maxRetries) {\n  return [{\n    json: {\n      message: 'âŒ *æ‰¿èªãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ*\\næœ€å¤§å†è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸã€‚åˆ¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚',\n      channelId: saveData.channelId || saveData.channel_id || '',\n      threadTs: saveData.parent_thread_ts || saveData.thread_ts || '',\n      shouldStop: true\n    }\n  }];\n}\n\n// å…ƒã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—\nconst originalRequest = saveData.requestText || saveData.original_text || '';\n\nif (!originalRequest) {\n  return [{\n    json: {\n      message: 'âŒ *æ‰¿èªãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ*',\n      channelId: saveData.channelId || saveData.channel_id || '',\n      threadTs: saveData.parent_thread_ts || saveData.thread_ts || '',\n      shouldStop: true\n    }\n  }];\n}\n\n// åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ãƒ†ãƒ¼ãƒã‚’å†ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™\nreturn [{\n  json: {\n    requestText: originalRequest,\n    source: saveData.source || 'slack',\n    userId: saveData.userId || '',\n    channelId: saveData.channelId || saveData.channel_id || '',\n    messageTs: saveData.messageTs || '',\n    parent_thread_ts: saveData.parent_thread_ts || saveData.thread_ts || '',\n    retryCount: retryCount + 1,\n    isRetry: true,\n    shouldStop: false\n  }\n}];"
      },
      "id": "handle-rejection-001",
      "name": "HandleRejection",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2920, 80]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-should-stop",
              "leftValue": "={{ $json.shouldStop }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-should-stop-001",
      "name": "ShouldStop?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [3160, 80]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "={{ $json.channelId }}",
          "mode": "id"
        },
        "text": "={{ $json.message }}",
        "otherOptions": {
          "includeLinkToWorkflow": false,
          "mrkdwn": true,
          "thread_ts": "={{ $json.threadTs }}"
        }
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [3400, 80],
      "id": "notify-rejected-001",
      "name": "NotifyRejected",
      "credentials": {
        "slackApi": {
          "id": "kahTvH10blaEP2kb",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// å†è©¦è¡Œæ™‚ï¼šåˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ãƒ†ãƒ¼ãƒã‚’ç”Ÿæˆ\nconst data = $json;\n\n// å†è©¦è¡Œå›æ•°ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¤‰æ›´\nconst retryCount = data.retryCount || 0;\nlet approach = '';\n\nif (retryCount === 1) {\n  approach = '\\n\\n## é‡è¦ï¼šå‰å›ã®ãƒ†ãƒ¼ãƒæ¡ˆãŒæ‰¿èªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\\nä»¥ä¸‹ã®ç‚¹ã‚’è€ƒæ…®ã—ã¦ã€**ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**ã§ãƒ†ãƒ¼ãƒã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š\\n- ã‚ˆã‚Šå…·ä½“çš„ã§å®Ÿè·µçš„ãªå†…å®¹ã«ã™ã‚‹\\n- èª­è€…ã®èˆˆå‘³ã‚’å¼•ãåˆ¥ã®è§’åº¦ã‹ã‚‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã™ã‚‹\\n- ã‚ˆã‚Šåˆå¿ƒè€…å‘ã‘ã®å†…å®¹ã«ã™ã‚‹';\n} else if (retryCount === 2) {\n  approach = '\\n\\n## é‡è¦ï¼š2å›ç›®ã®ãƒ†ãƒ¼ãƒæ¡ˆã‚‚æ‰¿èªã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\\nä»¥ä¸‹ã®ç‚¹ã‚’è€ƒæ…®ã—ã¦ã€**å…¨ãç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**ã§ãƒ†ãƒ¼ãƒã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š\\n- ã‚ˆã‚Šå®Ÿç”¨çš„ã§å³åŠ¹æ€§ã®ã‚ã‚‹å†…å®¹ã«ã™ã‚‹\\n- èª­è€…ãŒã™ãã«è¡Œå‹•ã§ãã‚‹å…·ä½“çš„ãªæ–¹æ³•ã‚’ææ¡ˆã™ã‚‹\\n- ã‚ˆã‚Šå°‚é–€çš„ã§æ·±ã„å†…å®¹ã«ã™ã‚‹';\n}\n\nconst prompt = `ã‚ãªãŸã¯ãƒã‚¤æ´»ãƒ»ç¯€ç´„ãƒ¡ãƒ‡ã‚£ã‚¢ã€ŒTokuSearchã€ã®ç·¨é›†è€…ã§ã™ã€‚\n\nä»¥ä¸‹ã®ã–ã£ãã‚Šã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ã€å…·ä½“çš„ãªã‚³ãƒ©ãƒ è¨˜äº‹ã®ãƒ†ãƒ¼ãƒæ¡ˆã‚’1ã€œ3ä»¶ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚${approach}\n\n## ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹\n${data.requestText}\n\n## å‡ºåŠ›å½¢å¼ï¼ˆé‡è¦ï¼‰\nä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚\n\n{\n  \"themes\": [\n    {\n      \"no\": 1,\n      \"title\": \"ãƒ†ãƒ¼ãƒã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30ã€œ50æ–‡å­—ç¨‹åº¦ã€ã‚­ãƒ£ãƒƒãƒãƒ¼ã«ï¼‰\",\n      \"level\": \"åˆå¿ƒè€…å‘ã‘\",\n      \"description\": \"ã“ã®ãƒ†ãƒ¼ãƒã§æ›¸ãè¨˜äº‹ã®æ¦‚è¦ï¼ˆ50ã€œ100æ–‡å­—ï¼‰\"\n    }\n  ]\n}\n\n## ãƒ†ãƒ¼ãƒè¨­è¨ˆãƒ«ãƒ¼ãƒ«\n- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‹ã‚‰1ã€œ3ä»¶ã®ãƒ†ãƒ¼ãƒã‚’æŠ½å‡º\n- 1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¤‡æ•°ã®ãƒˆãƒ”ãƒƒã‚¯ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ã€ãã‚Œãã‚Œåˆ¥ãƒ†ãƒ¼ãƒã¨ã—ã¦ææ¡ˆ\n- ã‚¿ã‚¤ãƒˆãƒ«ã¯èª­è€…ã®èˆˆå‘³ã‚’å¼•ãå…·ä½“çš„ãªè¡¨ç¾ã«\n- ãƒ¬ãƒ™ãƒ«ã¯ã€Œåˆå¿ƒè€…å‘ã‘ã€ã€Œä¸­ç´šè€…ä»¥ä¸Šå‘ã‘ã€ã€Œä¸Šç´šè€…å‘ã‘ã€ã€Œè¶…ãƒã‚¤æ´»ç‰¹åŒ–ã€ã‹ã‚‰é¸æŠ\n\n## å‡ºåŠ›é–‹å§‹\nJSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„:`;\n\nreturn [{ json: { prompt, ...data } }];"
      },
      "id": "build-retry-prompt-001",
      "name": "BuildRetryPrompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3400, 160]
    },
    {
      "parameters": {},
      "id": "error-trigger-001",
      "name": "ErrorTrigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [280, 320]
    },
    {
      "parameters": {
        "jsCode": "const execution = $json.execution || {};\nconst workflow = $json.workflow || {};\n\nconst nodeName = execution.lastNodeExecuted || 'Unknown';\nconst errorData = execution.error || {};\nconst errorMessage = errorData.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';\n\nconst message = `âŒ *ã‚³ãƒ©ãƒ ç”Ÿæˆã‚¨ãƒ©ãƒ¼*\\n\\nãƒãƒ¼ãƒ‰: ${nodeName}\\nã‚¨ãƒ©ãƒ¼: ${errorMessage}\\næ™‚åˆ»: ${new Date().toISOString()}`;\n\nreturn [{ json: { text: message } }];"
      },
      "id": "build-error-001",
      "name": "BuildErrorMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [520, 320]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "#column-request",
          "mode": "name"
        },
        "text": "={{ $json.text }}",
        "otherOptions": {
          "includeLinkToWorkflow": true,
          "mrkdwn": true
        }
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [760, 320],
      "id": "notify-error-001",
      "name": "NotifyError",
      "credentials": {
        "slackApi": {
          "id": "kahTvH10blaEP2kb",
          "name": "Slack account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "SlackTrigger": {
      "main": [
        [
          {
            "node": "ExtractSlackRequest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ExtractSlackRequest": {
      "main": [
        [
          {
            "node": "MergeRequests",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WebhookTrigger": {
      "main": [
        [
          {
            "node": "ExtractWebhookRequest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ExtractWebhookRequest": {
      "main": [
        [
          {
            "node": "MergeRequests",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "MergeRequests": {
      "main": [
        [
          {
            "node": "BuildThemePrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildThemePrompt": {
      "main": [
        [
          {
            "node": "GenerateThemes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GenerateThemes": {
      "main": [
        [
          {
            "node": "ParseThemes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ParseThemes": {
      "main": [
        [
          {
            "node": "FormatSlackMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FormatSlackMessage": {
      "main": [
        [
          {
            "node": "PrepareSaveData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PrepareSaveData": {
      "main": [
        [
          {
            "node": "SaveRequest",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SaveRequest": {
      "main": [
        [
          {
            "node": "PreserveData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PreserveData": {
      "main": [
        [
          {
            "node": "PrepareSlackMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PrepareSlackMessage": {
      "main": [
        [
          {
            "node": "Wait for Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Approval": {
      "main": [
        [
          {
            "node": "If Approved?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Approved?": {
      "main": [
        [
          {
            "node": "PrepareArticleGeneration",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HandleRejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HandleRejection": {
      "main": [
        [
          {
            "node": "ShouldStop?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ShouldStop?": {
      "main": [
        [
          {
            "node": "NotifyRejected",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "BuildRetryPrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildRetryPrompt": {
      "main": [
        [
          {
            "node": "GenerateThemes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PrepareArticleGeneration": {
      "main": [
        [
          {
            "node": "NotifyStart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NotifyStart": {
      "main": [
        [
          {
            "node": "SplitThemes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SplitThemes": {
      "main": [
        [
          {
            "node": "BuildArticlePrompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildArticlePrompt": {
      "main": [
        [
          {
            "node": "GenerateArticle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GenerateArticle": {
      "main": [
        [
          {
            "node": "ParseArticleJSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ParseArticleJSON": {
      "main": [
        [
          {
            "node": "PrepareColumnData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PrepareColumnData": {
      "main": [
        [
          {
            "node": "PostColumn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostColumn": {
      "main": [
        [
          {
            "node": "BuildResult",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildResult": {
      "main": [
        [
          {
            "node": "AggregateResults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AggregateResults": {
      "main": [
        [
          {
            "node": "NotifyComplete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NotifyComplete": {
      "main": [
        [
          {
            "node": "UpdateStatus",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ErrorTrigger": {
      "main": [
        [
          {
            "node": "BuildErrorMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildErrorMessage": {
      "main": [
        [
          {
            "node": "NotifyError",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "column-generation-v2.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fefffd21e64fa94994bb4bf38b5a050c59f6cf28bd3cad9da0a5804220d9e97f"
  },
  "id": "column-generation-slack-web"
}

